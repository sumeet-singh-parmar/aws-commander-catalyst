
// ============================================================================
// AWS Cloud Commander - Button Click Handler
// ============================================================================
// Purpose: Processes all button clicks from interactive Cliq cards
//
// This handler is triggered when users click buttons in:
//   - Dashboard cards (EC2, S3, Lambda, etc.)
//   - List views (pagination, actions, refresh)
//   - Action buttons (start/stop instances, create buckets, etc.)
//   - Navigation buttons (help, settings, dashboard)
//   - Form submission buttons
//
// Button Key Format:
//   - Simple: "ec2_refresh", "s3_create", "dashboard"
//   - With params: "ec2_start_i-12345", "s3_browse_my-bucket"
//   - With pagination: "ec2_refresh|page|2"
//
// Flow:
//   1. Extracts button key/ID from click event
//   2. Parses action type and parameters
//   3. Fetches user's backend URL (if Option 3)
//   4. Routes to appropriate handler based on action
//   5. Returns updated card with new data or navigation
//
// Key Features:
//   - Handles 100+ different button actions
//   - Supports pagination for all list operations
//   - Integrates with dynamic notification system
//   - Manages consent flows for paid APIs
// ============================================================================

DEFAULT_API_URL = "https://aws-cloudops-906900311.development.catalystserverless.com/server/aws_handler/";

// SECTION: Extract button information from click event
// Button key can come from 'key' field (regular buttons) or 'id' field (button references)
info "handleButton arguments: " + arguments;
buttonKey = ifnull(arguments.get("key"),"");
if(buttonKey == "")
{
	buttonKey = ifnull(arguments.get("id"),"");
}
info "handleButton buttonKey: " + buttonKey;
buttonData = ifnull(arguments.get("data"),Map());

// SECTION: Get user information safely
userId = "";
userName = "Unknown";
if(user != null)
{
	userId = ifnull(user.get("id"),"");
	userName = ifnull(user.get("first_name"),ifnull(user.get("name"),"Unknown"));
}

// SECTION: Fetch user's custom backend URL (for Option 3: Own Backend setup)
// Users with self-hosted Catalyst instances can use their own backend URL
API_URL = DEFAULT_API_URL;
if(userId != "")
{
	setupQuery = Map();
	setupQuery.put("criteria","userid==" + userId);
	setupRecords = zoho.cliq.getRecords("awssetup",setupQuery);
	if(setupRecords != null && setupRecords.get("status") == "SUCCESS")
	{
		setupList = setupRecords.get("list");
		if(setupList != null && setupList.size() > 0)
		{
			setupRecord = setupList.get(0);
			customBackendUrl = ifnull(setupRecord.get("backendurl"),"");
			if(customBackendUrl != null && customBackendUrl != "")
			{
				API_URL = customBackendUrl;
			}
		}
	}
}

// SECTION: Fetch user's region preference (default: ap-south-1)
userRegion = "ap-south-1";
if(userId != "")
{
	prefsQuery = Map();
	prefsQuery.put("criteria","userid==" + userId);
	prefsRecords = zoho.cliq.getRecords("awsprefs",prefsQuery);
	if(prefsRecords != null && prefsRecords.get("status") == "SUCCESS")
	{
		prefsList = prefsRecords.get("list");
		if(prefsList != null && prefsList.size() > 0)
		{
			prefs = prefsList.get(0);
			if(prefs != null)
			{
				userRegion = ifnull(prefs.get("region"),"ap-south-1");
			}
		}
	}
}

// Parse pagination from button key FIRST (before splitting on _)
// Check if button key contains "|page|" separator
originalButtonKey = buttonKey;
pageIndex = buttonKey.indexOf("|page|");
if(pageIndex != -1)
{
	// Extract page number and reconstruct base key for parsing
	pageStr = buttonKey.subString(pageIndex + "|page|".length());
	buttonKey = buttonKey.subString(0, pageIndex);
}
// Parse the key - safely handle keys with varying number of parts
keyParts = buttonKey.toList("_");
keyPartsSize = keyParts.size();
actionType = "";
if(keyPartsSize > 0)
{
	actionType = keyParts.get(0);
}
actionSubtype = "";
if(keyPartsSize > 1)
{
	actionSubtype = keyParts.get(1);
}
// Helper variables for keys with more parts (e.g., ec2_start_instanceId_instanceName)
// For Lambda functions with underscores in names, join all remaining parts
keyPart2 = "";
if(keyPartsSize > 2)
{
	// Join all parts from index 2 onwards with underscore (for function names with underscores)
	remainingParts = List();
	for each  idx in {2,3,4,5,6,7,8,9}
	{
		if(idx < keyPartsSize)
		{
			remainingParts.add(keyParts.get(idx));
		}
	}
	keyPart2 = remainingParts.toString("_");
}
keyPart3 = "";
if(keyPartsSize > 3)
{
	keyPart3 = keyParts.get(3);
}
response = Map();

// ============================================================================
// SECTION: EC2 Instance Management Actions
// ============================================================================
// Handles all EC2-related button clicks:
//   - ec2_refresh / ec2_list     ‚Üí List instances with pagination
//   - ec2_start_<instance-id>    ‚Üí Start stopped instance
//   - ec2_stop_<instance-id>     ‚Üí Stop running instance
//   - ec2_reboot_<instance-id>   ‚Üí Reboot instance
//   - ec2_get_<instance-id>      ‚Üí Show instance details
//   - ec2_metrics_<instance-id>  ‚Üí Show CloudWatch metrics
//   - ec2_securityGroups         ‚Üí List security groups
//   - ec2_vpcs                   ‚Üí List VPCs
// ============================================================================
if(actionType == "ec2")
{
	requestBody = Map();
	requestBody.put("service","ec2");
	requestBody.put("userId",userId);
	requestBody.put("userName",userName);
	requestBody.put("region",userRegion);
	// ---------------- EC2 REFRESH ----------------
	// SYNC WITH: ExecutionHandler.ds /aws ec2 command (same card design)
	if(actionSubtype == "refresh" || actionSubtype == "list")
	{
		// Parse pagination from button key (format: ec2_list|page|X or ec2_refresh|page|X)
		pageNum = 1;
		limitNum = 5;
		if(buttonKey.contains("|page|"))
		{
			pageParts = buttonKey.toList("|page|");
			if(pageParts.size() > 1)
			{
				try
				{
					pageNum = pageParts.get(1).toLong();
				}
				catch(e)
				{
					pageNum = 1;
				}
			}
		}
		requestBody.put("action","list");
		requestBody.put("page",pageNum);
		requestBody.put("limit",limitNum);
		apiResponse = invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		];
		if(apiResponse.get("success") == true)
		{
			data = apiResponse.get("data");
			// Extract instances array and pagination metadata
			instances = ifnull(data.get("instances"),data);
			pagination = ifnull(data.get("pagination"),Map());
			currentPage = ifnull(pagination.get("currentPage"),1);
			totalPages = ifnull(pagination.get("totalPages"),1);
			totalItems = ifnull(pagination.get("totalItems"),instances.size());
			hasPrev = ifnull(pagination.get("hasPrev"),false);
			hasNext = ifnull(pagination.get("hasNext"),false);
			
			if(instances.size() == 0)
			{
				return {"text":"üì≠ *No EC2 instances found in this region.*\n\nTry checking a different region in settings.","card":{"title":"üñ•Ô∏è EC2 Instances","theme":"modern-inline"}};
			}
			// Build table rows with INLINE ACTION BUTTONS - SAME as /aws ec2
			rows = List();
			runningCount = 0;
			stoppedCount = 0;
			for each  instance in instances
			{
				state = ifnull(instance.get("state"),"unknown");
				instanceId = ifnull(instance.get("id"),"");
				instanceName = ifnull(instance.get("name"),"Unnamed");
				instanceType = ifnull(instance.get("type"),"");
				// Count states
				if(state == "running")
				{
					runningCount = runningCount + 1;
				}
				else if(state == "stopped")
				{
					stoppedCount = stoppedCount + 1;
				}
				// Build state display with emoji
				stateDisplay = "";
				if(state == "running")
				{
					stateDisplay = "üü¢ Running";
				}
				else if(state == "stopped")
				{
					stateDisplay = "üî¥ Stopped";
				}
				else if(state == "pending")
				{
					stateDisplay = "üü° Pending";
				}
				else if(state == "stopping")
				{
					stateDisplay = "üü† Stopping";
				}
				else
				{
					stateDisplay = "‚ö™ " + state;
				}
				// Build INLINE ACTION BUTTON based on state
				actionButton = "";
				if(state == "running")
				{
					actionButton = "[-‚èπ Stop](invoke.function|handleButton||ec2_stop_" + instanceId + ")";
				}
				else if(state == "stopped")
				{
					actionButton = "[+‚ñ∂Ô∏è Start](invoke.function|handleButton||ec2_start_" + instanceId + ")";
				}
				else if(state == "pending" || state == "stopping")
				{
					actionButton = "[+üîÑ Check](invoke.function|handleButton||ec2_status_" + instanceId + ")";
				}
				else
				{
					actionButton = "‚Äî";
				}
				// Add info button
				infoButton = "[+‚ÑπÔ∏è](invoke.function|handleButton||ec2_info_" + instanceId + ")";
				row = Map();
				instanceDisplay = "*" + instanceName + "*";
				if(instanceType != "")
				{
					instanceDisplay = instanceDisplay + " (" + instanceType + ")";
				}
				row.put("Instance",instanceDisplay);
				row.put("Type",instanceType);
				row.put("State",stateDisplay);
				row.put("Action",actionButton);
				row.put("Info",infoButton);
				rows.add(row);
			}
			// Return SAME format as /aws ec2 with pagination
			pageText = "";
			if(totalPages > 1)
			{
				pageText = " (Page " + currentPage + " of " + totalPages + ")";
			}
			
			// Build buttons with pagination FIRST
			buttons = List();
			baseKey = "ec2_list";
			if(totalPages > 1)
			{
				if(hasPrev)
				{
					buttons.add({"label":"‚¨ÖÔ∏è Previous","hint":"Go to previous page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage - 1)});
				}
				if(hasNext)
				{
					buttons.add({"label":"Next ‚û°Ô∏è","hint":"Go to next page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage + 1)});
				}
			}
			// Add other action buttons after pagination
			buttons.add({"label":"üîÑ Refresh","hint":"Reload instance list","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_refresh"});
			buttons.add({"label":"üîê Security Groups","hint":"View security groups","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_sg"});
			
			return {"text":"*üñ•Ô∏è EC2 Instances* (" + totalItems + " total" + pageText + ")","card":{"theme":"modern-inline"},"slides":{{"type":"label","title":"Instance Summary","data":{{"üü¢ Running":runningCount},{"üî¥ Stopped":stoppedCount},{"üìä Total":totalItems}}},{"type":"table","title":"All Instances","data":{"headers":{"Instance","Type","State","Action","Info"},"rows":rows}}},"buttons":buttons,"navigation":true};
		}
		else
		{
			response.put("text","üñ•Ô∏è *EC2 Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
			response.put("card",{"title":"üñ•Ô∏è EC2 Error","theme":"prompt"});
		}
	}
	// ---------------- EC2 START ----------------
	else if(actionSubtype == "start")
	{
		instanceId = keyPart2;
		if(instanceId != "")
		{
			requestBody.put("action","start");
			requestBody.put("instanceId",instanceId);
			apiResponse = invokeurl
			[
				url :API_URL
				type :POST
				parameters:requestBody.toString()
				headers:{"Content-Type":"application/json"}
				connection:"awscloudcommander"
			];
			if(apiResponse.get("success") == true)
			{
				// Try to get instance name from response
				instanceData = apiResponse.get("data");
				instanceName = "Instance";
				if(instanceData != null)
				{
					instanceName = ifnull(instanceData.get("name"), "Instance");
				}
				// Log to audit
				logEntry = Map();
				logEntry.put("logid","LOG-" + zoho.currenttime.toLong());
				logEntry.put("userid",userId);
				logEntry.put("username",userName);
				logEntry.put("action","ec2:start");
				logEntry.put("resource","ec2:" + instanceId);
				logEntry.put("timestamp",zoho.currenttime.toLong().toString());
				logEntry.put("result","success");
				logEntry.put("details","Started via button click");
				zoho.cliq.createRecord("awsauditlog",logEntry);
				// Send notification using dynamic notification system
				notifMsg = Map();
				notifMsg.put("text","‚ñ∂Ô∏è *EC2 Instance Started*\n\nüë§ *By:* " + userName + "\nüñ•Ô∏è *Instance:* " + instanceName + "\n‚è∞ *Time:* " + zoho.currenttime.toString("dd MMM yyyy HH:mm"));
				notifMsg.put("card",{"theme":"modern-inline"});
				// Get notification channel for EC2
				channelName = "";
				notifQuery = Map();
				notifQuery.put("criteria","userid==" + userId.toString());
				allUserRecords = zoho.cliq.getRecords("awsnotifications",notifQuery);
				if(allUserRecords != null && allUserRecords.get("status") == "SUCCESS")
				{
					notifList = allUserRecords.get("list");
					if(notifList != null && notifList.size() > 0)
					{
						for each  notifRecord in notifList
						{
							if(notifRecord != null && ifnull(notifRecord.get("userid"),"").toString() == userId.toString() && ifnull(notifRecord.get("notificationtype"),"") == "ec2")
							{
								enabledVal = notifRecord.get("enabled");
								if(enabledVal == "TRUE" || enabledVal == true || enabledVal == "true" || enabledVal == 1 || enabledVal == "1")
								{
									channelRaw = ifnull(notifRecord.get("channel"),"");
									if(channelRaw != null && channelRaw != "")
									{
										// Extract channel name (handles object, JSON string, or plain string)
										try
										{
											if(channelRaw.get("unique_name") != null)
											{
												channelName = channelRaw.get("unique_name").toString();
											}
											else if(channelRaw.get("name") != null)
											{
												channelName = channelRaw.get("name").toString();
											}
										}
										catch(e)
										{
											channelName = channelRaw.toString();
										}
										if(channelName == "")
										{
											channelName = channelRaw.toString();
										}
										// Remove # prefix and handle JSON strings
										if(channelName.startsWith("{"))
										{
											if(channelName.contains("\"unique_name\""))
											{
												startIdx = channelName.indexOf("\"unique_name\"");
												valueStart = channelName.indexOf("\"", startIdx + 13) + 1;
												valueEnd = channelName.indexOf("\"", valueStart);
												if(valueStart > 0 && valueEnd > valueStart)
												{
													channelName = channelName.subString(valueStart, valueEnd);
												}
											}
										}
										if(channelName.startsWith("#"))
										{
											channelName = channelName.subString(1);
										}
										break;
									}
								}
							}
						}
					}
				}
				// Fallback to old system
				if(channelName == "")
				{
					scheduleQuery = Map();
					scheduleQuery.put("criteria","userid==" + userId);
					scheduleRecords = zoho.cliq.getRecords("awsschedule",scheduleQuery);
					if(scheduleRecords != null && scheduleRecords.get("status") == "SUCCESS")
					{
						scheduleList = scheduleRecords.get("list");
						if(scheduleList != null && scheduleList.size() > 0)
						{
							schedule = scheduleList.get(0);
							alertsVal = schedule.get("alertsenabled");
							if(alertsVal == "TRUE" || alertsVal == true || alertsVal == "true" || alertsVal == 1 || alertsVal == "1")
							{
								prefsQuery = Map();
								prefsQuery.put("criteria","userid==" + userId);
								prefsRecords = zoho.cliq.getRecords("awsprefs",prefsQuery);
								if(prefsRecords != null && prefsRecords.get("status") == "SUCCESS")
								{
									prefsList = prefsRecords.get("list");
									if(prefsList != null && prefsList.size() > 0)
									{
										channelName = ifnull(prefsList.get(0).get("channel"),"");
										if(channelName.startsWith("#"))
										{
											channelName = channelName.subString(1);
										}
									}
								}
							}
						}
					}
				}
				// Send notification
				if(channelName != "" && channelName != null)
				{
					zoho.cliq.postToChannelAsBot(channelName,"awscloudcommander",notifMsg);
				}
				return {"text":"‚ñ∂Ô∏è *Starting instance: " + instanceName + "*\n\n‚è≥ It may take 1-2 minutes to fully start.","card":{"theme":"modern-inline"},"buttons":{{"label":"Check Status","hint":"View current instance state","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_status_" + instanceId},{"label":"List All","hint":"View all EC2 instances","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_refresh"}},"navigation":true};
			}
			else
			{
				response.put("text","*Failed to start instance:* " + ifnull(apiResponse.get("error"),"Unknown error"));
			}
		}
		else
		{
			response.put("text","*Missing instance ID*");
		}
	}
	// ---------------- EC2 STOP ----------------
	else if(actionSubtype == "stop")
	{
		instanceId = keyPart2;
		if(instanceId != "")
		{
			requestBody.put("action","stop");
			requestBody.put("instanceId",instanceId);
			apiResponse = invokeurl
			[
				url :API_URL
				type :POST
				parameters:requestBody.toString()
				headers:{"Content-Type":"application/json"}
				connection:"awscloudcommander"
			];
			if(apiResponse.get("success") == true)
			{
				// Try to get instance name from response
				instanceData = apiResponse.get("data");
				instanceName = "Instance";
				if(instanceData != null)
				{
					instanceName = ifnull(instanceData.get("name"), "Instance");
				}
				// Log to audit
				logEntry = Map();
				logEntry.put("logid","LOG-" + zoho.currenttime.toLong());
				logEntry.put("userid",userId);
				logEntry.put("username",userName);
				logEntry.put("action","ec2:stop");
				logEntry.put("resource","ec2:" + instanceId);
				logEntry.put("timestamp",zoho.currenttime.toLong().toString());
				logEntry.put("result","success");
				logEntry.put("details","Stopped via button click");
				zoho.cliq.createRecord("awsauditlog",logEntry);
				// Send notification using dynamic notification system
				notifMsg = Map();
				notifMsg.put("text","‚èπÔ∏è *EC2 Instance Stopped*\n\nüë§ *By:* " + userName + "\nüñ•Ô∏è *Instance:* " + instanceName + "\n‚è∞ *Time:* " + zoho.currenttime.toString("dd MMM yyyy HH:mm"));
				notifMsg.put("card",{"theme":"modern-inline"});
				// Get notification channel for EC2
				channelName = "";
				notifQuery = Map();
				notifQuery.put("criteria","userid==" + userId.toString());
				allUserRecords = zoho.cliq.getRecords("awsnotifications",notifQuery);
				if(allUserRecords != null && allUserRecords.get("status") == "SUCCESS")
				{
					notifList = allUserRecords.get("list");
					if(notifList != null && notifList.size() > 0)
					{
						for each  notifRecord in notifList
						{
							if(notifRecord != null && ifnull(notifRecord.get("userid"),"").toString() == userId.toString() && ifnull(notifRecord.get("notificationtype"),"") == "ec2")
							{
								enabledVal = notifRecord.get("enabled");
								if(enabledVal == "TRUE" || enabledVal == true || enabledVal == "true" || enabledVal == 1 || enabledVal == "1")
								{
									channelRaw = ifnull(notifRecord.get("channel"),"");
									if(channelRaw != null && channelRaw != "")
									{
										// Extract channel name (handles object, JSON string, or plain string)
										try
										{
											if(channelRaw.get("unique_name") != null)
											{
												channelName = channelRaw.get("unique_name").toString();
											}
											else if(channelRaw.get("name") != null)
											{
												channelName = channelRaw.get("name").toString();
											}
										}
										catch(e)
										{
											channelName = channelRaw.toString();
										}
										if(channelName == "")
										{
											channelName = channelRaw.toString();
										}
										// Remove # prefix and handle JSON strings
										if(channelName.startsWith("{"))
										{
											if(channelName.contains("\"unique_name\""))
											{
												startIdx = channelName.indexOf("\"unique_name\"");
												valueStart = channelName.indexOf("\"", startIdx + 13) + 1;
												valueEnd = channelName.indexOf("\"", valueStart);
												if(valueStart > 0 && valueEnd > valueStart)
												{
													channelName = channelName.subString(valueStart, valueEnd);
												}
											}
										}
										if(channelName.startsWith("#"))
										{
											channelName = channelName.subString(1);
										}
										break;
									}
								}
							}
						}
					}
				}
				// Fallback to old system
				if(channelName == "")
				{
					scheduleQuery = Map();
					scheduleQuery.put("criteria","userid==" + userId);
					scheduleRecords = zoho.cliq.getRecords("awsschedule",scheduleQuery);
					if(scheduleRecords != null && scheduleRecords.get("status") == "SUCCESS")
					{
						scheduleList = scheduleRecords.get("list");
						if(scheduleList != null && scheduleList.size() > 0)
						{
							schedule = scheduleList.get(0);
							alertsVal = schedule.get("alertsenabled");
							if(alertsVal == "TRUE" || alertsVal == true || alertsVal == "true" || alertsVal == 1 || alertsVal == "1")
							{
								prefsQuery = Map();
								prefsQuery.put("criteria","userid==" + userId);
								prefsRecords = zoho.cliq.getRecords("awsprefs",prefsQuery);
								if(prefsRecords != null && prefsRecords.get("status") == "SUCCESS")
								{
									prefsList = prefsRecords.get("list");
									if(prefsList != null && prefsList.size() > 0)
									{
										channelName = ifnull(prefsList.get(0).get("channel"),"");
										if(channelName.startsWith("#"))
										{
											channelName = channelName.subString(1);
										}
									}
								}
							}
						}
					}
				}
				// Send notification
				if(channelName != "" && channelName != null)
				{
					zoho.cliq.postToChannelAsBot(channelName,"awscloudcommander",notifMsg);
				}
				return {"text":"‚èπÔ∏è *Stopping instance: " + instanceName + "*\n\n‚è≥ Instance will stop in a moment.","card":{"theme":"modern-inline"},"buttons":{{"label":"Check Status","hint":"View current instance state","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_status_" + instanceId},{"label":"List All","hint":"View all EC2 instances","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_refresh"}},"navigation":true};
			}
			else
			{
				response.put("text","*Failed to stop instance:* " + ifnull(apiResponse.get("error"),"Unknown error"));
			}
		}
		else
		{
			response.put("text","*Missing instance ID*");
		}
	}
	// ---------------- EC2 REBOOT ----------------
	else if(actionSubtype == "reboot")
	{
		instanceId = keyPart2;
		if(instanceId != "")
		{
			requestBody.put("action","reboot");
			requestBody.put("instanceId",instanceId);
			apiResponse = invokeurl
			[
				url :API_URL
				type :POST
				parameters:requestBody.toString()
				headers:{"Content-Type":"application/json"}
				connection:"awscloudcommander"
			];
			if(apiResponse.get("success") == true)
			{
				// Try to get instance name from response
				instanceData = apiResponse.get("data");
				instanceName = "Instance";
				if(instanceData != null)
				{
					instanceName = ifnull(instanceData.get("name"), "Instance");
				}
				// Log to audit
				logEntry = Map();
				logEntry.put("logid","LOG-" + zoho.currenttime.toLong());
				logEntry.put("userid",userId);
				logEntry.put("username",userName);
				logEntry.put("action","ec2:reboot");
				logEntry.put("resource","ec2:" + instanceId);
				logEntry.put("timestamp",zoho.currenttime.toLong().toString());
				logEntry.put("result","success");
				logEntry.put("details","Rebooted via button click");
				zoho.cliq.createRecord("awsauditlog",logEntry);
				// Send notification using dynamic notification system
				notifMsg = Map();
				notifMsg.put("text","üîÑ *EC2 Instance Rebooted*\n\nüë§ *By:* " + userName + "\nüñ•Ô∏è *Instance:* " + instanceName + "\n‚è∞ *Time:* " + zoho.currenttime.toString("dd MMM yyyy HH:mm"));
				notifMsg.put("card",{"theme":"modern-inline"});
				// Get notification channel for EC2
				channelName = "";
				notifQuery = Map();
				notifQuery.put("criteria","userid==" + userId.toString());
				allUserRecords = zoho.cliq.getRecords("awsnotifications",notifQuery);
				if(allUserRecords != null && allUserRecords.get("status") == "SUCCESS")
				{
					notifList = allUserRecords.get("list");
					if(notifList != null && notifList.size() > 0)
					{
						for each  notifRecord in notifList
						{
							if(notifRecord != null && ifnull(notifRecord.get("userid"),"").toString() == userId.toString() && ifnull(notifRecord.get("notificationtype"),"") == "ec2")
							{
								enabledVal = notifRecord.get("enabled");
								if(enabledVal == "TRUE" || enabledVal == true || enabledVal == "true" || enabledVal == 1 || enabledVal == "1")
								{
									channelRaw = ifnull(notifRecord.get("channel"),"");
									if(channelRaw != null && channelRaw != "")
									{
										// Extract channel name (handles object, JSON string, or plain string)
										try
										{
											if(channelRaw.get("unique_name") != null)
											{
												channelName = channelRaw.get("unique_name").toString();
											}
											else if(channelRaw.get("name") != null)
											{
												channelName = channelRaw.get("name").toString();
											}
										}
										catch(e)
										{
											channelName = channelRaw.toString();
										}
										if(channelName == "")
										{
											channelName = channelRaw.toString();
										}
										// Remove # prefix and handle JSON strings
										if(channelName.startsWith("{"))
										{
											if(channelName.contains("\"unique_name\""))
											{
												startIdx = channelName.indexOf("\"unique_name\"");
												valueStart = channelName.indexOf("\"", startIdx + 13) + 1;
												valueEnd = channelName.indexOf("\"", valueStart);
												if(valueStart > 0 && valueEnd > valueStart)
												{
													channelName = channelName.subString(valueStart, valueEnd);
												}
											}
										}
										if(channelName.startsWith("#"))
										{
											channelName = channelName.subString(1);
										}
										break;
									}
								}
							}
						}
					}
				}
				// Fallback to old system
				if(channelName == "")
				{
					scheduleQuery = Map();
					scheduleQuery.put("criteria","userid==" + userId);
					scheduleRecords = zoho.cliq.getRecords("awsschedule",scheduleQuery);
					if(scheduleRecords != null && scheduleRecords.get("status") == "SUCCESS")
					{
						scheduleList = scheduleRecords.get("list");
						if(scheduleList != null && scheduleList.size() > 0)
						{
							schedule = scheduleList.get(0);
							alertsVal = schedule.get("alertsenabled");
							if(alertsVal == "TRUE" || alertsVal == true || alertsVal == "true" || alertsVal == 1 || alertsVal == "1")
							{
								prefsQuery = Map();
								prefsQuery.put("criteria","userid==" + userId);
								prefsRecords = zoho.cliq.getRecords("awsprefs",prefsQuery);
								if(prefsRecords != null && prefsRecords.get("status") == "SUCCESS")
								{
									prefsList = prefsRecords.get("list");
									if(prefsList != null && prefsList.size() > 0)
									{
										channelName = ifnull(prefsList.get(0).get("channel"),"");
										if(channelName.startsWith("#"))
										{
											channelName = channelName.subString(1);
										}
									}
								}
							}
						}
					}
				}
				// Send notification
				if(channelName != "" && channelName != null)
				{
					zoho.cliq.postToChannelAsBot(channelName,"awscloudcommander",notifMsg);
				}
				return {"text":"üîÑ *Rebooting instance: " + instanceName + "*\n\n‚è≥ Instance will restart in a moment.","card":{"theme":"modern-inline"},"buttons":{{"label":"Check Status","hint":"View current instance state","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_status_" + instanceId},{"label":"List All","hint":"View all EC2 instances","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_refresh"}},"navigation":true};
			}
			else
			{
				response.put("text","*Failed to reboot instance:* " + ifnull(apiResponse.get("error"),"Unknown error"));
			}
		}
		else
		{
			response.put("text","*Missing instance ID*");
		}
	}
	// ---------------- EC2 STATUS ----------------
	else if(actionSubtype == "status")
	{
		instanceId = keyPart2;
		if(instanceId != "")
		{
			requestBody.put("action","get");
			requestBody.put("instanceId",instanceId);
			apiResponse = invokeurl
			[
				url :API_URL
				type :POST
				parameters:requestBody.toString()
				headers:{"Content-Type":"application/json"}
				connection:"awscloudcommander"
			];
			if(apiResponse.get("success") == true)
			{
				instance = apiResponse.get("data");
				state = ifnull(instance.get("state"),"unknown");
				instanceName = ifnull(instance.get("name"),"Instance");
				stateEmoji = "‚ö™";
				if(state == "running")
				{
					stateEmoji = "üü¢";
				}
				else if(state == "stopped")
				{
					stateEmoji = "üî¥";
				}
				else if(state == "pending")
				{
					stateEmoji = "üü°";
				}
				else if(state == "stopping")
				{
					stateEmoji = "üü†";
				}
				else if(state == "shutting-down")
				{
					stateEmoji = "üü†";
				}
				else if(state == "terminated")
				{
					stateEmoji = "‚ö´";
				}
				// Build action buttons based on state
				actionButtons = List();
				if(state == "running")
				{
					actionButtons.add({"label":"‚èπ Stop","hint":"Stop this instance","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_stop_" + instanceId});
				}
				else if(state == "stopped")
				{
					actionButtons.add({"label":"‚ñ∂Ô∏è Start","hint":"Start this instance","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_start_" + instanceId});
				}
				actionButtons.add({"label":"üîÑ Refresh","hint":"Check status again","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_status_" + instanceId});
				actionButtons.add({"label":"‚ÑπÔ∏è Details","hint":"View full instance details","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_info_" + instanceId});
				actionButtons.add({"label":"üìã List All","hint":"View all EC2 instances","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_refresh"});
				return {"text":"*Instance Status: " + instanceName + "*\n\n" + stateEmoji + " *" + state + "*","card":{"theme":"modern-inline"},"buttons":actionButtons,"navigation":true};
			}
			else
			{
				response.put("text","üñ•Ô∏è *EC2 Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
				response.put("card",{"title":"üñ•Ô∏è EC2 Error","theme":"prompt"});
			}
		}
		else
		{
			response.put("text","üñ•Ô∏è *Missing instance ID*");
			response.put("card",{"title":"üñ•Ô∏è EC2 Error","theme":"prompt"});
		}
	}
	// ---------------- EC2 INFO (Single Instance Details) ----------------
	else if(actionSubtype == "info")
	{
		instanceId = keyPart2;
		if(instanceId != "")
		{
			requestBody.put("action","get");
			requestBody.put("instanceId",instanceId);
			apiResponse = invokeurl
			[
				url :API_URL
				type :POST
				parameters:requestBody.toString()
				headers:{"Content-Type":"application/json"}
				connection:"awscloudcommander"
			];
			if(apiResponse.get("success") == true)
			{
				instance = apiResponse.get("data");
				instanceName = ifnull(instance.get("name"),"Instance");
				state = ifnull(instance.get("state"),"unknown");
				stateEmoji = "‚ö™";
				if(state == "running")
				{
					stateEmoji = "üü¢";
				}
				else if(state == "stopped")
				{
					stateEmoji = "üî¥";
				}
				else if(state == "pending")
				{
					stateEmoji = "üü°";
				}
				else if(state == "stopping")
				{
					stateEmoji = "üü†";
				}
				// Build action buttons based on state
				actionButtons = List();
				if(state == "running")
				{
					actionButtons.add({"label":"Stop","hint":"Stop this instance","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_stop_" + instanceId});
					actionButtons.add({"label":"Reboot","hint":"Restart this instance","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_reboot_" + instanceId});
				}
				else if(state == "stopped")
				{
					actionButtons.add({"label":"Start","hint":"Start this instance","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_start_" + instanceId});
				}
				actionButtons.add({"label":"Refresh","hint":"Reload instance details","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_info_" + instanceId});
				actionButtons.add({"label":"List All","hint":"View all instances","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_refresh"});
				// Format launch time
				launchTimeFormatted = "‚Äî";
				launchTimeRaw = instance.get("launchTime");
				if(launchTimeRaw != null && launchTimeRaw != "")
				{
					try
					{
					launchTimeStr = launchTimeRaw.toString();
					// If it's an ISO string (e.g., "2025-12-08T13:50:58.000Z")
					if(launchTimeStr.contains("T"))
					{
						// Extract date and time parts manually
						datePart = launchTimeStr.subString(0, launchTimeStr.indexOf("T"));
						timePart = launchTimeStr.subString(launchTimeStr.indexOf("T") + 1);
						// Remove milliseconds (everything after ".") and timezone ("Z")
						if(timePart.contains("."))
						{
							timePart = timePart.subString(0, timePart.indexOf("."));
						}
						// Remove Z if present (should be removed by above, but double-check)
						if(timePart.contains("Z"))
						{
							zIndex = timePart.indexOf("Z");
							timePart = timePart.subString(0, zIndex);
						}
						// Parse date parts: YYYY-MM-DD
						dateParts = datePart.toList("-");
						if(dateParts.size() == 3)
						{
							year = dateParts.get(0);
							day = dateParts.get(2);
							monthNum = dateParts.get(1);
							// Parse time parts: HH:mm:ss
							timeParts = timePart.toList(":");
							hour = "00";
							minute = "00";
							if(timeParts.size() >= 2)
							{
								hour = timeParts.get(0);
								minute = timeParts.get(1);
							}
							// Format month name
							monthNames = {"01":"Jan","02":"Feb","03":"Mar","04":"Apr","05":"May","06":"Jun","07":"Jul","08":"Aug","09":"Sep","10":"Oct","11":"Nov","12":"Dec"};
							monthName = ifnull(monthNames.get(monthNum),"Dec");
							// Build formatted string: "08 Dec 2025, 13:50"
							launchTimeFormatted = day + " " + monthName + " " + year + ", " + hour + ":" + minute;
						}
					}
						else
						{
							// Try toDate() as fallback
							launchDate = launchTimeRaw.toDate();
							if(launchDate != null)
							{
								launchTimeFormatted = launchDate.toString("dd MMM yyyy") + ", " + launchDate.toString("HH:mm");
							}
						}
					}
					catch(e)
					{
						launchTimeFormatted = launchTimeRaw.toString();
					}
				}
				// Format instance type (already human-readable, but ensure it's displayed nicely)
				instanceTypeDisplay = ifnull(instance.get("type"),"‚Äî");
				return {"text":"*üñ•Ô∏è " + instanceName + "*","card":{"theme":"modern-inline"},"slides":{{"type":"label","title":"Instance Details","data":{{"State":stateEmoji + " " + state},{"Type":instanceTypeDisplay},{"Public IP":ifnull(instance.get("publicIp"),"‚Äî")},{"Private IP":ifnull(instance.get("privateIp"),"‚Äî")},{"Availability Zone":ifnull(instance.get("az"),"‚Äî")},{"Launch Time":launchTimeFormatted}}}},"buttons":actionButtons,"navigation":true};
			}
			else
			{
				response.put("text","üñ•Ô∏è *EC2 Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
				response.put("card",{"title":"üñ•Ô∏è EC2 Error","theme":"prompt"});
			}
		}
		else
		{
			response.put("text","üñ•Ô∏è *Missing instance ID*");
			response.put("card",{"title":"üñ•Ô∏è EC2 Error","theme":"prompt"});
		}
	}
	// ---------------- EC2 SECURITY GROUPS ----------------
	else if(actionSubtype == "sg")
	{
		// Parse pagination from button key (format: ec2_sg|page|X)
		pageNum = 1;
		limitNum = 5;
		if(buttonKey.contains("|page|"))
		{
			pageParts = buttonKey.toList("|page|");
			if(pageParts.size() > 1)
			{
				try
				{
					pageNum = pageParts.get(1).toLong();
				}
				catch(e)
				{
					pageNum = 1;
				}
			}
		}
		requestBody.put("action","securityGroups");
		requestBody.put("page",pageNum);
		requestBody.put("limit",limitNum);
		apiResponse = invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		];
		if(apiResponse.get("success") == true)
		{
			data = apiResponse.get("data");
			// Extract security groups array and pagination metadata
			sgList = ifnull(data.get("securityGroups"),data);
			pagination = ifnull(data.get("pagination"),Map());
			currentPage = ifnull(pagination.get("currentPage"),1);
			totalPages = ifnull(pagination.get("totalPages"),1);
			totalItems = ifnull(pagination.get("totalItems"),sgList.size());
			hasPrev = ifnull(pagination.get("hasPrev"),false);
			hasNext = ifnull(pagination.get("hasNext"),false);
			
			if(sgList.size() == 0)
			{
				return {"text":"*üîê No security groups found.*","card":{"theme":"modern-inline"},"buttons":{{"label":"üñ•Ô∏è EC2 Instances","hint":"View EC2 instances","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_refresh"}}};
			}
			// Build security groups table
			rows = List();
			for each  sg in sgList
			{
				row = Map();
				sgName = ifnull(sg.get("name"),"Unnamed");
				row.put("Security Group","*" + sgName + "*");
				row.put("VPC",ifnull(sg.get("vpcId"),"‚Äî"));
				// Count rules
				inbound = ifnull(sg.get("inboundRules"),0);
				outbound = ifnull(sg.get("outboundRules"),0);
				row.put("Rules","‚Üì" + inbound + " ‚Üë" + outbound);
				rows.add(row);
			}
			
			pageText = "";
			if(totalPages > 1)
			{
				pageText = " (Page " + currentPage + " of " + totalPages + ")";
			}
			
			// Build buttons with pagination FIRST
			buttons = List();
			baseKey = "ec2_sg";
			if(totalPages > 1)
			{
				if(hasPrev)
				{
					buttons.add({"label":"‚¨ÖÔ∏è Previous","hint":"Go to previous page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage - 1)});
				}
				if(hasNext)
				{
					buttons.add({"label":"Next ‚û°Ô∏è","hint":"Go to next page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage + 1)});
				}
			}
			// Add other action buttons after pagination
			buttons.add({"label":"üîÑ Refresh","hint":"Reload security groups","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_sg"});
			buttons.add({"label":"üñ•Ô∏è EC2 Instances","hint":"View EC2 instances","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_refresh"});
			
			return {"text":"*üîê Security Groups* (" + totalItems + pageText + ")","card":{"theme":"modern-inline"},"slides":{{"type":"table","title":"","data":{"headers":{"Security Group","VPC","Rules"},"rows":rows}}},"buttons":buttons,"navigation":true};
		}
		else
		{
			response.put("text","üñ•Ô∏è *EC2 Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
			response.put("card",{"title":"üñ•Ô∏è EC2 Error","theme":"prompt"});
		}
	}
	else
	{
		response.put("text","üñ•Ô∏è *Unknown EC2 action:* " + actionSubtype);
		response.put("card",{"title":"üñ•Ô∏è EC2 Error","theme":"prompt"});
	}
}
// ============================================================================
// SECTION: S3 Bucket Management Actions
// ============================================================================
// Handles all S3-related button clicks:
//   - s3_refresh / s3_list        ‚Üí List buckets with pagination
//   - s3_create                  ‚Üí Show bucket creation form
//   - s3_browse_<bucket-name>    ‚Üí Browse bucket contents (with pagination)
//   - s3_delete_<bucket-name>   ‚Üí Delete bucket (with confirmation)
//   - s3_info_<bucket-name>      ‚Üí Show bucket details
//   - s3_search_form_<bucket>   ‚Üí Show search form
//   - s3_search_<bucket>_<term>  ‚Üí Search files in bucket
//   - s3_download_<bucket>_<key> ‚Üí Get download link
// ============================================================================
else if(actionType == "s3")
{
	requestBody = Map();
	requestBody.put("service","s3");
	requestBody.put("userId",userId);
	requestBody.put("region",userRegion);
	// ---------------- S3 REFRESH ----------------
	if(actionSubtype == "refresh" || actionSubtype == "list")
	{
		// Parse pagination from original button key (format: s3_refresh|page|X)
		pageNum = 1;
		limitNum = 5;
		if(originalButtonKey.contains("|page|"))
		{
			pageParts = originalButtonKey.toList("|page|");
			if(pageParts.size() > 1)
			{
				try
				{
					pageNum = pageParts.get(pageParts.size() - 1).toLong();
				}
				catch(e)
				{
					pageNum = 1;
				}
			}
		}
		requestBody.put("action","listBuckets");
		requestBody.put("page",pageNum);
		requestBody.put("limit",limitNum);
		apiResponse = invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		];
		if(apiResponse.get("success") == true)
		{
			data = apiResponse.get("data");
			// Extract buckets array and pagination metadata
			buckets = ifnull(data.get("buckets"),data);
			pagination = ifnull(data.get("pagination"),Map());
			currentPage = ifnull(pagination.get("currentPage"),1);
			totalPages = ifnull(pagination.get("totalPages"),1);
			totalItems = ifnull(pagination.get("totalItems"),buckets.size());
			hasPrev = ifnull(pagination.get("hasPrev"),false);
			hasNext = ifnull(pagination.get("hasNext"),false);
			
			if(buckets.size() == 0)
			{
				response.put("text","*üì¶ S3 Buckets - No buckets found*\n\nCreate your first bucket to get started!");
				response.put("card",{"theme":"modern-inline"});
				response.put("buttons",{{"label":"‚ûï Create Bucket","hint":"Create new S3 bucket","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_createform"},{"label":"üîÑ Refresh","hint":"Reload bucket list","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_refresh"}});
				response.put("navigation",true);
			}
			else
			{
				rows = List();
				for each  bucket in buckets
				{
					bucketName = ifnull(bucket.get("name"),"");
					bucketRegion = ifnull(bucket.get("region"),"-");
					// Build inline action buttons
					browseBtn = "[+üìÇ Browse](invoke.function|handleButton||s3_browse_" + bucketName + ")";
					infoBtn = "[+‚ÑπÔ∏è Info](invoke.function|handleButton||s3_info_" + bucketName + ")";
					deleteBtn = "[+üóëÔ∏è Delete](invoke.function|handleButton||s3_deleteconfirm_" + bucketName + ")";
					row = Map();
					row.put("Bucket","üì¶ " + bucketName);
					row.put("Region",bucketRegion);
					row.put("",browseBtn + " " + infoBtn + " " + deleteBtn);
					rows.add(row);
				}
				
				pageText = "";
				if(totalPages > 1)
				{
					pageText = " (Page " + currentPage + " of " + totalPages + ")";
				}
				
				// Build buttons with pagination FIRST
				buttons = List();
				baseKey = "s3_refresh";
				if(totalPages > 1)
				{
					if(hasPrev)
					{
						buttons.add({"label":"‚¨ÖÔ∏è Previous","hint":"Go to previous page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage - 1)});
					}
					if(hasNext)
					{
						buttons.add({"label":"Next ‚û°Ô∏è","hint":"Go to next page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage + 1)});
					}
				}
				// Add other action buttons after pagination
				buttons.add({"label":"‚ûï Create Bucket","hint":"Create new S3 bucket","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_createform"});
				buttons.add({"label":"üîÑ Refresh","hint":"Reload bucket list","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_refresh"});
				
				response.put("text","*üì¶ S3 Buckets (" + totalItems + pageText + ")*");
				response.put("card",{"theme":"modern-inline"});
				response.put("slides",{{"type":"table","title":"","data":{"headers":{"Bucket","Region",""},"rows":rows}}});
				response.put("buttons",buttons);
				response.put("navigation",true);
			}
		}
		else
		{
			response.put("text","üì¶ *S3 Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
			response.put("card",{"title":"üì¶ S3 Error","theme":"prompt"});
		}
	}
	// ---------------- S3 BROWSE ----------------
	else if(actionSubtype == "browse")
	{
		// Parse button key: s3_browse_{bucket}_{prefix}|page|{page}
		// Use |page| as separator to avoid conflicts with bucket/prefix names that may contain underscores
		bucketName = "";
		prefix = "";
		pageNum = 1;
		// Check if button key contains "|page|" separator
		if(buttonKey.contains("|page|"))
		{
			// Split by "|page|" to separate bucket/prefix from page number
			pageParts = buttonKey.toList("|page|");
			if(pageParts.size() >= 2)
			{
				// First part is "s3_browse_bucket_prefix" or "s3_browse_bucket"
				bucketPrefixPart = pageParts.get(0);
				// Remove "s3_browse_" prefix
				if(bucketPrefixPart.contains("s3_browse_"))
				{
					bucketPrefixPart = bucketPrefixPart.replaceFirst("s3_browse_","");
				}
				// Last part is page number
				pageNumStr = pageParts.get(pageParts.size() - 1);
				try
				{
					pageNum = pageNumStr.toLong();
				}
				catch(e)
				{
					pageNum = 1;
				}
				// Parse bucket and prefix from bucketPrefixPart
				// bucketPrefixPart could be just bucket or bucket_prefix
				// Since bucket names can have underscores (AWS allows them), we need a different approach
				// Use keyPart3 logic: if there are more than 2 parts in keyParts (before |page|),
				// then keyPart3 is the prefix
				// Actually, let's check the original keyParts structure before |page|
				keyPartsBeforePage = bucketPrefixPart.toList("_");
				if(keyPartsBeforePage.size() > 0)
				{
					bucketName = keyPartsBeforePage.get(0);
					// If there are more parts, they form the prefix
					if(keyPartsBeforePage.size() > 1)
					{
						prefixParts = List();
						for each  idx in {1,2,3,4,5,6,7,8,9}
						{
							if(idx < keyPartsBeforePage.size())
							{
								prefixParts.add(keyPartsBeforePage.get(idx));
							}
						}
						prefix = prefixParts.toString("_");
					}
				}
			}
		}
		else
		{
			// No page number, use keyPart2 as bucket and keyPart3 as prefix (original logic)
			bucketName = keyPart2;
			prefix = keyPart3;
		}
		if(bucketName != "")
		{
			requestBody.put("action","listObjects");
			requestBody.put("bucket",bucketName);
			if(prefix != "")
			{
				requestBody.put("prefix",prefix);
			}
			requestBody.put("page",pageNum);
			requestBody.put("limit",5);
			apiResponse = invokeurl
			[
				url :API_URL
				type :POST
				parameters:requestBody.toString()
				headers:{"Content-Type":"application/json"}
				connection:"awscloudcommander"
			];
			if(apiResponse.get("success") == true)
			{
				data = apiResponse.get("data");
				folders = ifnull(data.get("folders"),List());
				files = ifnull(data.get("files"),List());
				titleText = bucketName;
				if(prefix != "")
				{
					titleText = titleText + " / " + prefix;
				}
				// Extract pagination metadata
				pagination = ifnull(data.get("pagination"),Map());
				currentPage = ifnull(pagination.get("currentPage"),1);
				totalPages = ifnull(pagination.get("totalPages"),1);
				totalItems = ifnull(pagination.get("totalItems"),folders.size() + files.size());
				hasNext = ifnull(pagination.get("hasNext"),false);
				hasPrev = ifnull(pagination.get("hasPrev"),false);
				slides = List();
				buttons = List();
				if(folders.size() > 0)
				{
					folderNames = List();
					for each  folder in folders
					{
						folderNames.add("üìÅ " + folder.get("name"));
					}
					slides.add({"type":"list","title":"Folders (" + folders.size() + ")","data":folderNames});
				}
				if(files.size() > 0)
				{
					fileRows = List();
					for each  file in files
					{
						fileName = ifnull(file.get("name"),"");
						fileKey = ifnull(file.get("key"),"");
						fileSize = ifnull(file.get("sizeFormatted"),"-");
						// Build inline action buttons like EC2 - Label is tooltip text
						downloadBtn = "[+üì• Download](invoke.function|handleButton||s3_download_" + bucketName + "_" + fileKey + ")";
						infoBtn = "[+‚ÑπÔ∏è Info](invoke.function|handleButton||s3_object_" + bucketName + "_" + fileKey + ")";
						deleteBtn = "[-üóëÔ∏è Delete](invoke.function|handleButton||s3_delete_" + bucketName + "_" + fileKey + ")";
						fileRow = Map();
						fileRow.put("Name","üìÑ " + fileName);
						fileRow.put("Size",fileSize);
						fileRow.put("",downloadBtn + " " + infoBtn + " " + deleteBtn);
						fileRows.add(fileRow);
					}
					slides.add({"type":"table","title":"Files (" + files.size() + ")","data":{"headers":{"Name","Size",""},"rows":fileRows}});
				}
				// Build base key for pagination
				baseKey = "s3_browse_" + bucketName;
				if(prefix != "")
				{
					baseKey = baseKey + "_" + prefix;
				}
				// Add pagination buttons FIRST (Previous and Next only - Refresh goes to 3-dot)
				if(totalPages > 1)
				{
					if(hasPrev)
					{
						buttons.add({"label":"‚¨ÖÔ∏è Previous","hint":"Go to previous page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage - 1)});
					}
					if(hasNext)
					{
						buttons.add({"label":"Next ‚û°Ô∏è","hint":"Go to next page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage + 1)});
					}
					// Refresh goes to 3-dot menu when pagination exists
					buttons.add({"label":"üîÑ Refresh","hint":"Reload current page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + currentPage});
				}
				else
				{
					// No pagination - Refresh can be prominent
					buttons.add({"label":"üîÑ Refresh","hint":"Reload bucket contents","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey});
				}
				// Add other action buttons after pagination (these go to 3-dot menu)
				buttons.add({"label":"üì§ Upload","hint":"Upload file to bucket","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_upload_form_" + bucketName + "_" + prefix});
				buttons.add({"label":"‚ÑπÔ∏è Bucket Info","hint":"View bucket details","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_info_" + bucketName});
				buttons.add({"label":"üîç Search","hint":"Search in bucket","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_search_form_" + bucketName});
				buttons.add({"label":"üì¶ All Buckets","hint":"View all buckets","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_refresh"});
				// Build pagination text
				pageText = "";
				if(totalPages > 1)
				{
					pageText = " (Page " + currentPage + " of " + totalPages + ", " + totalItems + " total)";
				}
				response.put("text","*üì¶ S3 Browser - " + titleText + pageText + "*");
				response.put("card",{"theme":"modern-inline"});
				if(slides.size() > 0)
				{
					response.put("slides",slides);
				}
				else
				{
					response.put("text","*üì¶ S3 Browser - " + titleText + "*\n\nThis location is empty.");
				}
				response.put("buttons",buttons);
				response.put("navigation",true);
			}
			else
			{
				response.put("text","üì¶ *S3 Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
				response.put("card",{"title":"üì¶ S3 Error","theme":"prompt"});
			}
		}
	}
	// ---------------- S3 DOWNLOAD ----------------
	else if(actionSubtype == "download")
	{
		// keyParts: ["s3", "download", "bucket", "rest", "of", "key"]
		bucketName = "";
		if(keyPartsSize > 2)
		{
			bucketName = keyParts.get(2);
		}
		objectKey = buttonKey.replaceFirst("s3_download_" + bucketName + "_","");
		if(bucketName != "" && objectKey != "")
		{
			requestBody.put("action","getPresignedUrl");
			requestBody.put("bucket",bucketName);
			requestBody.put("key",objectKey);
			apiResponse = invokeurl
			[
				url :API_URL
				type :POST
				parameters:requestBody.toString()
				headers:{"Content-Type":"application/json"}
				connection:"awscloudcommander"
			];
			if(apiResponse.get("success") == true)
			{
				data = apiResponse.get("data");
				url = ifnull(data.get("url"),"");
				response.put("text","*üîó Download Link*\n\n" + url + "\n\n‚è∞ Link expires in 1 hour");
				response.put("card",{"theme":"modern-inline"});
				response.put("buttons",{{"label":"üîó Open Link","hint":"Open in browser","type":"+","action":{"type":"open.url","data":{"web":url}}},{"label":"üì¶ Browse","hint":"Back to bucket","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_browse_" + bucketName}});
			}
			else
			{
				response.put("text","üì¶ *S3 Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
				response.put("card",{"title":"üì¶ S3 Error","theme":"prompt"});
			}
		}
	}
	// ---------------- S3 INFO (Bucket Details) ----------------
	else if(actionSubtype == "info")
	{
		bucketName = keyPart2;
		if(bucketName != "")
		{
			requestBody.put("action","getBucket");
			requestBody.put("bucket",bucketName);
			apiResponse = invokeurl
			[
				url :API_URL
				type :POST
				parameters:requestBody.toString()
				headers:{"Content-Type":"application/json"}
				connection:"awscloudcommander"
			];
			if(apiResponse.get("success") == true)
			{
				data = apiResponse.get("data");
				bucketRegion = ifnull(data.get("region"),"‚Äî");
				totalObjects = ifnull(data.get("totalObjects"),0);
				totalSize = ifnull(data.get("totalSizeFormatted"),"0 B");
				approxCount = ifnull(data.get("approximateCount"),false);
				objectCountText = totalObjects + "";
				if(approxCount)
				{
					objectCountText = totalObjects + "+";
				}
				response.put("text","*üì¶ Bucket Details: " + bucketName + "*");
				response.put("card",{"theme":"modern-inline"});
				response.put("slides",{{"type":"label","title":"","data":{{"Region":bucketRegion},{"Total Objects":objectCountText},{"Total Size":totalSize}}}});
				response.put("buttons",{{"label":"üìÇ Browse","hint":"Browse contents","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_browse_" + bucketName},{"label":"üîç Search","hint":"Search in bucket","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_search_form_" + bucketName},{"label":"üì¶ All Buckets","hint":"View all buckets","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_refresh"}});
				response.put("navigation",true);
			}
			else
			{
				response.put("text","üì¶ *S3 Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
				response.put("card",{"title":"üì¶ S3 Error","theme":"prompt"});
			}
		}
	}
	// ---------------- S3 SEARCH FORM ----------------
	else if(actionSubtype == "search" && buttonKey.contains("search_form"))
	{
		// Key format: s3_search_form_bucketname
		// Need to extract bucket name after "s3_search_form_"
		bucketName = buttonKey.replaceFirst("s3_search_form_","");
		if(bucketName != "")
		{
			// Truncate bucket name for display to avoid form crashes with long names
			displayBucketName = bucketName;
			if(bucketName.length() > 30)
			{
				displayBucketName = bucketName.subString(0,27) + "...";
			}
			return {"type":"form","title":"üîç Search S3 Bucket","hint":"Search in: " + displayBucketName,"name":"s3_search","button_label":"Search","inputs":{{"type":"hidden","name":"bucket","value":bucketName},{"type":"text","name":"searchTerm","label":"Search Term","placeholder":"Enter filename or keyword","mandatory":true,"min_length":"1","max_length":"100"}},"action":{"type":"invoke.function","name":"handleForm"}};
		}
	}
	// ---------------- S3 UPLOAD FORM ----------------
	else if(actionSubtype == "upload" && buttonKey.contains("upload_form"))
	{
		// Key format: s3_upload_form_bucketname_prefix
		// Need to extract bucket name and prefix after "s3_upload_form_"
		remaining = buttonKey.replaceFirst("s3_upload_form_","");
		// Split remaining by underscore - first part is bucket, rest is prefix
		remainingParts = remaining.toList("_");
		bucketName = "";
		prefix = "";
		if(remainingParts.size() > 0)
		{
			bucketName = remainingParts.get(0);
			if(remainingParts.size() > 1)
			{
				// Rebuild prefix from remaining parts
				remainingParts.remove(0);
				prefix = remainingParts.toString("_");
			}
		}
		if(bucketName != "")
		{
			// Truncate bucket name for display to avoid form crashes with long names
			displayPath = bucketName;
			if(prefix != "")
			{
				displayPath = displayPath + "/" + prefix;
			}
			if(displayPath.length() > 35)
			{
				displayPath = displayPath.subString(0,32) + "...";
			}
			formHint = "Upload to: " + displayPath;
			// Build inputs - only include prefix if it has a value
			formInputs = List();
			formInputs.add({"type":"hidden","name":"bucket","value":bucketName});
			if(prefix != "")
			{
				formInputs.add({"type":"hidden","name":"prefix","value":prefix});
			}
			formInputs.add({"type":"file","name":"files","label":"Select Files","placeholder":"Choose files to upload (max 10)","mandatory":true,"multiple":true,"max_selections":10,"max_size":51200});
			return {"type":"form","title":"üì§ Upload to S3","hint":formHint,"name":"s3_upload","button_label":"Upload","inputs":formInputs,"action":{"type":"invoke.function","name":"handleForm"}};
		}
	}
	// ---------------- S3 DELETE (Show Confirmation) ----------------
	else if(actionSubtype == "delete" && !buttonKey.contains("delete_confirm"))
	{
		// keyParts: ["s3", "delete", "bucket", "rest", "of", "key"]
		bucketName = "";
		if(keyPartsSize > 2)
		{
			bucketName = keyParts.get(2);
		}
		objectKey = buttonKey.replaceFirst("s3_delete_" + bucketName + "_","");
		if(bucketName != "" && objectKey != "")
		{
			fileName = ifnull(objectKey.getSuffix("/"),objectKey);
			if(fileName == "" || fileName == null)
			{
				fileName = objectKey;
			}
			response.put("text","*üóëÔ∏è Delete Confirmation*\n\nAre you sure you want to delete this object?\n\nüì¶ Bucket: `" + bucketName + "`\nüìÑ File: `" + fileName + "`\n\n‚ö†Ô∏è *This action cannot be undone!*");
			response.put("card",{"theme":"prompt"});
			response.put("buttons",{{"label":"üóëÔ∏è Delete","hint":"Permanently delete","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_deleteconfirm_" + bucketName + "_" + objectKey},{"label":"‚ùå Cancel","hint":"Cancel deletion","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_browse_" + bucketName}});
		}
	}
	// ---------------- S3 DELETE CONFIRM OBJECT (Actually Delete Object) ----------------
	else if(actionSubtype == "deleteconfirm" && keyPartsSize > 3)
	{
		// keyParts: ["s3", "deleteconfirm", "bucket", "rest", "of", "key"]
		// Only handle if there are more than 3 parts (bucket + object key)
		bucketName = "";
		if(keyPartsSize > 2)
		{
			bucketName = keyParts.get(2);
		}
		objectKey = buttonKey.replaceFirst("s3_deleteconfirm_" + bucketName + "_","");
		if(bucketName != "" && objectKey != "" && objectKey != buttonKey)
		{
			requestBody.put("action","deleteObject");
			requestBody.put("bucket",bucketName);
			requestBody.put("key",objectKey);
			apiResponse = invokeurl
			[
				url :API_URL
				type :POST
				parameters:requestBody.toString()
				headers:{"Content-Type":"application/json"}
				connection:"awscloudcommander"
			];
			if(apiResponse.get("success") == true)
			{
				fileName = ifnull(objectKey.getSuffix("/"),objectKey);
				if(fileName == "" || fileName == null)
				{
					fileName = objectKey;
				}
				response.put("text","*‚úÖ Object Deleted*\n\nüìÑ `" + fileName + "` has been deleted from `" + bucketName + "`");
				response.put("card",{"theme":"modern-inline"});
				response.put("buttons",{{"label":"üì¶ Browse Bucket","hint":"View bucket contents","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_browse_" + bucketName},{"label":"üì¶ All Buckets","hint":"View all buckets","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_refresh"}});
				response.put("navigation",true);
			}
			else
			{
				response.put("text","üì¶ *Delete Failed*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
				response.put("card",{"title":"üì¶ S3 Error","theme":"prompt"});
				response.put("buttons",{{"label":"üì¶ Browse Bucket","hint":"View bucket contents","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_browse_" + bucketName}});
			}
		}
	}
	// ---------------- S3 OBJECT INFO ----------------
	else if(actionSubtype == "object")
	{
		// keyParts: ["s3", "object", "bucket", "rest", "of", "key"]
		// keyPart2 has bucket and rest joined, so we need keyParts.get(2) for bucket
		bucketName = "";
		if(keyPartsSize > 2)
		{
			bucketName = keyParts.get(2);
		}
		objectKey = buttonKey.replaceFirst("s3_object_" + bucketName + "_","");
		if(bucketName != "" && objectKey != "")
		{
			requestBody.put("action","getObject");
			requestBody.put("bucket",bucketName);
			requestBody.put("key",objectKey);
			apiResponse = invokeurl
			[
				url :API_URL
				type :POST
				parameters:requestBody.toString()
				headers:{"Content-Type":"application/json"}
				connection:"awscloudcommander"
			];
			if(apiResponse.get("success") == true)
			{
				data = apiResponse.get("data");
				fileName = ifnull(objectKey.getSuffix("/"),objectKey);
				if(fileName == "" || fileName == null)
				{
					fileName = objectKey;
				}
				size = ifnull(data.get("sizeFormatted"),"‚Äî");
				contentType = ifnull(data.get("contentType"),"‚Äî");
				lastModified = ifnull(data.get("lastModified"),"‚Äî");
				storageClass = ifnull(data.get("storageClass"),"STANDARD");
				response.put("text","*üìÑ Object Details: " + fileName + "*");
				response.put("card",{"theme":"modern-inline"});
				response.put("slides",{{"type":"label","title":"","data":{{"Bucket":bucketName},{"Size":size},{"Type":contentType},{"Storage Class":storageClass},{"Modified":lastModified}}}});
				response.put("buttons",{{"label":"üì• Download","hint":"Get download link","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_download_" + bucketName + "_" + objectKey},{"label":"üóëÔ∏è Delete","hint":"Delete object","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_delete_" + bucketName + "_" + objectKey},{"label":"üì¶ Browse","hint":"Back to bucket","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_browse_" + bucketName}});
			}
			else
			{
				response.put("text","üì¶ *S3 Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
				response.put("card",{"title":"üì¶ S3 Error","theme":"prompt"});
			}
		}
	}
	// ---------------- S3 CREATE BUCKET FORM ----------------
	else if(actionSubtype == "createform")
	{
		// Return a form to create a new bucket
		formInputs = List();
		formInputs.add({"type":"text","name":"bucketName","label":"Bucket Name","placeholder":"my-new-bucket (lowercase, no underscores)","mandatory":true,"min_length":"3","max_length":"63"});
		formInputs.add({"type":"select","name":"region","label":"Region","placeholder":"Select region","mandatory":true,"value":"ap-south-1","options":{{"value":"us-east-1","label":"US East (N. Virginia)"},{"value":"us-east-2","label":"US East (Ohio)"},{"value":"us-west-1","label":"US West (N. California)"},{"value":"us-west-2","label":"US West (Oregon)"},{"value":"ap-south-1","label":"Asia Pacific (Mumbai)"},{"value":"ap-southeast-1","label":"Asia Pacific (Singapore)"},{"value":"ap-southeast-2","label":"Asia Pacific (Sydney)"},{"value":"ap-northeast-1","label":"Asia Pacific (Tokyo)"},{"value":"eu-west-1","label":"Europe (Ireland)"},{"value":"eu-west-2","label":"Europe (London)"},{"value":"eu-central-1","label":"Europe (Frankfurt)"}}});
		formInputs.add({"type":"hidden","name":"formAction","value":"createBucket"});
		response = Map();
		response.put("type","form");
		response.put("title","‚ûï Create S3 Bucket");
		response.put("hint","Bucket names must be globally unique, 3-63 characters, lowercase letters, numbers, and hyphens only.");
		response.put("name","s3_create_bucket");
		response.put("button_label","ü™£ Create Bucket");
		response.put("inputs",formInputs);
		response.put("action",{"type":"invoke.function","name":"handleForm"});
		return response;
	}
	// ---------------- S3 DELETE BUCKET CONFIRM ----------------
	else if(actionSubtype == "deleteconfirm" && keyPartsSize == 3)
	{
		// This is bucket delete confirmation - exactly 3 parts: s3_deleteconfirm_bucketname
		bucketName = keyParts.get(2);
		// First get bucket info to check if empty
		requestBody.put("action","getBucket");
		requestBody.put("bucket",bucketName);
		apiResponse = invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		];
		if(apiResponse.get("success") == true)
		{
			data = apiResponse.get("data");
			objectCount = ifnull(data.get("totalObjects"),0);
			sizeFormatted = ifnull(data.get("totalSizeFormatted"),"0 Bytes");
			if(objectCount > 0)
			{
				response.put("text","*‚ö†Ô∏è Cannot Delete Bucket*\n\nüì¶ Bucket: `" + bucketName + "`\nüìä Objects: " + objectCount + " (" + sizeFormatted + ")\n\n‚ùå *Bucket is not empty!*\n\nYou must delete all objects before deleting the bucket.");
				response.put("card",{"theme":"prompt"});
				response.put("buttons",{{"label":"üìÇ Browse Bucket","hint":"View and delete objects","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_browse_" + bucketName},{"label":"üì¶ All Buckets","hint":"Back to bucket list","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_refresh"}});
			}
			else
			{
				// Bucket is empty, show delete confirmation form
				// Truncate bucket name for display to avoid form crashes with long names
				displayBucketName = bucketName;
				if(bucketName.length() > 25)
				{
					displayBucketName = bucketName.subString(0,22) + "...";
				}
				formInputs = List();
				formInputs.add({"type":"text","name":"confirmName","label":"Type bucket name to confirm","placeholder":"Enter the exact bucket name","mandatory":true});
				formInputs.add({"type":"hidden","name":"bucketName","value":bucketName});
				formInputs.add({"type":"hidden","name":"formAction","value":"deleteBucket"});
				response = Map();
				response.put("type","form");
				response.put("title","üóëÔ∏è Delete Bucket");
				response.put("hint","Bucket: " + displayBucketName + " - Type full name to confirm.");
				response.put("name","s3_delete_bucket");
				response.put("button_label","üóëÔ∏è Delete Bucket");
				response.put("inputs",formInputs);
				response.put("action",{"type":"invoke.function","name":"handleForm"});
				return response;
			}
		}
		else
		{
			response.put("text","üì¶ *S3 Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
			response.put("card",{"title":"üì¶ S3 Error","theme":"prompt"});
		}
	}
	else
	{
		response.put("text","*Unknown S3 action:* " + actionSubtype);
	}
}
// ============================================================================
// SECTION: Cost Explorer Actions
// ============================================================================
// Handles AWS cost reporting button clicks:
//   - cost_today     ‚Üí Today's spending breakdown
//   - cost_week      ‚Üí Last 7 days costs
//   - cost_month     ‚Üí Month-to-date costs
//   - cost_forecast  ‚Üí Predicted monthly spend
//   - cost_trend     ‚Üí Cost trends over time
//
// Note: Requires user consent (consentcost flag) due to $0.01 per API call
// ============================================================================
else if(actionType == "cost")
{
	// Check if user has Cost Explorer consent in Cliq database first
	queryMap = Map();
	queryMap.put("criteria","userid==" + userId);
	userPrefs = zoho.cliq.getRecords("awsprefs",queryMap);
	hasCostConsent = false;
	// getRecords returns {"status":"SUCCESS","list":[...]}
	if(userPrefs != null && userPrefs.get("status") == "SUCCESS")
	{
		prefList = userPrefs.get("list");
		if(prefList != null && prefList.size() > 0)
		{
			userPref = prefList.get(0);
			if(userPref != null)
			{
				consentValue = userPref.get("consentcost");
				// Handle boolean, string, and numeric values from database
				if(consentValue == true || consentValue == "true" || consentValue == 1 || consentValue == "1")
				{
					hasCostConsent = true;
				}
			}
		}
	}
	if(hasCostConsent == false)
	{
		// User has not consented - show consent prompt with pricing info
		response.put("text","*‚ö†Ô∏è Cost Explorer Requires Consent*\n\n" + "This feature uses *AWS Cost Explorer API* which incurs charges:\n\n" + "üí∞ *Pricing:*\n" + "‚Ä¢ $0.01 per API request\n" + "‚Ä¢ Each report view = 1 request\n\n" + "By enabling, you agree to these charges.");
		response.put("card",{"theme":"modern-inline"});
		response.put("buttons",{{"label":"Enable Costs","hint":"I agree to Cost Explorer charges","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"consent_grant_cost_explorer"},{"label":"Cancel","hint":"Return to dashboard","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
	}
	else
	{
		// User has consent - proceed with cost API call
		requestBody = Map();
		requestBody.put("service","cost");
		requestBody.put("userId",userId);
		requestBody.put("consent",true);
		period = "week";
		if(actionSubtype == "today")
		{
			requestBody.put("action","byPeriod");
			requestBody.put("period","today");
			period = "Today";
		}
		else if(actionSubtype == "month")
		{
			requestBody.put("action","monthToDate");
			period = "Month to Date";
		}
		else if(actionSubtype == "compare")
		{
			requestBody.put("action","comparison");
			period = "Comparison";
		}
		else
		{
			requestBody.put("action","byPeriod");
			requestBody.put("period","week");
			period = "Last 7 Days";
		}
		apiResponse = invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		];
		if(apiResponse.get("success") == true)
		{
			data = apiResponse.get("data");
			totalCost = ifnull(data.get("totalCostFormatted"),"$0.00");
			dailyAvg = ifnull(data.get("dailyAverageFormatted"),"$0.00");
			serviceText = "";
			services = data.get("byService");
			if(services != null)
			{
				count = 0;
				for each  svc in services
				{
					if(svc.get("cost") > 0 && count < 5)
					{
						emoji = ifnull(svc.get("emoji"),"");
						serviceText = serviceText + emoji + " " + svc.get("service") + ": " + svc.get("costFormatted") + "\n";
						count = count + 1;
					}
				}
			}
			response.put("text","*üí∞ AWS Costs - " + period + "*\n\nüíµ Total: " + totalCost + "\nüìä Daily Avg: " + dailyAvg + "\n\nBy Service:\n" + serviceText);
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"Today","hint":"View today's costs","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"cost_today"},{"label":"This Month","hint":"View month-to-date","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"cost_month"},{"label":"Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
		}
		else if(apiResponse.get("requiresConsent") == true)
		{
			// Server also requires consent - sync with Cliq DB
			response.put("text","*‚ö†Ô∏è Cost Explorer Consent Required on Server*\n\nCost Explorer: $0.01 per API call.\n\nClick below to enable.");
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"Enable Costs","hint":"Grant consent","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"consent_grant_cost_explorer"}});
		}
		else
		{
			response.put("text","üí∞ *Cost Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
			response.put("card",{"title":"üí∞ Cost Error","theme":"prompt"});
		}
	}
}
// ============================================================================
// SECTION: Incident Management Actions
// ============================================================================
// Handles incident creation and management:
//   - incident_create ‚Üí Show incident creation form
//   - incident_list   ‚Üí List all incidents
//   - incident_update_<id> ‚Üí Update incident status
//
// Stores incidents in awsincidents table for tracking and resolution
// ============================================================================
else if(actionType == "incident")
{
	if(actionSubtype == "create")
	{
		// Return incident form
		return {"type":"form","title":"üö® Create Incident","hint":"Report a new AWS incident","name":"awsIncidentForm","button_label":"üö® Create Incident","inputs":[{"type":"text","name":"title","label":"Incident Title","placeholder":"Brief description of the issue","mandatory":true},{"type":"select","name":"severity","label":"Severity","placeholder":"Select severity level","mandatory":true,"value":"medium","options":[{"value":"critical","label":"Critical - Service Down"},{"value":"high","label":"High - Major Impact"},{"value":"medium","label":"Medium - Partial Impact"},{"value":"low","label":"Low - Minor Issue"}]},{"type":"text","name":"resource","label":"Affected Resource","placeholder":"e.g., ec2:i-1234567890abcdef0","mandatory":false},{"type":"textarea","name":"notes","label":"Additional Notes","placeholder":"Any additional information...","mandatory":false}],"action":{"type":"invoke.function","name":"handleForm"}};
	}
	else if(actionSubtype == "list")
	{
		// List all incidents from database
		incidentCriteria = Map();
		incidentsResponse = zoho.cliq.getRecords("awsincidents",incidentCriteria);
		incidents = List();
		if(incidentsResponse != null && incidentsResponse.get("status") == "SUCCESS")
		{
			incidentList = incidentsResponse.get("list");
			if(incidentList != null)
			{
				incidents = incidentList;
			}
		}
		if(incidents.size() == 0)
		{
			return {"text":"*üö® No incidents found.*\n\nUse the button below to create one.","card":{"theme":"modern-inline"},"buttons":{{"label":"Create Incident","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"incident_create"}}};
		}
		// Build rows with clickable update action
		rows = List();
		for each  inc in incidents
		{
			if(rows.size() < 10)
			{
				row = Map();
				incId = ifnull(inc.get("incidentid"),"");
				row.put("ID",incId);
				row.put("Title",ifnull(inc.get("title"),""));
				severity = ifnull(inc.get("severity"),"");
				severityEmoji = "üü°";
				if(severity == "critical")
				{
					severityEmoji = "üî¥";
				}
				else if(severity == "high")
				{
					severityEmoji = "üü†";
				}
				else if(severity == "low")
				{
					severityEmoji = "üü¢";
				}
				row.put("Severity",severityEmoji + " " + severity);
				status = ifnull(inc.get("status"),"");
				statusEmoji = "üîµ";
				if(status == "resolved" || status == "closed")
				{
					statusEmoji = "‚úÖ";
				}
				row.put("Status",statusEmoji + " " + status);
				// Add Info, Update, Delete actions
				row.put("Actions","[‚ÑπÔ∏è Info](invoke.function|handleButton||incident_info_" + incId + ") [‚úèÔ∏è Update](invoke.function|handleButton||incident_update_" + incId + ") [üóëÔ∏è Delete](invoke.function|handleButton||incident_delete_" + incId + ")");
				rows.add(row);
			}
		}
		return {"text":"*üö® Incidents (" + incidents.size() + ")*","card":{"theme":"modern-inline"},"slides":{{"type":"table","title":"","data":{"headers":{"ID","Title","Severity","Status","Actions"},"rows":rows}}},"buttons":{{"label":"üîÑ Refresh","hint":"Reload incidents","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"incident_list"},{"label":"Create Incident","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"incident_create"}},"navigation":true};
	}
	else if(actionSubtype == "history")
	{
		// List only resolved/closed incidents
		incidentCriteria = Map();
		incidentsResponse = zoho.cliq.getRecords("awsincidents",incidentCriteria);
		incidents = List();
		if(incidentsResponse != null && incidentsResponse.get("status") == "SUCCESS")
		{
			incidentList = incidentsResponse.get("list");
			if(incidentList != null)
			{
				// Filter for resolved/closed incidents
				for each  inc in incidentList
				{
					status = ifnull(inc.get("status"),"");
					if(status == "resolved" || status == "closed")
					{
						incidents.add(inc);
					}
				}
			}
		}
		if(incidents.size() == 0)
		{
			return {"text":"*üìú No resolved incidents found.*\n\nOnly resolved or closed incidents are shown here.","card":{"theme":"modern-inline"},"buttons":{{"label":"üîÑ Refresh","hint":"Reload incident history","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"incident_history"},{"label":"View All","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"incident_list"},{"label":"Create Incident","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"incident_create"}},"navigation":true};
		}
		// Build rows with actions
		rows = List();
		for each  inc in incidents
		{
			if(rows.size() < 10)
			{
				row = Map();
				incId = ifnull(inc.get("incidentid"),"");
				row.put("ID",incId);
				row.put("Title",ifnull(inc.get("title"),""));
				severity = ifnull(inc.get("severity"),"");
				severityEmoji = "üü°";
				if(severity == "critical")
				{
					severityEmoji = "üî¥";
				}
				else if(severity == "high")
				{
					severityEmoji = "üü†";
				}
				else if(severity == "low")
				{
					severityEmoji = "üü¢";
				}
				row.put("Severity",severityEmoji + " " + severity);
				status = ifnull(inc.get("status"),"");
				statusEmoji = "‚úÖ";
				row.put("Status",statusEmoji + " " + status);
				// Add Info, Update, Delete actions
				row.put("Actions","[‚ÑπÔ∏è Info](invoke.function|handleButton||incident_info_" + incId + ") [‚úèÔ∏è Update](invoke.function|handleButton||incident_update_" + incId + ") [üóëÔ∏è Delete](invoke.function|handleButton||incident_delete_" + incId + ")");
				rows.add(row);
			}
		}
		return {"text":"*üìú Incident History (" + incidents.size() + " resolved/closed)*","card":{"theme":"modern-inline"},"slides":{{"type":"table","title":"","data":{"headers":{"ID","Title","Severity","Status","Actions"},"rows":rows}}},"buttons":{{"label":"üîÑ Refresh","hint":"Reload incident history","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"incident_history"},{"label":"View All","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"incident_list"},{"label":"Create Incident","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"incident_create"}},"navigation":true};
	}
	else if(actionSubtype == "info")
	{
		// Get incident ID from button key (incident_info_INC-123456)
		incId = buttonKey.subString(14);
		// Fetch incident details
		incidentQuery = Map();
		incidentQuery.put("criteria","incidentid==" + incId);
		incidentsResponse = zoho.cliq.getRecords("awsincidents",incidentQuery);
		if(incidentsResponse != null && incidentsResponse.get("status") == "SUCCESS")
		{
			incidentList = incidentsResponse.get("list");
			if(incidentList != null && incidentList.size() > 0)
			{
				inc = incidentList.get(0);
				title = ifnull(inc.get("title"),"Untitled");
				severity = ifnull(inc.get("severity"),"medium");
				status = ifnull(inc.get("status"),"open");
				resource = ifnull(inc.get("resource"),"N/A");
				notes = ifnull(inc.get("notes"),"");
				createdAt = ifnull(inc.get("createdat"),"");
				updatedAt = ifnull(inc.get("updatedat"),"");
				resolvedBy = ifnull(inc.get("resolvedby"),"");
				reportedBy = ifnull(inc.get("reportedby"),"");
				
				// Format severity
				severityDisplay = severity;
				if(severity == "critical")
				{
					severityDisplay = "üî¥ Critical";
				}
				else if(severity == "high")
				{
					severityDisplay = "üü† High";
				}
				else if(severity == "medium")
				{
					severityDisplay = "üü° Medium";
				}
				else if(severity == "low")
				{
					severityDisplay = "üü¢ Low";
				}
				
				// Format status
				statusDisplay = status;
				if(status == "resolved" || status == "closed")
				{
					statusDisplay = "‚úÖ " + status;
				}
				else if(status == "investigating")
				{
					statusDisplay = "üîç Investigating";
				}
				else
				{
					statusDisplay = "üîµ Open";
				}
				
				// Format dates
				createdDateDisplay = "N/A";
				if(createdAt != "")
				{
					try
					{
						createdAtNum = createdAt.toLong();
						createdDate = createdAtNum.toDate();
						if(createdDate != null)
						{
							createdDateDisplay = createdDate.toString("dd MMM yyyy, HH:mm");
						}
					}
					catch(e)
					{
					}
				}
				
				updatedDateDisplay = "N/A";
				if(updatedAt != "")
				{
					try
					{
						updatedAtNum = updatedAt.toLong();
						updatedDate = updatedAtNum.toDate();
						if(updatedDate != null)
						{
							updatedDateDisplay = updatedDate.toString("dd MMM yyyy, HH:mm");
						}
					}
					catch(e)
					{
					}
				}
				
				// Build info card
				infoData = List();
				infoData.add({"Incident ID":incId});
				infoData.add({"Title":title});
				infoData.add({"Severity":severityDisplay});
				infoData.add({"Status":statusDisplay});
				infoData.add({"Resource":resource});
				infoData.add({"Created":createdDateDisplay});
				infoData.add({"Updated":updatedDateDisplay});
				if(notes != "")
				{
					infoData.add({"Notes":notes});
				}
				
				return {"text":"*‚ÑπÔ∏è Incident Details*","card":{"theme":"modern-inline"},"slides":{{"type":"label","title":"","data":infoData}},"buttons":{{"label":"‚úèÔ∏è Update","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"incident_update_" + incId},{"label":"üóëÔ∏è Delete","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"incident_delete_" + incId},{"label":"üìã List All","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"incident_list"}},"navigation":true};
			}
		}
		return {"text":"*‚ùå Incident not found.*","card":{"theme":"modern-inline"},"buttons":{{"label":"üìã List All","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"incident_list"}},"navigation":true};
	}
	else if(actionSubtype == "delete")
	{
		// Get incident ID from button key (incident_delete_INC-123456)
		incId = buttonKey.subString(16);
		// Fetch incident to show confirmation
		incidentQuery = Map();
		incidentQuery.put("criteria","incidentid==" + incId);
		incidentsResponse = zoho.cliq.getRecords("awsincidents",incidentQuery);
		incidentTitle = "Unknown";
		if(incidentsResponse != null && incidentsResponse.get("status") == "SUCCESS")
		{
			incidentList = incidentsResponse.get("list");
			if(incidentList != null && incidentList.size() > 0)
			{
				inc = incidentList.get(0);
				incidentTitle = ifnull(inc.get("title"),"Unknown");
			}
		}
		// Return confirmation form
		return {"type":"form","title":"üóëÔ∏è Delete Incident","hint":"Are you sure you want to delete this incident?","name":"awsDeleteIncidentForm","button_label":"üóëÔ∏è Delete","inputs":{{"type":"hidden","name":"incidentId","value":incId},{"type":"text","name":"confirm","label":"Type 'DELETE' to confirm","placeholder":"Type DELETE","mandatory":true}},"action":{"type":"invoke.function","name":"handleForm"}};
	}
	else if(actionSubtype == "update")
	{
		// Get incident ID from button key (incident_update_INC-123456)
		incId = buttonKey.subString(16);
		// Remove "incident_update_"
		// Fetch incident details
		incidentQuery = Map();
		incidentQuery.put("criteria","incidentid==" + incId);
		incidentsResponse = zoho.cliq.getRecords("awsincidents",incidentQuery);
		currentStatus = "open";
		currentTitle = "";
		if(incidentsResponse != null && incidentsResponse.get("status") == "SUCCESS")
		{
			incidentList = incidentsResponse.get("list");
			if(incidentList != null && incidentList.size() > 0)
			{
				inc = incidentList.get(0);
				currentStatus = ifnull(inc.get("status"),"open");
				currentTitle = ifnull(inc.get("title"),"");
			}
		}
		// Return update form
		return {"type":"form","title":"‚úèÔ∏è Update Incident","hint":currentTitle,"name":"awsUpdateIncidentForm","button_label":"üíæ Update","inputs":{{"type":"hidden","name":"incidentId","value":incId},{"type":"select","name":"status","label":"Status","placeholder":"Select new status","mandatory":true,"value":currentStatus,"options":{{"value":"open","label":"üîµ Open"},{"value":"investigating","label":"üîç Investigating"},{"value":"resolved","label":"‚úÖ Resolved"},{"value":"closed","label":"üîí Closed"}}},{"type":"textarea","name":"notes","label":"Add Notes","placeholder":"Add any notes about this update...","mandatory":false}},"action":{"type":"invoke.function","name":"handleForm"}};
	}
}
// ============================================================================
// SECTION: CloudWatch Logs Actions
// ============================================================================
// Handles CloudWatch Logs querying button clicks:
//   - logs_refresh / logs_list        ‚Üí List log groups with pagination
//   - logs_group_<log-group-name>    ‚Üí View recent logs in group
//   - logs_errors_<log-group-name>   ‚Üí Search for errors in group
//   - logs_filter_<group>_<pattern>  ‚Üí Custom pattern search
//   - logs_streams_<log-group-name>  ‚Üí List log streams
//
// Supports pagination for large log result sets
// ============================================================================
else if(actionType == "logs")
{
	requestBody = Map();
	requestBody.put("service","logs");
	requestBody.put("userId",userId);
	requestBody.put("region",userRegion);
	// ---------------- LOGS REFRESH ----------------
	if(actionSubtype == "refresh" || actionSubtype == "list")
	{
		// Parse pagination from button key (format: logs_refresh|page|X or logs_list|page|X)
		page = 1;
		limit = 5;
		if(buttonKey.contains("|page|"))
		{
			pageIndex = buttonKey.indexOf("|page|");
			if(pageIndex != -1)
			{
				pageStr = buttonKey.subString(pageIndex + "|page|".length());
				try
				{
					page = pageStr.toLong();
				}
				catch(e)
				{
					page = 1;
				}
			}
		}
		requestBody.put("action","listGroups");
		requestBody.put("page",page);
		requestBody.put("limit",limit);
		apiResponse = invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		];
		if(apiResponse.get("success") == true)
		{
			data = apiResponse.get("data");
			logGroups = ifnull(data.get("logGroups"),data);
			pagination = ifnull(data.get("pagination"),Map());
			currentPage = ifnull(pagination.get("currentPage"),1);
			totalPages = ifnull(pagination.get("totalPages"),1);
			totalItems = ifnull(pagination.get("totalItems"),logGroups.size());
			hasPrev = ifnull(pagination.get("hasPrev"),false);
			hasNext = ifnull(pagination.get("hasNext"),false);
			
			if(logGroups.size() == 0)
			{
				response.put("text","*üìã Log Groups - No log groups found*");
				response.put("card",{"theme":"modern-inline"});
			}
			else
			{
				rows = List();
				lambdaCount = 0;
				apiGwCount = 0;
				otherCount = 0;
				for each  logGroup in logGroups
				{
					groupName = ifnull(logGroup.get("name"),"");
					// Count by type
					if(groupName.contains("/aws/lambda/"))
					{
						lambdaCount = lambdaCount + 1;
					}
					else if(groupName.contains("/aws/apigateway/"))
					{
						apiGwCount = apiGwCount + 1;
					}
					else
					{
						otherCount = otherCount + 1;
					}
					// Get display name
					displayName = groupName;
					if(groupName.contains("/"))
					{
						nameParts = groupName.toList("/");
						if(nameParts.size() > 0)
						{
							displayName = nameParts.get(nameParts.size() - 1);
						}
					}
					if(displayName.length() > 25)
					{
						displayName = displayName.subString(0,22) + "...";
					}
					// Determine icon
					typeIcon = "üìã";
					if(groupName.contains("/aws/lambda/"))
					{
						typeIcon = "‚ö°";
					}
					else if(groupName.contains("/aws/apigateway/"))
					{
						typeIcon = "üåê";
					}
					row = Map();
					row.put("Log Group",typeIcon + " " + displayName);
					row.put("Size",ifnull(logGroup.get("storedBytesFormatted"),"‚Äî"));
					// Encode log group name (replace / with ~)
					encodedName = groupName.replaceAll("/","~");
					row.put("Action","[+üìã View](invoke.function|handleButton||logs_view_" + encodedName + ")");
					rows.add(row);
				}
				
				pageText = "";
				if(totalPages > 1)
				{
					pageText = " (Page " + currentPage + " of " + totalPages + ")";
				}
				
				// Build buttons with pagination FIRST
				buttons = List();
				baseKey = "logs_refresh";
				if(totalPages > 1)
				{
					if(hasPrev)
					{
						buttons.add({"label":"‚¨ÖÔ∏è Previous","hint":"Go to previous page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage - 1)});
					}
					if(hasNext)
					{
						buttons.add({"label":"Next ‚û°Ô∏è","hint":"Go to next page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage + 1)});
					}
				}
				// Add other action buttons after pagination
				buttons.add({"label":"Refresh","hint":"Reload log groups","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"logs_refresh"});
				buttons.add({"label":"Summary","hint":"View logs summary","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"logs_summary"});
				
				response.put("text","*üìã Log Groups (" + totalItems + pageText + ")*");
				response.put("card",{"theme":"modern-inline"});
				response.put("slides",{{"type":"label","title":"Summary","data":{{"‚ö° Lambda":lambdaCount},{"üåê API Gateway":apiGwCount},{"üìã Other":otherCount}}},{"type":"table","title":"All Log Groups","data":{"headers":{"Log Group","Size","Action"},"rows":rows}}});
				response.put("buttons",buttons);
				response.put("navigation",true);
			}
		}
		else
		{
			response.put("text","üìã *Logs Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
			response.put("card",{"title":"üìã Logs Error","theme":"prompt"});
		}
	}
	// ---------------- LOGS VIEW ----------------
	else if(actionSubtype == "view")
	{
		// Reconstruct log group name from key parts
		logGroupName = buttonKey.subString(10);
		// Remove "logs_view_"
		// Decode log group name (replace ~ back to /)
		logGroupName = logGroupName.replaceAll("~","/");
		if(logGroupName != "")
		{
			requestBody.put("action","recent");
			requestBody.put("logGroupName",logGroupName);
			apiResponse = invokeurl
			[
				url :API_URL
				type :POST
				parameters:requestBody.toString()
				headers:{"Content-Type":"application/json"}
				connection:"awscloudcommander"
			];
			if(apiResponse.get("success") == true)
			{
				data = apiResponse.get("data");
				events = ifnull(data.get("events"),data);
				if(events.size() == 0)
				{
					response.put("text","*üìã No log entries found*\n\nNo recent logs in this group.");
					response.put("card",{"theme":"modern-inline"});
					response.put("buttons",{{"label":"Back","hint":"Return to log groups","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"logs_refresh"}});
				}
				else
				{
					logRows = List();
					for each  event in events
					{
						if(logRows.size() < 15)
						{
							message = ifnull(event.get("message"),"");
							if(message.length() > 80)
							{
								message = message.subString(0,77) + "...";
							}
							timestamp = ifnull(event.get("timestamp"),"");
							if(timestamp != "" && timestamp.contains("T"))
							{
								timeParts = timestamp.toList("T");
								if(timeParts.size() > 1)
								{
									timePart = timeParts.get(1);
									if(timePart.contains("."))
									{
										dotParts = timePart.toList(".");
										if(dotParts.size() > 0)
										{
											timePart = dotParts.get(0);
										}
									}
									timestamp = timePart;
								}
							}
							row = Map();
							row.put("Time",timestamp);
							row.put("Message",message);
							logRows.add(row);
						}
					}
					displayTitle = logGroupName;
					if(displayTitle.length() > 40)
					{
						displayTitle = "..." + displayTitle.subString(displayTitle.length() - 37);
					}
					response.put("text","*üìã Logs: " + displayTitle + "*");
					response.put("card",{"theme":"modern-inline"});
					response.put("slides",{{"type":"table","title":"Recent Entries (" + events.size() + ")","data":{"headers":{"Time","Message"},"rows":logRows}}});
					// Encode log group name for button keys (replace / with ~)
					encodedLogGroup = logGroupName.replaceAll("/","~");
					response.put("buttons",{{"label":"Errors Only","hint":"Filter for error logs","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"logs_errors_" + encodedLogGroup},{"label":"Refresh","hint":"Get latest logs","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"logs_view_" + encodedLogGroup},{"label":"Back","hint":"Return to log groups","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"logs_refresh"}});
				}
			}
			else
			{
				response.put("text","*Failed to get logs:* " + ifnull(apiResponse.get("error"),"Unknown error"));
			}
		}
	}
	// ---------------- LOGS ERRORS ----------------
	else if(actionSubtype == "errors")
	{
		logGroupName = buttonKey.subString(12);
		// Remove "logs_errors_"
		// Decode log group name (replace ~ back to /)
		logGroupName = logGroupName.replaceAll("~","/");
		if(logGroupName != "")
		{
			requestBody.put("action","errors");
			requestBody.put("logGroupName",logGroupName);
			apiResponse = invokeurl
			[
				url :API_URL
				type :POST
				parameters:requestBody.toString()
				headers:{"Content-Type":"application/json"}
				connection:"awscloudcommander"
			];
			if(apiResponse.get("success") == true)
			{
				data = apiResponse.get("data");
				events = ifnull(data.get("events"),data);
				if(events.size() == 0)
				{
					response.put("text","*‚úÖ No errors found!*\n\nNo error logs in the last hour.");
					response.put("card",{"theme":"modern-inline"});
				}
				else
				{
					logRows = List();
					for each  event in events
					{
						if(logRows.size() < 15)
						{
							message = ifnull(event.get("message"),"");
							if(message.length() > 80)
							{
								message = message.subString(0,77) + "...";
							}
							timestamp = ifnull(event.get("timestamp"),"");
							if(timestamp != "" && timestamp.contains("T"))
							{
								timeParts = timestamp.toList("T");
								if(timeParts.size() > 1)
								{
									timePart = timeParts.get(1);
									if(timePart.contains("."))
									{
										dotParts = timePart.toList(".");
										if(dotParts.size() > 0)
										{
											timePart = dotParts.get(0);
										}
									}
									timestamp = timePart;
								}
							}
							row = Map();
							row.put("Time",timestamp);
							row.put("Error",message);
							logRows.add(row);
						}
					}
					response.put("text","*üî¥ Error Logs (" + events.size() + " found)*");
					response.put("card",{"theme":"modern-inline"});
					response.put("slides",{{"type":"table","title":"","data":{"headers":{"Time","Error"},"rows":logRows}}});
				}
				// Encode log group name for button keys (replace / with ~)
				encodedLogGroup = logGroupName.replaceAll("/","~");
				response.put("buttons",{{"label":"All Logs","hint":"View all recent logs","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"logs_view_" + encodedLogGroup},{"label":"Back","hint":"Return to log groups","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"logs_refresh"}});
			}
			else
			{
				response.put("text","*Failed to get error logs:* " + ifnull(apiResponse.get("error"),"Unknown error"));
			}
		}
	}
	// ---------------- LOGS SUMMARY ----------------
	else if(actionSubtype == "summary")
	{
		requestBody.put("action","summary");
		apiResponse = invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		];
		if(apiResponse.get("success") == true)
		{
			data = apiResponse.get("data");
			totalGroups = ifnull(data.get("totalLogGroups"),0);
			totalSize = ifnull(data.get("totalStoredBytesFormatted"),"0 B");
			response.put("text","*üìã Logs Summary*");
			response.put("card",{"theme":"modern-inline"});
			response.put("slides",{{"type":"label","title":"Overview","data":{{"üìã Total Log Groups":totalGroups},{"üíæ Total Storage":totalSize}}}});
			response.put("buttons",{{"label":"View All","hint":"View all log groups","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"logs_refresh"}});
		}
		else
		{
			response.put("text","üìã *Logs Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
			response.put("card",{"title":"üìã Logs Error","theme":"prompt"});
		}
	}
	else
	{
		response.put("text","üìã *Unknown logs action:* " + actionSubtype);
		response.put("card",{"title":"üìã Logs Error","theme":"prompt"});
	}
}
// ============================================================================
// HEALTH CHECK ACTION
// ============================================================================
else if(actionType == "health" || buttonKey == "health_check")
{
	requestBody = Map();
	requestBody.put("service","health");
	requestBody.put("userId",userId);
	apiResponse = invokeurl
	[
		url :API_URL
		type :POST
		parameters:requestBody.toString()
		headers:{"Content-Type":"application/json"}
		connection:"awscloudcommander"
	];
	if(apiResponse.get("success") == true)
	{
		data = apiResponse.get("data");
		statusEmoji = "üî¥";
		if(data.get("status") == "healthy" || data.get("status") == "ok")
		{
			statusEmoji = "üü¢";
		}
		response.put("text","*üîß System Status*");
		response.put("card",{"theme":"modern-inline"});
		response.put("slides",{{"type":"label","title":"Backend Health","data":{{"Status":statusEmoji + " " + data.get("status")},{"Service":ifnull(data.get("service"),"aws-cloud-commander")},{"Version":ifnull(data.get("version"),"1.0.0")},{"Region":ifnull(data.get("region"),"‚Äî")},{"Bedrock Region":ifnull(data.get("bedrockRegion"),"‚Äî")}}}});
		response.put("buttons",{{"label":"Refresh","hint":"Check status again","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"health_check"},{"label":"Permissions","hint":"Check IAM permissions","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"permissions_check"}});
	}
	else
	{
		response.put("text","*Backend unavailable:* " + ifnull(apiResponse.get("error"),"Connection failed"));
		response.put("card",{"theme":"modern-inline"});
		response.put("buttons",{{"label":"Retry","hint":"Try connecting again","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"health_check"}});
	}
}
// ============================================================================
// SECTION: IAM Permissions Check Actions
// ============================================================================
// Handles IAM permission auditing button clicks:
//   - permissions_check ‚Üí Check IAM permissions for all AWS services
//   - permissions_policy ‚Üí Show recommended IAM policy
//
// Helps users identify missing permissions for various AWS operations
// ============================================================================
else if(actionType == "permissions" || buttonKey == "permissions_check" || buttonKey == "permissions_policy")
{
	requestBody = Map();
	requestBody.put("service","permissions");
	requestBody.put("userId",userId);
	// ---------------- GET POLICY ----------------
	if(actionSubtype == "policy" || buttonKey == "permissions_policy")
	{
		requestBody.put("action","getRequiredPolicy");
		apiResponse = invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		];
		if(apiResponse.get("success") == true)
		{
			data = apiResponse.get("data");
			// Build formatted JSON policy string manually
			policyJson = "{\n";
			policyJson = policyJson + "  \"Version\": \"" + ifnull(data.get("Version"),"2012-10-17") + "\",\n";
			policyJson = policyJson + "  \"Statement\": [\n";
			statements = ifnull(data.get("Statement"),List());
			stmtCount = statements.size();
			stmtIndex = 0;
			for each  stmt in statements
			{
				stmtIndex = stmtIndex + 1;
				policyJson = policyJson + "    {\n";
				policyJson = policyJson + "      \"Sid\": \"" + ifnull(stmt.get("Sid"),"") + "\",\n";
				policyJson = policyJson + "      \"Effect\": \"" + ifnull(stmt.get("Effect"),"Allow") + "\",\n";
				policyJson = policyJson + "      \"Action\": [\n";
				actions = ifnull(stmt.get("Action"),List());
				actionCount = actions.size();
				actionIndex = 0;
				for each  action in actions
				{
					actionIndex = actionIndex + 1;
					if(actionIndex < actionCount)
					{
						policyJson = policyJson + "        \"" + action + "\",\n";
					}
					else
					{
						policyJson = policyJson + "        \"" + action + "\"\n";
					}
				}
				policyJson = policyJson + "      ],\n";
				policyJson = policyJson + "      \"Resource\": \"" + ifnull(stmt.get("Resource"),"*") + "\"\n";
				if(stmtIndex < stmtCount)
				{
					policyJson = policyJson + "    },\n";
				}
				else
				{
					policyJson = policyJson + "    }\n";
				}
			}
			policyJson = policyJson + "  ]\n";
			policyJson = policyJson + "}";
			// Format in code block
			policyText = "```json\n" + policyJson + "\n```";
			response.put("text","*üìã Required IAM Policy*\n\nCopy and paste this policy into your IAM console:\n\n" + policyText);
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"Check Permissions","hint":"Verify current permissions","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"permissions_check"},{"label":"Back","hint":"Return to status","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"health_check"}});
		}
		else
		{
			response.put("text","üîê *Policy Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
			response.put("card",{"title":"üîê Policy Error","theme":"prompt"});
		}
	}
	// ---------------- CHECK PERMISSIONS ----------------
	else
	{
		requestBody.put("action","checkAll");
		apiResponse = invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		];
		if(apiResponse.get("success") == true)
		{
			data = apiResponse.get("data");
			permissions = ifnull(data.get("permissions"),Map());
			summary = ifnull(data.get("summary"),Map());
			permRows = List();
			passedCount = 0;
			failedCount = 0;
			skippedCount = 0;
			for each  permKey in permissions.keys()
			{
				permValue = permissions.get(permKey);
				permStatus = ifnull(permValue.get("status"),"unknown");
				permName = ifnull(permValue.get("name"),permKey);
				statusIcon = "‚ùì";
				if(permStatus == "granted")
				{
					statusIcon = "‚úÖ";
					passedCount = passedCount + 1;
				}
				else if(permStatus == "denied")
				{
					statusIcon = "‚ùå";
					failedCount = failedCount + 1;
				}
				else if(permStatus == "skipped")
				{
					statusIcon = "‚è≠Ô∏è";
					skippedCount = skippedCount + 1;
				}
				row = Map();
				row.put("Permission",permName);
				row.put("Status",statusIcon);
				permRows.add(row);
			}
			response.put("text","*üîê IAM Permissions*");
			response.put("card",{"theme":"modern-inline"});
			response.put("slides",{{"type":"label","title":"Summary","data":{{"‚úÖ Granted":passedCount},{"‚ùå Denied":failedCount},{"‚è≠Ô∏è Skipped":skippedCount}}},{"type":"table","title":"Permission Status","data":{"headers":{"Permission","Status"},"rows":permRows}}});
			response.put("buttons",{{"label":"Refresh","hint":"Check permissions again","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"permissions_check"},{"label":"Get Policy","hint":"View required IAM policy","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"permissions_policy"}});
		}
		else
		{
			response.put("text","üîê *Permissions Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
			response.put("card",{"title":"üîê Permissions Error","theme":"prompt"});
		}
	}
}
// ============================================================================
// SECTION: Dashboard Navigation Actions
// ============================================================================
// Handles main dashboard display:
//   - dashboard ‚Üí Shows interactive AWS resource overview
//
// Displays EC2, S3, Lambda, and CloudWatch alarm summaries with action buttons
// ============================================================================
else if(actionType == "dashboard" || buttonKey == "dashboard")
{
	requestBody = Map();
	requestBody.put("service","dashboard");
	requestBody.put("action","overview");
	requestBody.put("userId",userId);
	requestBody.put("region",userRegion);
	apiResponse = invokeurl
	[
		url :API_URL
		type :POST
		parameters:requestBody.toString()
		headers:{"Content-Type":"application/json"}
		connection:"awscloudcommander"
	];
	// Safely check API response
	apiSuccess = false;
	if(apiResponse != null)
	{
		apiSuccess = ifnull(apiResponse.get("success"),false);
	}
	if(apiSuccess == true)
	{
		data = apiResponse.get("data");
		// Extract data safely
		ec2Total = 0;
		ec2Running = 0;
		ec2Stopped = 0;
		s3Total = 0;
		lambdaTotal = 0;
		alarmsActive = 0;
		alarmsOk = 0;
		if(data != null)
		{
			ec2Data = ifnull(data.get("ec2"),Map());
			if(ec2Data != null)
			{
				ec2Total = ifnull(ec2Data.get("total"),0);
				ec2Running = ifnull(ec2Data.get("running"),0);
				ec2Stopped = ifnull(ec2Data.get("stopped"),0);
			}
			s3Data = ifnull(data.get("s3"),Map());
			if(s3Data != null)
			{
				s3Total = ifnull(s3Data.get("totalBuckets"),0);
			}
			lambdaData = ifnull(data.get("lambda"),Map());
			if(lambdaData != null)
			{
				lambdaTotal = ifnull(lambdaData.get("total"),0);
			}
			alarmsData = ifnull(data.get("alarms"),Map());
			if(alarmsData != null)
			{
				alarmStates = ifnull(alarmsData.get("byState"),Map());
				if(alarmStates != null)
				{
					alarmsActive = ifnull(alarmStates.get("ALARM"),0);
					alarmsOk = ifnull(alarmStates.get("OK"),0);
				}
			}
		}
		response.put("text","*‚òÅÔ∏è AWS Dashboard*");
		response.put("card",{"theme":"modern-inline"});
		response.put("slides",{{"type":"label","title":"üñ•Ô∏è Compute","data":{{"EC2 Instances":ec2Total + " total"},{"Running":"üü¢ " + ec2Running},{"Stopped":"üî¥ " + ec2Stopped}}},{"type":"label","title":"üì¶ Storage & Functions","data":{{"S3 Buckets":s3Total},{"Lambda Functions":lambdaTotal}}},{"type":"label","title":"üîî Alarms","data":{{"Active":"üî¥ " + alarmsActive},{"OK":"üü¢ " + alarmsOk}}}});
		response.put("buttons",{{"label":"EC2","hint":"View EC2 instances","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ec2_refresh"},{"label":"S3","hint":"View S3 buckets","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"s3_refresh"},{"label":"Costs","hint":"View cost report","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"cost_week"},{"label":"Logs","hint":"View CloudWatch logs","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"logs_refresh"}});
	}
	else
	{
		apiError = "Connection failed";
		if(apiResponse != null)
		{
			apiError = ifnull(apiResponse.get("error"),"Unknown error");
		}
		response.put("text","‚òÅÔ∏è *Dashboard Error*\n\n" + apiError);
		response.put("card",{"title":"‚òÅÔ∏è Dashboard Error","theme":"prompt"});
		response.put("buttons",{{"label":"Retry","hint":"Try loading dashboard again","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"},{"label":"Check Status","hint":"Test backend connection","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"health_check"}});
	}
}
// ============================================================================
// SECTION: Help & Documentation Actions
// ============================================================================
// Handles help and command reference display:
//   - help / help_show ‚Üí Shows complete command reference
//
// Displays all available /aws commands organized by service category
// ============================================================================
else if(actionType == "help" || buttonKey == "help_show")
{
	// Build full comprehensive help text
	helpText = "*‚òÅÔ∏è AWS Cloud Commander - Complete Command Reference*\n\n";
	// Quick Start
	helpText = helpText + "*üöÄ QUICK START*\n";
	helpText = helpText + "‚Ä¢ `/aws` - Open main dashboard with resource overview\n";
	helpText = helpText + "‚Ä¢ `/aws help` - Show this help guide\n";
	helpText = helpText + "‚Ä¢ `/aws status` - Check backend connection health\n\n";
	// EC2 Commands
	helpText = helpText + "*üñ•Ô∏è EC2 INSTANCES*\n";
	helpText = helpText + "‚Ä¢ `/aws ec2` - List all EC2 instances with status\n";
	helpText = helpText + "‚Ä¢ `/aws ec2 <instance-id>` - Get details for specific instance\n";
	helpText = helpText + "‚Ä¢ `/aws ec2 start <instance-id>` - Start a stopped instance\n";
	helpText = helpText + "‚Ä¢ `/aws ec2 stop <instance-id>` - Stop a running instance\n";
	helpText = helpText + "‚Ä¢ `/aws ec2 reboot <instance-id>` - Reboot an instance\n";
	helpText = helpText + "‚Ä¢ `/aws ec2 metrics <instance-id>` - View CPU, network, disk metrics\n";
	helpText = helpText + "‚Ä¢ `/aws ec2 summary` - Overview of all instances by state\n\n";
	// S3 Commands
	helpText = helpText + "*üì¶ S3 STORAGE*\n";
	helpText = helpText + "‚Ä¢ `/aws s3` - List all S3 buckets\n";
	helpText = helpText + "‚Ä¢ `/aws s3 create` - Open bucket creation form\n";
	helpText = helpText + "‚Ä¢ `/aws s3 browse <bucket-name>` - Browse bucket contents\n";
	helpText = helpText + "‚Ä¢ `/aws s3 search <bucket> <term>` - Search files in bucket\n";
	helpText = helpText + "‚Ä¢ `/aws s3 download <bucket> <file>` - Get download link\n\n";
	// Lambda Commands
	helpText = helpText + "*‚ö° LAMBDA FUNCTIONS*\n";
	helpText = helpText + "‚Ä¢ `/aws lambda` - List all Lambda functions\n";
	helpText = helpText + "‚Ä¢ `/aws lambda summary` - Overview with runtime stats\n";
	helpText = helpText + "‚Ä¢ `/aws lambda invoke <name>` - Invoke a function (requires consent)\n\n";
	// RDS Commands
	helpText = helpText + "*üóÑÔ∏è RDS DATABASES*\n";
	helpText = helpText + "‚Ä¢ `/aws rds` - List all RDS database instances\n";
	helpText = helpText + "‚Ä¢ `/aws rds start <db-id>` - Start a stopped database\n";
	helpText = helpText + "‚Ä¢ `/aws rds stop <db-id>` - Stop a running database\n";
	helpText = helpText + "‚Ä¢ `/aws rds clusters` - List Aurora clusters\n\n";
	// SNS Commands
	helpText = helpText + "*üì® SNS MESSAGING*\n";
	helpText = helpText + "‚Ä¢ `/aws sns` - List all SNS topics\n";
	helpText = helpText + "‚Ä¢ `/aws sns subs` - List all subscriptions\n";
	helpText = helpText + "‚Ä¢ `/aws sns publish <topic-arn>` - Publish message (requires consent)\n\n";
	// CloudWatch Alarms
	helpText = helpText + "*üîî CLOUDWATCH ALARMS*\n";
	helpText = helpText + "‚Ä¢ `/aws alarms` - List all CloudWatch alarms\n";
	helpText = helpText + "‚Ä¢ `/aws alarms active` - Show only alarms in ALARM state\n";
	helpText = helpText + "‚Ä¢ `/aws alarms history` - View alarm state history\n\n";
	// CloudWatch Logs
	helpText = helpText + "*üìã CLOUDWATCH LOGS*\n";
	helpText = helpText + "‚Ä¢ `/aws logs` - List all log groups\n";
	helpText = helpText + "‚Ä¢ `/aws logs <log-group>` - View recent logs in a group\n";
	helpText = helpText + "‚Ä¢ `/aws logs <log-group> errors` - Search errors in a group\n";
	helpText = helpText + "‚Ä¢ `/aws logs filter <log-group> <pattern>` - Search with pattern\n";
	helpText = helpText + "‚Ä¢ `/aws logs summary` - Logs overview\n\n";
	// Cost Explorer
	helpText = helpText + "*üí∞ COST EXPLORER* (requires consent)\n";
	helpText = helpText + "‚Ä¢ `/aws cost` - View today's costs\n";
	helpText = helpText + "‚Ä¢ `/aws cost week` - Last 7 days costs\n";
	helpText = helpText + "‚Ä¢ `/aws cost month` - Month-to-date costs\n";
	helpText = helpText + "‚Ä¢ `/aws cost forecast` - Predicted monthly spend\n\n";
	// IAM Commands
	helpText = helpText + "*üîê IAM SECURITY*\n";
	helpText = helpText + "‚Ä¢ `/aws iam` - IAM overview\n";
	helpText = helpText + "‚Ä¢ `/aws iam users` - List IAM users\n";
	helpText = helpText + "‚Ä¢ `/aws iam roles` - List IAM roles\n";
	helpText = helpText + "‚Ä¢ `/aws iam security` - Security recommendations\n\n";
	// AI Assistant
	helpText = helpText + "*ü§ñ AI ASSISTANT* (requires consent)\n";
	helpText = helpText + "‚Ä¢ `/aws ai <question>` - Ask AWS questions\n\n";
	// Settings & Admin
	helpText = helpText + "*‚öôÔ∏è SETTINGS & ADMIN*\n";
	helpText = helpText + "‚Ä¢ Settings - Access via Bot Menu (‚öôÔ∏è icon)\n";
	helpText = helpText + "‚Ä¢ Reset Setup - Access via Bot Menu (üîÑ icon)\n";
	helpText = helpText + "‚Ä¢ `/aws consent` - View/toggle consent for paid APIs\n\n";
	// Tips
	helpText = helpText + "*üí° TIPS*\n";
	helpText = helpText + "‚Ä¢ Use `/aws consent` to enable paid API features\n";
	helpText = helpText + "‚Ä¢ Configure notifications via Bot Menu ‚Üí Settings";
	response.put("text",helpText);
	response.put("card",{"theme":"modern-inline"});
}
// ============================================================================
// SECTION: Lambda Function Management Actions
// ============================================================================
// Handles Lambda-related button clicks:
//   - lambda_list / lambda_refresh ‚Üí List functions with pagination
//   - lambda_invoke_<function-name> ‚Üí Invoke function (requires consent)
//   - lambda_get_<function-name>    ‚Üí Show function details
//
// Note: Invocation requires user consent (consentlambda flag)
// ============================================================================
else if(actionType == "lambda")
{
	// ---------------- LAMBDA LIST ----------------
	if(actionSubtype == "" || actionSubtype == "list" || buttonKey == "lambda_list")
	{
		// Parse pagination from button key (format: lambda_list|page|X)
		pageNum = 1;
		limitNum = 5;
		if(buttonKey.contains("|page|"))
		{
			pageParts = buttonKey.toList("|page|");
			if(pageParts.size() > 1)
			{
				try
				{
					pageNum = pageParts.get(1).toLong();
				}
				catch(e)
				{
					pageNum = 1;
				}
			}
		}
		requestBody = Map();
		requestBody.put("service","lambda");
		requestBody.put("userId",userId);
		requestBody.put("region",userRegion);
		requestBody.put("action","list");
		requestBody.put("page",pageNum);
		requestBody.put("limit",limitNum);
		apiResponse = invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		];
		if(apiResponse.get("success") == true)
		{
			data = apiResponse.get("data");
			// Extract functions array and pagination metadata
			functions = ifnull(data.get("functions"),data);
			pagination = ifnull(data.get("pagination"),Map());
			currentPage = ifnull(pagination.get("currentPage"),1);
			totalPages = ifnull(pagination.get("totalPages"),1);
			totalItems = ifnull(pagination.get("totalItems"),functions.size());
			hasPrev = ifnull(pagination.get("hasPrev"),false);
			hasNext = ifnull(pagination.get("hasNext"),false);
			
			if(functions.size() == 0)
			{
				return {"text":"*‚ö° Lambda Functions*\n\nüì≠ No functions found in this region.","card":{"theme":"modern-inline"},"buttons":{{"label":"üîÑ Refresh","hint":"Reload functions","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"lambda_list"},{"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}},"navigation":true};
			}
			else
			{
				// Build table rows
				rows = List();
				for each  func in functions
				{
					funcName = ifnull(func.get("name"),"");
					runtime = ifnull(func.get("runtime"),"");
					memory = ifnull(func.get("memory"),"");
					timeout = ifnull(func.get("timeout"),"");
					row = Map();
					row.put("Function","*" + funcName + "*\n`" + runtime + "`");
					row.put("Config",memory + " MB / " + timeout + "s");
					row.put("Actions","[+‚ÑπÔ∏è Details](invoke.function|handleButton||lambda_info_" + funcName + ") [+üìã Logs](invoke.function|handleButton||lambda_logs_" + funcName + ")");
					rows.add(row);
				}
				
				pageText = "";
				if(totalPages > 1)
				{
					pageText = " (Page " + currentPage + " of " + totalPages + ")";
				}
				
				// Build buttons with pagination FIRST
				buttons = List();
				baseKey = "lambda_list";
				if(totalPages > 1)
				{
					if(hasPrev)
					{
						buttons.add({"label":"‚¨ÖÔ∏è Previous","hint":"Go to previous page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage - 1)});
					}
					if(hasNext)
					{
						buttons.add({"label":"Next ‚û°Ô∏è","hint":"Go to next page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage + 1)});
					}
				}
				// Add other action buttons after pagination
				buttons.add({"label":"üîÑ Refresh","hint":"Reload functions","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"lambda_list"});
				buttons.add({"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"});
				
				// Return directly like EC2 does
				return {"text":"*‚ö° Lambda Functions (" + totalItems + pageText + ")*","card":{"theme":"modern-inline"},"slides":{{"type":"table","title":"All Functions","data":{"headers":{"Function","Config","Actions"},"rows":rows}}},"buttons":buttons,"navigation":true};
			}
		}
		else
		{
			return {"text":"‚ö° *Lambda Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"),"card":{"title":"‚ö° Lambda Error","theme":"prompt"}};
		}
	}
	// ---------------- LAMBDA INFO/DETAILS ----------------
	else if(actionSubtype == "info" || actionSubtype == "details" || actionSubtype == "get")
	{
		funcName = keyPart2;
		if(funcName != "")
		{
			requestBody = Map();
			requestBody.put("service","lambda");
			requestBody.put("userId",userId);
			requestBody.put("region",userRegion);
			requestBody.put("action","get");
			requestBody.put("functionName",funcName);
			apiResponse = invokeurl
			[
				url :API_URL
				type :POST
				parameters:requestBody.toString()
				headers:{"Content-Type":"application/json"}
				connection:"awscloudcommander"
			];
			if(apiResponse.get("success") == true)
			{
				func = apiResponse.get("data");
				funcName = ifnull(func.get("name"),"Function");
				runtime = ifnull(func.get("runtime"),"‚Äî");
				handler = ifnull(func.get("handler"),"‚Äî");
				memory = ifnull(func.get("memory"),"‚Äî");
				timeout = ifnull(func.get("timeout"),"‚Äî");
				codeSize = ifnull(func.get("codeSizeFormatted"),"‚Äî");
				state = ifnull(func.get("state"),"Active");
				lastMod = ifnull(func.get("lastModified"),"‚Äî");
				desc = ifnull(func.get("description"),"No description");
				packageType = ifnull(func.get("packageType"),"Zip");
				arch = "x86_64";
				architectures = func.get("architectures");
				if(architectures != null && architectures.size() > 0)
				{
					arch = architectures.get(0);
				}
				// Format last modified
				if(lastMod != "‚Äî" && lastMod.contains("T"))
				{
					lastMod = lastMod.getPrefix("T");
				}
				// State emoji
				stateEmoji = "üü¢";
				if(state != "Active")
				{
					stateEmoji = "üü°";
				}
				// Environment variables count
				envVars = func.get("environment");
				envCount = 0;
				if(envVars != null)
				{
					envCount = envVars.size();
				}
				// Layers count
				layers = func.get("layers");
				layerCount = 0;
				if(layers != null)
				{
					layerCount = layers.size();
				}
				// VPC info
				vpcInfo = "No VPC";
				vpcConfig = func.get("vpcConfig");
				if(vpcConfig != null)
				{
					vpcId = vpcConfig.get("vpcId");
					if(vpcId != null && vpcId != "")
					{
						vpcInfo = vpcId;
					}
				}
				response.put("text","*‚ö° " + funcName + "*");
				response.put("card",{"title":"‚ö° " + funcName,"theme":"modern-inline"});
				response.put("slides",{{"type":"label","title":"Configuration","data":{{"Runtime":runtime},{"Handler":handler},{"Memory":memory + " MB"},{"Timeout":timeout + "s"},{"Architecture":arch}}},{"type":"label","title":"Details","data":{{"State":stateEmoji + " " + state},{"Code Size":codeSize},{"Package":packageType},{"Env Vars":envCount + " variables"},{"Layers":layerCount + " layers"},{"VPC":vpcInfo},{"Modified":lastMod}}}});
				response.put("buttons",{{"label":"‚ñ∂Ô∏è Invoke","hint":"Run this function","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"lambda_invoke_" + funcName},{"label":"üìã Logs","hint":"View function logs","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"lambda_logs_" + funcName},{"label":"üìã List All","hint":"View all functions","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"lambda_list"}});
				response.put("navigation",true);
			}
			else
			{
				response.put("text","‚ö° *Lambda Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
				response.put("card",{"title":"‚ö° Lambda Error","theme":"prompt"});
			}
		}
		else
		{
			response.put("text","‚ö° *Error*\n\nFunction name required");
			response.put("card",{"title":"‚ö° Lambda Error","theme":"prompt"});
		}
	}
	// ---------------- LAMBDA LOGS ----------------
	else if(actionSubtype == "logs")
	{
		funcName = keyPart2;
		if(funcName != "")
		{
			// Lambda logs are stored in CloudWatch under /aws/lambda/<function-name>
			logGroupName = "/aws/lambda/" + funcName;
			requestBody = Map();
			requestBody.put("service","logs");
			requestBody.put("userId",userId);
			requestBody.put("action","lambdaLogs");
			requestBody.put("functionName",funcName);
			apiResponse = invokeurl
			[
				url :API_URL
				type :POST
				parameters:requestBody.toString()
				headers:{"Content-Type":"application/json"}
				connection:"awscloudcommander"
			];
			if(apiResponse.get("success") == true)
			{
				data = apiResponse.get("data");
				events = ifnull(data.get("events"),List());
				if(events.size() == 0)
				{
					response.put("text","*üìã Logs: " + funcName + "*\n\nNo recent logs found.");
					response.put("card",{"title":"üìã " + funcName + " Logs","theme":"modern-inline"});
				}
				else
				{
					// Build log entries
					logRows = List();
					for each  event in events
					{
						if(logRows.size() < 15)
						{
							message = ifnull(event.get("message"),"");
							timestamp = ifnull(event.get("timestamp"),"");
							// Truncate long messages
							if(message.length() > 80)
							{
								message = message.subString(0,77) + "...";
							}
							// Format timestamp
							if(timestamp.contains("T"))
							{
								timePart = timestamp.toList("T").get(1);
								if(timePart.contains("."))
								{
									timePart = timePart.toList(".").get(0);
								}
								timestamp = timePart;
							}
							row = Map();
							row.put("Time",timestamp);
							row.put("Message",message);
							logRows.add(row);
						}
					}
					response.put("text","*üìã Logs: " + funcName + "* (" + events.size() + " entries)");
					response.put("card",{"title":"üìã " + funcName + " Logs","theme":"modern-inline"});
					response.put("slides",{{"type":"table","title":"Recent Logs","data":{"headers":{"Time","Message"},"rows":logRows}}});
				}
				response.put("buttons",{{"label":"üîÑ Refresh","hint":"Get latest logs","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"lambda_logs_" + funcName},{"label":"‚ÑπÔ∏è Details","hint":"View function details","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"lambda_info_" + funcName},{"label":"üìã List All","hint":"View all functions","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"lambda_list"}});
				response.put("navigation",true);
			}
			else
			{
				response.put("text","üìã *Logs Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
				response.put("card",{"title":"üìã Logs Error","theme":"prompt"});
			}
		}
		else
		{
			response.put("text","‚ö° *Error*\n\nFunction name required");
			response.put("card",{"title":"‚ö° Lambda Error","theme":"prompt"});
		}
	}
	// ---------------- LAMBDA INVOKE ----------------
	else if(actionSubtype == "invoke")
	{
		funcName = keyPart2;
		if(funcName != "")
		{
			// Check consent for Lambda invocation
			queryMap = Map();
			queryMap.put("criteria","userid==" + userId);
			userPrefs = zoho.cliq.getRecords("awsprefs",queryMap);
			hasLambdaConsent = false;
			if(userPrefs != null && userPrefs.get("status") == "SUCCESS")
			{
				prefList = userPrefs.get("list");
				if(prefList != null && prefList.size() > 0)
				{
					pref = prefList.get(0);
					if(pref != null)
					{
						consentValue = pref.get("consentlambda");
						if(consentValue == true || consentValue == "true" || consentValue == 1 || consentValue == "1")
						{
							hasLambdaConsent = true;
						}
					}
				}
			}
			if(hasLambdaConsent == false)
			{
				// No consent - show consent prompt
				return {"text":"*‚ö†Ô∏è Lambda Invocation Requires Consent*\n\nInvoking Lambda functions uses your *AWS Lambda quota* and may incur costs.\n\nüí∞ *Pricing:*\n‚Ä¢ Depends on your Lambda function configuration\n‚Ä¢ Uses your AWS account's Lambda quota\n\nEnable Lambda invocation in Bot Menu ‚Üí Settings or click below.","card":{"theme":"modern-inline"},"buttons":{{"label":"‚ö° Enable Lambda","hint":"Grant consent for Lambda invocation","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"consent_grant_lambda_invoke"},{"label":"üìã List Functions","hint":"View functions without invoking","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"lambda_list"}},"navigation":true};
			}
			// User has consent - show invoke form
			return {"type":"form","title":"‚ñ∂Ô∏è Invoke " + funcName,"hint":"Run this Lambda function","name":"awsLambdaInvokeForm","button_label":"‚ñ∂Ô∏è Invoke Function","inputs":{{"type":"hidden","name":"functionName","value":funcName},{"type":"textarea","name":"payload","label":"Payload (JSON)","placeholder":"Optional: Enter JSON payload, e.g. {\"key\": \"value\"}","mandatory":false},{"type":"select","name":"invocationType","label":"Invocation Type","placeholder":"Select invocation type","mandatory":true,"value":"RequestResponse","options":{{"value":"RequestResponse","label":"Synchronous (wait for response)"},{"value":"Event","label":"Asynchronous (fire and forget)"},{"value":"DryRun","label":"Dry Run (validate only)"}}}},"action":{"type":"invoke.function","name":"handleForm"}};
		}
		else
		{
			response.put("text","‚ö° *Error*\n\nFunction name required");
			response.put("card",{"title":"‚ö° Lambda Error","theme":"prompt"});
		}
	}
	// ---------------- DEFAULT LAMBDA (list) ----------------
	else
	{
		// Default to list
		requestBody = Map();
		requestBody.put("service","lambda");
		requestBody.put("userId",userId);
		requestBody.put("region",userRegion);
		requestBody.put("action","list");
		apiResponse = invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		];
		if(apiResponse.get("success") == true)
		{
			data = apiResponse.get("data");
			if(data.size() == 0)
			{
				return {"text":"*‚ö° Lambda Functions - No functions found*","card":{"theme":"modern-inline"},"buttons":{{"label":"üîÑ Refresh","hint":"Reload","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"lambda_list"}},"navigation":true};
			}
			else
			{
				rows = List();
				for each  func in data
				{
					funcName = ifnull(func.get("name"),"");
					row = Map();
					row.put("Function","*" + funcName + "*");
					row.put("Runtime",ifnull(func.get("runtime"),""));
					row.put("Actions","[+‚ÑπÔ∏è](invoke.function|handleButton||lambda_info_" + funcName + ")");
					rows.add(row);
				}
				return {"text":"*‚ö° Lambda Functions (" + data.size() + ")*","card":{"theme":"modern-inline"},"slides":{{"type":"table","title":"","data":{"headers":{"Function","Runtime","Actions"},"rows":rows}}},"buttons":{{"label":"üîÑ Refresh","hint":"Reload","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"lambda_list"}},"navigation":true};
			}
		}
		else
		{
			return {"text":"‚ö° *Lambda Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"),"card":{"title":"‚ö° Lambda Error","theme":"prompt"}};
		}
	}
}
// Keep the original buttonKey match for dashboard button
else if(buttonKey == "lambda_list")
{
	requestBody = Map();
	requestBody.put("service","lambda");
	requestBody.put("userId",userId);
	requestBody.put("action","list");
	apiResponse = invokeurl
	[
		url :API_URL
		type :POST
		parameters:requestBody.toString()
		headers:{"Content-Type":"application/json"}
		connection:"awscloudcommander"
	];
	if(apiResponse.get("success") == true)
	{
		data = apiResponse.get("data");
		if(data.size() == 0)
		{
			return {"text":"*‚ö° Lambda Functions - No functions found*","card":{"theme":"modern-inline"},"buttons":{{"label":"üîÑ Refresh","hint":"Reload functions","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"lambda_list"},{"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}},"navigation":true};
		}
		else
		{
			rows = List();
			for each  func in data
			{
				funcName = ifnull(func.get("name"),"");
				row = Map();
				row.put("Function","*" + funcName + "*\n`" + ifnull(func.get("runtime"),"") + "`");
				row.put("Config",ifnull(func.get("memory"),"") + " MB / " + ifnull(func.get("timeout"),"") + "s");
				row.put("Actions","[+‚ÑπÔ∏è Details](invoke.function|handleButton||lambda_info_" + funcName + ") [+üìã Logs](invoke.function|handleButton||lambda_logs_" + funcName + ")");
				rows.add(row);
			}
			return {"text":"*‚ö° Lambda Functions (" + data.size() + ")*","card":{"theme":"modern-inline"},"slides":{{"type":"table","title":"All Functions","data":{"headers":{"Function","Config","Actions"},"rows":rows}}},"buttons":{{"label":"üîÑ Refresh","hint":"Reload functions","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"lambda_list"},{"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}},"navigation":true};
		}
	}
	else
	{
		return {"text":"‚ö° *Lambda Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"),"card":{"title":"‚ö° Lambda Error","theme":"prompt"}};
	}
}
// ============================================================================
// SECTION: CloudWatch Alarms Actions
// ============================================================================
// Handles CloudWatch alarm monitoring button clicks:
//   - alarms_list / alarms_refresh ‚Üí List all alarms with pagination
//   - alarms_active                 ‚Üí Show only alarms in ALARM state
//   - alarms_delete_<alarm-name>   ‚Üí Delete alarm (with confirmation)
//
// Integrates with dynamic notification system for alarm state changes
// ============================================================================
else if(actionType == "alarms" || buttonKey == "alarms_list" || (buttonKey.contains("alarms_list") && buttonKey.contains("|page|")))
{
	// Parse pagination from button key (format: alarms_list|page|X)
	pageNum = 1;
	limitNum = 5;
	if(buttonKey.contains("|page|"))
	{
		pageParts = buttonKey.toList("|page|");
		if(pageParts.size() > 1)
		{
			try
			{
				pageNum = pageParts.get(1).toLong();
			}
			catch(e)
			{
				pageNum = 1;
			}
		}
	}
	requestBody = Map();
	requestBody.put("service","cloudwatch");
	requestBody.put("userId",userId);
	requestBody.put("region",userRegion);
	requestBody.put("action","listAlarms");
	requestBody.put("page",pageNum);
	requestBody.put("limit",limitNum);
	apiResponse = invokeurl
	[
		url :API_URL
		type :POST
		parameters:requestBody.toString()
		headers:{"Content-Type":"application/json"}
		connection:"awscloudcommander"
	];
	if(apiResponse.get("success") == true)
	{
		data = apiResponse.get("data");
		// Extract alarms array and pagination metadata
		alarms = ifnull(data.get("alarms"),data);
		pagination = ifnull(data.get("pagination"),Map());
		currentPage = ifnull(pagination.get("currentPage"),1);
		totalPages = ifnull(pagination.get("totalPages"),1);
		totalItems = ifnull(pagination.get("totalItems"),alarms.size());
		hasPrev = ifnull(pagination.get("hasPrev"),false);
		hasNext = ifnull(pagination.get("hasNext"),false);
		
		if(alarms.size() == 0)
		{
			response.put("text","*üîî CloudWatch Alarms - No alarms found*\n\nYou don't have any CloudWatch alarms configured yet.\nClick 'Create Alarm' to set up monitoring for your AWS resources.");
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"‚ûï Create Alarm","hint":"Create new alarm","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarm_create"},{"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
		}
		else
		{
			rows = List();
			for each  alarm in alarms
			{
				row = Map();
				row.put("Name","üîî " + ifnull(alarm.get("name"),""));
				row.put("State",ifnull(alarm.get("stateEmoji"),"") + " " + ifnull(alarm.get("state"),""));
				row.put("Metric",ifnull(alarm.get("metric"),""));
				rows.add(row);
			}
			
			pageText = "";
			if(totalPages > 1)
			{
				pageText = " (Page " + currentPage + " of " + totalPages + ")";
			}
			
			response.put("text","*üîî CloudWatch Alarms (" + totalItems + pageText + ")*");
			response.put("card",{"theme":"modern-inline"});
			response.put("slides",{{"type":"table","title":"","data":{"headers":{"Name","State","Metric"},"rows":rows}}});
			
			// Build buttons with pagination FIRST
			buttons = List();
			baseKey = "alarms_list";
			if(totalPages > 1)
			{
				if(hasPrev)
				{
					buttons.add({"label":"‚¨ÖÔ∏è Previous","hint":"Go to previous page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage - 1)});
				}
				if(hasNext)
				{
					buttons.add({"label":"Next ‚û°Ô∏è","hint":"Go to next page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage + 1)});
				}
			}
			// Add other action buttons after pagination
			buttons.add({"label":"‚ûï Create Alarm","hint":"Create new alarm","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarm_create"});
			buttons.add({"label":"üîÑ Refresh","hint":"Reload alarms","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarms_list"});
			buttons.add({"label":"üö® Active Only","hint":"Show active alarms","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarms_active"});
			buttons.add({"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"});
			response.put("buttons",buttons);
			response.put("navigation",true);
		}
	}
	else
	{
		response.put("text","üîî *CloudWatch Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
		response.put("card",{"title":"üîî CloudWatch Error","theme":"prompt"});
	}
}
// ============================================================================
// ALARMS ACTIVE ONLY - Show only alarms in ALARM state
// ============================================================================
else if(buttonKey == "alarms_active" || (buttonKey.contains("alarms_active") && buttonKey.contains("|page|")))
{
	// Parse pagination from button key (format: alarms_active|page|X)
	pageNum = 1;
	limitNum = 5;
	if(buttonKey.contains("|page|"))
	{
		pageParts = buttonKey.toList("|page|");
		if(pageParts.size() > 1)
		{
			try
			{
				pageNum = pageParts.get(1).toLong();
			}
			catch(e)
			{
				pageNum = 1;
			}
		}
	}
	requestBody = Map();
	requestBody.put("service","cloudwatch");
	requestBody.put("userId",userId);
	requestBody.put("region",userRegion);
	requestBody.put("action","getActiveAlarms");
	requestBody.put("page",pageNum);
	requestBody.put("limit",limitNum);
	apiResponse = invokeurl
	[
		url :API_URL
		type :POST
		parameters:requestBody.toString()
		headers:{"Content-Type":"application/json"}
		connection:"awscloudcommander"
	];
	if(apiResponse.get("success") == true)
	{
		data = apiResponse.get("data");
		// Extract alarms array and pagination metadata
		alarms = ifnull(data.get("alarms"),data);
		pagination = ifnull(data.get("pagination"),Map());
		currentPage = ifnull(pagination.get("currentPage"),1);
		totalPages = ifnull(pagination.get("totalPages"),1);
		totalItems = ifnull(pagination.get("totalItems"),alarms.size());
		hasPrev = ifnull(pagination.get("hasPrev"),false);
		hasNext = ifnull(pagination.get("hasNext"),false);
		
		if(alarms.size() == 0)
		{
			response.put("text","*üîî Active Alarms - None*\n\n‚úÖ No alarms currently in ALARM state!");
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"All Alarms","hint":"View all alarms","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarms_list"},{"label":"Back","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
			response.put("navigation",true);
		}
		else
		{
			rows = List();
			for each  alarm in alarms
			{
				row = Map();
				row.put("Name","üî¥ " + ifnull(alarm.get("name"),""));
				row.put("Metric",ifnull(alarm.get("metric"),""));
				row.put("Namespace",ifnull(alarm.get("namespace"),""));
				rows.add(row);
			}
			
			pageText = "";
			if(totalPages > 1)
			{
				pageText = " (Page " + currentPage + " of " + totalPages + ")";
			}
			
			response.put("text","*üö® Active Alarms (" + totalItems + pageText + ")*");
			response.put("card",{"theme":"modern-inline"});
			response.put("slides",{{"type":"table","title":"Alarms in ALARM State","data":{"headers":{"Name","Metric","Namespace"},"rows":rows}}});
			
			// Build buttons with pagination FIRST
			buttons = List();
			baseKey = "alarms_active";
			if(totalPages > 1)
			{
				if(hasPrev)
				{
					buttons.add({"label":"‚¨ÖÔ∏è Previous","hint":"Go to previous page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage - 1)});
				}
				if(hasNext)
				{
					buttons.add({"label":"Next ‚û°Ô∏è","hint":"Go to next page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage + 1)});
				}
			}
			// Add other action buttons after pagination
			buttons.add({"label":"All Alarms","hint":"View all alarms","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarms_list"});
			buttons.add({"label":"Back","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"});
			response.put("buttons",buttons);
			response.put("navigation",true);
		}
	}
	else
	{
		response.put("text","üîî *CloudWatch Error*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
		response.put("card",{"title":"üîî CloudWatch Error","theme":"prompt"});
	}
}
// ============================================================================
// ALARM DETAILS - Show detailed info for a single alarm
// ============================================================================
else if(actionType == "alarm" && actionSubtype == "details")
{
	// Extract alarm name from key: alarm_details_AlarmName
	alarmName = buttonKey.replaceFirst("alarm_details_","");
	if(alarmName == "" || alarmName == buttonKey)
	{
		response.put("text","*‚ùå Invalid alarm name*");
		response.put("card",{"theme":"modern-inline"});
	}
	else
	{
		requestBody = Map();
		requestBody.put("service","cloudwatch");
		requestBody.put("userId",userId);
		requestBody.put("region",userRegion);
		requestBody.put("action","getAlarm");
		requestBody.put("alarmName",alarmName);
		apiResponse = invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		];
		if(apiResponse.get("success") == true)
		{
			alarm = apiResponse.get("data");
			stateEmoji = ifnull(alarm.get("stateEmoji"),"üîî");
			state = ifnull(alarm.get("state"),"Unknown");
			metric = ifnull(alarm.get("metric"),"");
			namespace = ifnull(alarm.get("namespace"),"");
			threshold = ifnull(alarm.get("threshold"),"");
			comparison = ifnull(alarm.get("comparisonOperator"),"");
			periodRaw = ifnull(alarm.get("period"),300);
			evalPeriodsRaw = ifnull(alarm.get("evaluationPeriods"),1);
			statistic = ifnull(alarm.get("statistic"),"Average");
			description = ifnull(alarm.get("description"),"No description");
			stateReason = ifnull(alarm.get("stateReason"),"");
			actionsEnabled = ifnull(alarm.get("actionsEnabled"),false);
			// Format comparison operator
			comparisonText = comparison;
			if(comparison == "GreaterThanThreshold")
			{
				comparisonText = ">";
			}
			else if(comparison == "GreaterThanOrEqualToThreshold")
			{
				comparisonText = ">=";
			}
			else if(comparison == "LessThanThreshold")
			{
				comparisonText = "<";
			}
			else if(comparison == "LessThanOrEqualToThreshold")
			{
				comparisonText = "<=";
			}
			// Format period using lookup (avoid division type issues)
			periodText = periodRaw + " sec";
			if(periodRaw == 60 || periodRaw == "60")
			{
				periodText = "1 min";
			}
			else if(periodRaw == 300 || periodRaw == "300")
			{
				periodText = "5 min";
			}
			else if(periodRaw == 900 || periodRaw == "900")
			{
				periodText = "15 min";
			}
			else if(periodRaw == 3600 || periodRaw == "3600")
			{
				periodText = "1 hour";
			}
			else if(periodRaw == 86400 || periodRaw == "86400")
			{
				periodText = "1 day";
			}
			evalPeriods = evalPeriodsRaw;
			// Build detail text
			detailText = "*" + stateEmoji + " Alarm: " + alarmName + "*\n\n";
			detailText = detailText + "üìä *Status:* " + stateEmoji + " " + state + "\n";
			detailText = detailText + "üìù *Description:* " + description + "\n\n";
			detailText = detailText + "üìà *Metric Configuration:*\n";
			detailText = detailText + "‚Ä¢ Namespace: `" + namespace + "`\n";
			detailText = detailText + "‚Ä¢ Metric: `" + metric + "`\n";
			detailText = detailText + "‚Ä¢ Statistic: " + statistic + "\n";
			detailText = detailText + "‚Ä¢ Condition: " + statistic + " " + comparisonText + " " + threshold + "\n";
			detailText = detailText + "‚Ä¢ Period: " + periodText + "\n";
			detailText = detailText + "‚Ä¢ Evaluation Periods: " + evalPeriods + "\n\n";
			if(stateReason != "")
			{
				detailText = detailText + "üí¨ *State Reason:*\n" + stateReason + "\n\n";
			}
			actionsText = "No";
			if(actionsEnabled == true)
			{
				actionsText = "Yes";
			}
			detailText = detailText + "üîî *Actions Enabled:* " + actionsText;
			response.put("text",detailText);
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"üìú History","hint":"View alarm history","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarm_history_" + alarmName},{"label":"üóëÔ∏è Delete","hint":"Delete this alarm","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarm_delete_" + alarmName},{"label":"All Alarms","hint":"View all alarms","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarms_list"},{"label":"Back","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
			response.put("navigation",true);
		}
		else
		{
			response.put("text","üîî *Error Loading Alarm*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
			response.put("card",{"theme":"modern-inline"});
		}
	}
}
// ============================================================================
// ALARM HISTORY - Show state change history for an alarm
// ============================================================================
else if(actionType == "alarm" && actionSubtype == "history")
{
	// Extract alarm name from key: alarm_history_AlarmName
	alarmName = buttonKey.replaceFirst("alarm_history_","");
	if(alarmName == "" || alarmName == buttonKey)
	{
		response.put("text","*‚ùå Invalid alarm name*");
		response.put("card",{"theme":"modern-inline"});
	}
	else
	{
		requestBody = Map();
		requestBody.put("service","cloudwatch");
		requestBody.put("userId",userId);
		requestBody.put("region",userRegion);
		requestBody.put("action","getAlarmHistory");
		requestBody.put("alarmName",alarmName);
		apiResponse = invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		];
		if(apiResponse.get("success") == true)
		{
			history = apiResponse.get("data");
			if(history.size() == 0)
			{
				response.put("text","*üìú Alarm History: " + alarmName + "*\n\nNo history records found.");
				response.put("card",{"theme":"modern-inline"});
			}
			else
			{
				historyText = "*üìú Alarm History: " + alarmName + "*\n\n";
				count = 0;
				for each  item in history
				{
					if(count < 10)
					{
						timestamp = ifnull(item.get("timestamp"),"");
						historyType = ifnull(item.get("type"),"");
						summary = ifnull(item.get("summary"),"");
						// Format type with emoji
						typeEmoji = "üìù";
						if(historyType == "StateUpdate")
						{
							typeEmoji = "üîÑ";
						}
						else if(historyType == "Action")
						{
							typeEmoji = "‚ö°";
						}
						else if(historyType == "ConfigurationUpdate")
						{
							typeEmoji = "‚öôÔ∏è";
						}
						historyText = historyText + typeEmoji + " *" + historyType + "*\n";
						historyText = historyText + "   üìÖ " + timestamp + "\n";
						historyText = historyText + "   " + summary + "\n\n";
						count = count + 1;
					}
				}
				if(history.size() > 10)
				{
					historyText = historyText + "_Showing 10 of " + history.size() + " records_";
				}
				response.put("text",historyText);
				response.put("card",{"theme":"modern-inline"});
			}
			response.put("buttons",{{"label":"üìã Details","hint":"View alarm details","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarm_details_" + alarmName},{"label":"All Alarms","hint":"View all alarms","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarms_list"},{"label":"Back","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
			response.put("navigation",true);
		}
		else
		{
			response.put("text","üîî *Error Loading History*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
			response.put("card",{"theme":"modern-inline"});
		}
	}
}
// ============================================================================
// ALARM DELETE - Show confirmation for deleting an alarm
// ============================================================================
else if(actionType == "alarm" && actionSubtype == "delete")
{
	// Extract alarm name from key: alarm_delete_AlarmName
	alarmName = buttonKey.replaceFirst("alarm_delete_","");
	if(alarmName == "" || alarmName == buttonKey)
	{
		response.put("text","*‚ùå Invalid alarm name*");
		response.put("card",{"theme":"modern-inline"});
	}
	else
	{
		response.put("text","*üóëÔ∏è Delete Alarm*\n\n‚ö†Ô∏è Are you sure you want to delete this alarm?\n\nüîî *Alarm:* `" + alarmName + "`\n\n_This action cannot be undone._");
		response.put("card",{"theme":"modern-inline"});
		response.put("buttons",{{"label":"‚úÖ Yes, Delete","hint":"Confirm deletion","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarm_deleteconfirm_" + alarmName},{"label":"‚ùå Cancel","hint":"Cancel deletion","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarm_details_" + alarmName}});
	}
}
// ============================================================================
// ALARM DELETE CONFIRM - Actually delete the alarm
// ============================================================================
else if(actionType == "alarm" && actionSubtype == "deleteconfirm")
{
	// Extract alarm name from key: alarm_deleteconfirm_AlarmName
	alarmName = buttonKey.replaceFirst("alarm_deleteconfirm_","");
	if(alarmName == "" || alarmName == buttonKey)
	{
		response.put("text","*‚ùå Invalid alarm name*");
		response.put("card",{"theme":"modern-inline"});
	}
	else
	{
		requestBody = Map();
		requestBody.put("service","cloudwatch");
		requestBody.put("userId",userId);
		requestBody.put("region",userRegion);
		requestBody.put("action","deleteAlarm");
		requestBody.put("alarmName",alarmName);
		apiResponse = invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		];
		if(apiResponse.get("success") == true)
		{
			// Send notification using dynamic notification system
			notifMsg = Map();
			notifMsg.put("text","üóëÔ∏è *CloudWatch Alarm Deleted*\n\nüë§ *By:* " + userName + "\nüìõ *Name:* " + alarmName + "\n‚è∞ *Time:* " + zoho.currenttime.toString("dd MMM yyyy HH:mm"));
			notifMsg.put("card",{"theme":"modern-inline"});
			// Get notification channel for alarms
			channelName = "";
			notifQuery = Map();
			notifQuery.put("criteria","userid==" + userId.toString());
			allUserRecords = zoho.cliq.getRecords("awsnotifications",notifQuery);
			if(allUserRecords != null && allUserRecords.get("status") == "SUCCESS")
			{
				notifList = allUserRecords.get("list");
				if(notifList != null && notifList.size() > 0)
				{
					for each  notifRecord in notifList
					{
						if(notifRecord != null && ifnull(notifRecord.get("userid"),"").toString() == userId.toString() && ifnull(notifRecord.get("notificationtype"),"") == "alarms")
						{
							enabledVal = notifRecord.get("enabled");
							if(enabledVal == "TRUE" || enabledVal == true || enabledVal == "true" || enabledVal == 1 || enabledVal == "1")
							{
								channelRaw = ifnull(notifRecord.get("channel"),"");
								if(channelRaw != null && channelRaw != "")
								{
									// Extract channel name (handles object, JSON string, or plain string)
									try
									{
										if(channelRaw.get("unique_name") != null)
										{
											channelName = channelRaw.get("unique_name").toString();
										}
										else if(channelRaw.get("name") != null)
										{
											channelName = channelRaw.get("name").toString();
										}
									}
									catch(e)
									{
										channelName = channelRaw.toString();
									}
									if(channelName == "")
									{
										channelName = channelRaw.toString();
									}
									// Remove # prefix and handle JSON strings
									if(channelName.startsWith("{"))
									{
										if(channelName.contains("\"unique_name\""))
										{
											startIdx = channelName.indexOf("\"unique_name\"");
											valueStart = channelName.indexOf("\"", startIdx + 13) + 1;
											valueEnd = channelName.indexOf("\"", valueStart);
											if(valueStart > 0 && valueEnd > valueStart)
											{
												channelName = channelName.subString(valueStart, valueEnd);
											}
										}
									}
									if(channelName.startsWith("#"))
									{
										channelName = channelName.subString(1);
									}
									break;
								}
							}
						}
					}
				}
			}
			// Fallback to old system
			if(channelName == "")
			{
				scheduleQuery = Map();
				scheduleQuery.put("criteria","userid==" + userId);
				scheduleRecords = zoho.cliq.getRecords("awsschedule",scheduleQuery);
				if(scheduleRecords != null && scheduleRecords.get("status") == "SUCCESS")
				{
					scheduleList = scheduleRecords.get("list");
					if(scheduleList != null && scheduleList.size() > 0)
					{
						schedule = scheduleList.get(0);
						alertsVal = schedule.get("alertsenabled");
						if(alertsVal == "TRUE" || alertsVal == true || alertsVal == "true" || alertsVal == 1 || alertsVal == "1")
						{
							prefsQuery = Map();
							prefsQuery.put("criteria","userid==" + userId);
							prefsRecords = zoho.cliq.getRecords("awsprefs",prefsQuery);
							if(prefsRecords != null && prefsRecords.get("status") == "SUCCESS")
							{
								prefsList = prefsRecords.get("list");
								if(prefsList != null && prefsList.size() > 0)
								{
									channelName = ifnull(prefsList.get(0).get("channel"),"");
									if(channelName.startsWith("#"))
									{
										channelName = channelName.subString(1);
									}
								}
							}
						}
					}
				}
			}
			// Send notification
			if(channelName != "" && channelName != null)
			{
				zoho.cliq.postToChannelAsBot(channelName,"awscloudcommander",notifMsg);
			}
			response.put("text","*‚úÖ Alarm Deleted*\n\nüóëÔ∏è Alarm `" + alarmName + "` has been deleted successfully.");
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"All Alarms","hint":"View all alarms","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarms_list"},{"label":"Back","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
			response.put("navigation",true);
		}
		else
		{
			response.put("text","*‚ùå Delete Failed*\n\n" + ifnull(apiResponse.get("error"),"Unknown error"));
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"Try Again","hint":"Retry deletion","type":"-","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarm_delete_" + alarmName},{"label":"All Alarms","hint":"View all alarms","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"alarms_list"}});
			response.put("navigation",true);
		}
	}
}
// ============================================================================
// ALARM CREATE FORM - Show form to create a new alarm
// ============================================================================
else if(buttonKey == "alarm_create")
{
	return {"type":"form","title":"üîî Create CloudWatch Alarm","hint":"Create a new metric alarm","name":"createAlarmForm","button_label":"üîî Create Alarm","inputs":{{"type":"text","name":"alarmName","label":"Alarm Name","placeholder":"e.g., HighCPUAlarm","mandatory":true},{"type":"textarea","name":"description","label":"Description","placeholder":"Describe what this alarm monitors","mandatory":false},{"type":"select","name":"namespace","label":"AWS Service","placeholder":"Select the AWS service","mandatory":true,"options":{{"value":"AWSEC2","label":"EC2 - Compute"},{"value":"AWSLambda","label":"Lambda - Functions"},{"value":"AWSRDS","label":"RDS - Database"},{"value":"AWSS3","label":"S3 - Storage"},{"value":"AWSELB","label":"ELB - Load Balancer"}}},{"type":"select","name":"metricName","label":"Metric","placeholder":"Select metric to monitor","mandatory":true,"options":{{"value":"CPUUtilization","label":"CPU Utilization (%)"},{"value":"NetworkIn","label":"Network In (bytes)"},{"value":"NetworkOut","label":"Network Out (bytes)"},{"value":"Errors","label":"Errors (count)"},{"value":"Invocations","label":"Invocations (count)"},{"value":"Duration","label":"Duration (ms)"}}},{"type":"select","name":"statistic","label":"Statistic","placeholder":"Select statistic","mandatory":true,"value":"Average","options":{{"value":"Average","label":"Average"},{"value":"Sum","label":"Sum"},{"value":"Maximum","label":"Maximum"},{"value":"Minimum","label":"Minimum"}}},{"type":"select","name":"comparisonOperator","label":"Condition","placeholder":"When to trigger alarm","mandatory":true,"options":{{"value":"GreaterThanThreshold","label":"> Greater Than"},{"value":"GreaterThanOrEqualToThreshold","label":">= Greater or Equal"},{"value":"LessThanThreshold","label":"< Less Than"},{"value":"LessThanOrEqualToThreshold","label":"<= Less or Equal"}}},{"type":"number","name":"threshold","label":"Threshold Value","placeholder":"e.g., 80 for 80% CPU","mandatory":true},{"type":"select","name":"period","label":"Evaluation Period","placeholder":"Select period","mandatory":true,"value":"300","options":{{"value":"60","label":"1 minute"},{"value":"300","label":"5 minutes"},{"value":"900","label":"15 minutes"},{"value":"3600","label":"1 hour"}}},{"type":"number","name":"evaluationPeriods","label":"Consecutive Periods","placeholder":"How many periods before alarming","mandatory":true,"value":"1"},{"type":"text","name":"dimensionName","label":"Dimension Name (optional)","placeholder":"e.g., InstanceId, FunctionName","mandatory":false},{"type":"text","name":"dimensionValue","label":"Dimension Value (optional)","placeholder":"e.g., i-1234567890abcdef0","mandatory":false}},"action":{"type":"invoke.function","name":"handleForm"}};
}
// ============================================================================
// SECTION: AI Assistant Form Display
// ============================================================================
// Shows the AI Assistant form when user clicks "AI" button
// Form allows users to ask AWS questions using Amazon Bedrock (Claude)
// Requires consent (consentai flag) due to $0.01-0.15 per query
// ============================================================================
else if(buttonKey == "ai_form")
{
	return {"type":"form","title":"ü§ñ AWS AI Assistant","hint":"Powered by Amazon Bedrock (Claude)","name":"awsAiForm","button_label":"üöÄ Ask AI","inputs":{{"type":"select","name":"mode","label":"Assistant Mode","placeholder":"Choose the type of help","mandatory":true,"value":"general","options":{{"value":"general","label":"üí¨ General AWS Help"},{"value":"troubleshoot","label":"üîß Troubleshoot Issue"},{"value":"optimize","label":"üí∞ Cost Optimization"},{"value":"security","label":"üîí Security Review"},{"value":"architecture","label":"üèóÔ∏è Architecture Advice"}}},{"type":"textarea","name":"question","label":"Your Question","placeholder":"e.g., How can I reduce my EC2 costs while maintaining performance?","mandatory":true}},"action":{"type":"invoke.function","name":"handleForm"}};
}
// ============================================================================
// SECTION: Notification Settings Form Display
// ============================================================================
// Shows the notification configuration form when user clicks notification settings button
// Allows users to configure per-type notification channels:
//   - EC2, S3, Alarms, SNS, Lambda, RDS events
//   - Daily Cost Reports, Weekly Infrastructure Summary
// Settings are stored in awsnotifications table with composite primary key (userid, notificationtype)
// ============================================================================
else if(buttonKey == "notification_settings")
{
	// Load current notification settings from awsnotifications table
	// Notification types: ec2, s3, alarms, sns, lambda, rds, daily_cost, weekly_summary
	notifTypes = List();
	notifTypes.add("ec2");
	notifTypes.add("s3");
	notifTypes.add("alarms");
	notifTypes.add("sns");
	notifTypes.add("lambda");
	notifTypes.add("rds");
	notifTypes.add("daily_cost");
	notifTypes.add("weekly_summary");
	
	// Fetch current settings for each notification type
	currentSettings = Map();
	notifQuery = Map();
	notifQuery.put("criteria","userid==" + userId.toString());
	allUserRecords = zoho.cliq.getRecords("awsnotifications",notifQuery);
	
	// Process all records and group by notificationtype
	if(allUserRecords != null && allUserRecords.get("status") == "SUCCESS")
	{
		notifList = allUserRecords.get("list");
		if(notifList != null && notifList.size() > 0)
		{
			for each  notifRecord in notifList
			{
				if(notifRecord != null)
				{
					recUserId = ifnull(notifRecord.get("userid"),"").toString();
					recNotifType = ifnull(notifRecord.get("notificationtype"),"");
					if(recUserId == userId.toString() && recNotifType != "")
					{
						setting = Map();
						setting.put("enabled",ifnull(notifRecord.get("enabled"),"FALSE"));
						channelRaw = ifnull(notifRecord.get("channel"),"");
						channelStr = "";
						if(channelRaw != null)
						{
							channelStr = channelRaw.toString();
							if(channelStr.startsWith("{"))
							{
								try
								{
									channelObj = channelRaw;
									if(channelObj.get("unique_name") != null)
									{
										channelStr = channelObj.get("unique_name").toString();
									}
									else if(channelObj.get("name") != null)
									{
										channelStr = channelObj.get("name").toString();
										if(channelStr.startsWith("#"))
										{
											channelStr = channelStr.subString(1);
										}
									}
									else
									{
										channelStr = "";
									}
								}
								catch(e)
								{
									channelStr = "";
								}
							}
						}
						setting.put("channel",channelStr);
						currentSettings.put(recNotifType,setting);
					}
				}
			}
		}
	}
	
	// Initialize defaults for any notification types not found
	for each  notifType in notifTypes
	{
		if(currentSettings.get(notifType) == null)
		{
			setting = Map();
			setting.put("enabled","FALSE");
			setting.put("channel","");
			currentSettings.put(notifType,setting);
		}
	}
	
	// Get fallback channel from awsprefs for backward compatibility display
	prefsQuery = Map();
	prefsQuery.put("criteria","userid==" + userId);
	prefsRecords = zoho.cliq.getRecords("awsprefs",prefsQuery);
	fallbackChannel = "";
	if(prefsRecords != null && prefsRecords.get("status") == "SUCCESS")
	{
		prefsList = prefsRecords.get("list");
		if(prefsList != null && prefsList.size() > 0)
		{
			prefs = prefsList.get(0);
			fallbackChannel = ifnull(prefs.get("channel"),"");
		}
	}
	
	// Build form inputs
	formInputs = List();
	
	// EC2 Notifications
	ec2Setting = currentSettings.get("ec2");
	ec2Enabled = ifnull(ec2Setting.get("enabled"),"FALSE");
	ec2Channel = ifnull(ec2Setting.get("channel"),"");
	if(ec2Channel == "")
	{
		ec2Channel = fallbackChannel;
	}
	formInputs.add({"type":"toggle","name":"ec2_enabled","label":"üñ•Ô∏è EC2 Instance Events","value":(ec2Enabled == "TRUE" || ec2Enabled == true || ec2Enabled == "true" || ec2Enabled == 1 || ec2Enabled == "1")});
	formInputs.add({"type":"native_select","name":"ec2_channel","label":"EC2 Channel","placeholder":"Select channel","hint":"Current: " + ifnull(ec2Channel,"Not set"),"mandatory":false,"data_source":"channels","value":ec2Channel});
	
	// S3 Notifications
	s3Setting = currentSettings.get("s3");
	s3Enabled = ifnull(s3Setting.get("enabled"),"FALSE");
	s3Channel = ifnull(s3Setting.get("channel"),"");
	if(s3Channel == "")
	{
		s3Channel = fallbackChannel;
	}
	formInputs.add({"type":"toggle","name":"s3_enabled","label":"üì¶ S3 Bucket Events","value":(s3Enabled == "TRUE" || s3Enabled == true || s3Enabled == "true" || s3Enabled == 1 || s3Enabled == "1")});
	formInputs.add({"type":"native_select","name":"s3_channel","label":"S3 Channel","placeholder":"Select channel","hint":"Current: " + ifnull(s3Channel,"Not set"),"mandatory":false,"data_source":"channels","value":s3Channel});
	
	// CloudWatch Alarms Notifications
	alarmsSetting = currentSettings.get("alarms");
	alarmsEnabled = ifnull(alarmsSetting.get("enabled"),"FALSE");
	alarmsChannel = ifnull(alarmsSetting.get("channel"),"");
	if(alarmsChannel == "")
	{
		alarmsChannel = fallbackChannel;
	}
	formInputs.add({"type":"toggle","name":"alarms_enabled","label":"üîî CloudWatch Alarms","value":(alarmsEnabled == "TRUE" || alarmsEnabled == true || alarmsEnabled == "true" || alarmsEnabled == 1 || alarmsEnabled == "1")});
	formInputs.add({"type":"native_select","name":"alarms_channel","label":"Alarms Channel","placeholder":"Select channel","hint":"Current: " + ifnull(alarmsChannel,"Not set"),"mandatory":false,"data_source":"channels","value":alarmsChannel});
	
	// SNS Notifications
	snsSetting = currentSettings.get("sns");
	snsEnabled = ifnull(snsSetting.get("enabled"),"FALSE");
	snsChannel = ifnull(snsSetting.get("channel"),"");
	if(snsChannel == "")
	{
		snsChannel = fallbackChannel;
	}
	formInputs.add({"type":"toggle","name":"sns_enabled","label":"üì¢ SNS Messages","value":(snsEnabled == "TRUE" || snsEnabled == true || snsEnabled == "true" || snsEnabled == 1 || snsEnabled == "1")});
	formInputs.add({"type":"native_select","name":"sns_channel","label":"SNS Channel","placeholder":"Select channel","hint":"Current: " + ifnull(snsChannel,"Not set"),"mandatory":false,"data_source":"channels","value":snsChannel});
	
	// Lambda Notifications
	lambdaSetting = currentSettings.get("lambda");
	lambdaEnabled = ifnull(lambdaSetting.get("enabled"),"FALSE");
	lambdaChannel = ifnull(lambdaSetting.get("channel"),"");
	if(lambdaChannel == "")
	{
		lambdaChannel = fallbackChannel;
	}
	formInputs.add({"type":"toggle","name":"lambda_enabled","label":"‚ö° Lambda Functions","value":(lambdaEnabled == "TRUE" || lambdaEnabled == true || lambdaEnabled == "true" || lambdaEnabled == 1 || lambdaEnabled == "1")});
	formInputs.add({"type":"native_select","name":"lambda_channel","label":"Lambda Channel","placeholder":"Select channel","hint":"Current: " + ifnull(lambdaChannel,"Not set"),"mandatory":false,"data_source":"channels","value":lambdaChannel});
	
	// RDS Notifications
	rdsSetting = currentSettings.get("rds");
	rdsEnabled = ifnull(rdsSetting.get("enabled"),"FALSE");
	rdsChannel = ifnull(rdsSetting.get("channel"),"");
	if(rdsChannel == "")
	{
		rdsChannel = fallbackChannel;
	}
	formInputs.add({"type":"toggle","name":"rds_enabled","label":"üóÑÔ∏è RDS Instances","value":(rdsEnabled == "TRUE" || rdsEnabled == true || rdsEnabled == "true" || rdsEnabled == 1 || rdsEnabled == "1")});
	formInputs.add({"type":"native_select","name":"rds_channel","label":"RDS Channel","placeholder":"Select channel","hint":"Current: " + ifnull(rdsChannel,"Not set"),"mandatory":false,"data_source":"channels","value":rdsChannel});
	
	// Daily Cost Report
	dailyCostSetting = currentSettings.get("daily_cost");
	dailyCostEnabled = ifnull(dailyCostSetting.get("enabled"),"FALSE");
	dailyCostChannel = ifnull(dailyCostSetting.get("channel"),"");
	if(dailyCostChannel == "")
	{
		dailyCostChannel = fallbackChannel;
	}
	formInputs.add({"type":"toggle","name":"daily_cost_enabled","label":"üí∞ Daily Cost Report","value":(dailyCostEnabled == "TRUE" || dailyCostEnabled == true || dailyCostEnabled == "true" || dailyCostEnabled == 1 || dailyCostEnabled == "1")});
	formInputs.add({"type":"native_select","name":"daily_cost_channel","label":"Daily Cost Channel","placeholder":"Select channel","hint":"Current: " + ifnull(dailyCostChannel,"Not set"),"mandatory":false,"data_source":"channels","value":dailyCostChannel});
	
	// Weekly Summary
	weeklySummarySetting = currentSettings.get("weekly_summary");
	weeklySummaryEnabled = ifnull(weeklySummarySetting.get("enabled"),"FALSE");
	weeklySummaryChannel = ifnull(weeklySummarySetting.get("channel"),"");
	if(weeklySummaryChannel == "")
	{
		weeklySummaryChannel = fallbackChannel;
	}
	formInputs.add({"type":"toggle","name":"weekly_summary_enabled","label":"üìä Weekly Summary","value":(weeklySummaryEnabled == "TRUE" || weeklySummaryEnabled == true || weeklySummaryEnabled == "true" || weeklySummaryEnabled == 1 || weeklySummaryEnabled == "1")});
	formInputs.add({"type":"native_select","name":"weekly_summary_channel","label":"Weekly Summary Channel","placeholder":"Select channel","hint":"Current: " + ifnull(weeklySummaryChannel,"Not set"),"mandatory":false,"data_source":"channels","value":weeklySummaryChannel});
	
	// Return form
	response.put("type","form");
	response.put("title","üîî Notification Settings");
	response.put("hint","Configure notification channels for each AWS service");
	response.put("name","awsNotificationSettingsForm");
	response.put("button_label","üíæ Save");
	response.put("inputs",formInputs);
	formAction = Map();
	formAction.put("type","invoke.function");
	formAction.put("name","handleForm");
	response.put("action",formAction);
}
// ============================================================================
// SECTION: Settings Form Display
// ============================================================================
// Shows the main settings form when user clicks "Settings" button
// Allows users to configure:
//   - Default AWS region
//   - Cost alert threshold
//   - Feature consents (Cost, AI, Lambda, SNS)
//   - Scheduler preferences (Daily Cost Reports, Weekly Summary)
// Settings are stored in awsprefs and awsschedule tables
// ============================================================================
else if(buttonKey == "settings_form")
{
	// Get current settings from awsprefs database
	settingsQuery = Map();
	settingsQuery.put("criteria","userid==" + userId);
	existingRecords = zoho.cliq.getRecords("awsprefs",settingsQuery);
	// Get schedule settings from awsschedule database
	scheduleRecords = zoho.cliq.getRecords("awsschedule",settingsQuery);
	// Default values - preferences
	currentRegion = "ap-south-1";
	currentThreshold = "50";
	currentConsentCost = false;
	currentConsentAi = false;
	currentConsentLambda = false;
	// Default values - schedule
	currentDailyCost = false;
	currentWeeklySummary = false;
	// Read from awsprefs table
	if(existingRecords != null && existingRecords.get("status") == "SUCCESS")
	{
		recordList = existingRecords.get("list");
		if(recordList != null && recordList.size() > 0)
		{
			prefs = recordList.get(0);
			if(prefs != null)
			{
				currentRegion = ifnull(prefs.get("region"),"ap-south-1");
				currentThreshold = ifnull(prefs.get("costthreshold"),"50").toString();
				// Handle consent values (could be boolean, string, or number)
				consentCostVal = prefs.get("consentcost");
				if(consentCostVal == true || consentCostVal == "true" || consentCostVal == 1 || consentCostVal == "1")
				{
					currentConsentCost = true;
				}
				consentAiVal = prefs.get("consentai");
				if(consentAiVal == true || consentAiVal == "true" || consentAiVal == 1 || consentAiVal == "1")
				{
					currentConsentAi = true;
				}
				consentLambdaVal = prefs.get("consentlambda");
				if(consentLambdaVal == true || consentLambdaVal == "true" || consentLambdaVal == 1 || consentLambdaVal == "1")
				{
					currentConsentLambda = true;
				}
			}
		}
	}
	// Read from awsschedule table (schedule-related settings only, channel is in awsprefs)
	// NOTE: Zoho Cliq DB stores booleans as "TRUE"/"FALSE" strings
	if(scheduleRecords != null && scheduleRecords.get("status") == "SUCCESS")
	{
		scheduleList = scheduleRecords.get("list");
		if(scheduleList != null && scheduleList.size() > 0)
		{
			schedule = scheduleList.get(0);
			if(schedule != null)
			{
				dailyCostVal = schedule.get("dailycost");
				if(dailyCostVal == true || dailyCostVal == "true" || dailyCostVal == "TRUE" || dailyCostVal == 1 || dailyCostVal == "1")
				{
					currentDailyCost = true;
				}
				weeklySummaryVal = schedule.get("weeklysummary");
				if(weeklySummaryVal == true || weeklySummaryVal == "true" || weeklySummaryVal == "TRUE" || weeklySummaryVal == 1 || weeklySummaryVal == "1")
				{
					currentWeeklySummary = true;
				}
			}
		}
	}
	// Return form using inline syntax (same pattern as working AI form)
	// NOTE: Zoho Cliq has UNDOCUMENTED label length limit - keep labels short or form silently fails!
	// NOTE: Settings form does NOT require credentials check - users need to configure settings even before credentials are set up
	return {"type":"form","title":"‚öôÔ∏è AWS Settings","hint":"Configure your AWS Cloud Commander preferences. For notification channels, use Bot Menu ‚Üí Notifications.","name":"awsSettingsForm","button_label":"üíæ Save Settings","inputs":{{"type":"select","name":"region","label":"üåç Default AWS Region","placeholder":"Select your primary AWS region","mandatory":true,"value":currentRegion,"options":{{"value":"ap-south-1","label":"Asia Pacific (Mumbai)"},{"value":"us-east-1","label":"US East (N. Virginia)"},{"value":"us-west-2","label":"US West (Oregon)"},{"value":"eu-west-1","label":"Europe (Ireland)"},{"value":"eu-central-1","label":"Europe (Frankfurt)"},{"value":"ap-southeast-1","label":"Asia Pacific (Singapore)"},{"value":"ap-northeast-1","label":"Asia Pacific (Tokyo)"}}},{"type":"number","name":"costThreshold","label":"üíµ Cost Alert Threshold ($)","placeholder":"Alert when daily cost exceeds this","mandatory":false,"value":currentThreshold,"min":"1","max":"10000"},{"type":"toggle","name":"dailyCost","label":"üìä Daily Cost Report","value":currentDailyCost},{"type":"toggle","name":"weeklySummary","label":"üìà Weekly Infrastructure Summary","value":currentWeeklySummary},{"type":"toggle","name":"consentCost","label":"üí∞ Enable Cost Explorer API ($0.01/request)","value":currentConsentCost},{"type":"toggle","name":"consentAi","label":"ü§ñ Enable AI Assistant ($0.01-0.15/query)","value":currentConsentAi},{"type":"toggle","name":"consentLambda","label":"‚ö° Enable Lambda Invocation (incurs cost/invoke)","value":currentConsentLambda}},"action":{"type":"invoke.function","name":"handleForm"}};
}
// ============================================================================
// SECTION: Consent Management Actions
// ============================================================================
// Handles user consent for paid AWS APIs:
//   - consent_grant_cost_explorer ‚Üí Enable Cost Explorer ($0.01 per call)
//   - consent_grant_bedrock_ai    ‚Üí Enable AI Assistant ($0.01-0.15 per query)
//   - consent_grant_lambda_invoke ‚Üí Enable Lambda invocation
//   - consent_grant_sns_publish   ‚Üí Enable SNS publishing
//
// Consents are stored in awsprefs table and synced with backend
// ============================================================================
else if(actionType == "consent" && actionSubtype == "grant")
{
	// keyPart2 already contains all remaining parts joined with underscore
	// e.g., for key "consent_grant_lambda_invoke", keyPart2 = "lambda_invoke"
	// e.g., for key "consent_grant_cost_explorer", keyPart2 = "cost_explorer"
	// So we just use keyPart2 directly as the categoryId
	categoryId = keyPart2;
	if(categoryId == "")
	{
		response.put("text","*Missing category ID*");
		response.put("card",{"theme":"modern-inline"});
	}
	else
	{
		// Store consent in Cliq database
		consentQuery = Map();
		consentQuery.put("criteria","userid==" + userId);
		existingRecords = zoho.cliq.getRecords("awsprefs",consentQuery);
		// Map server category to Cliq field
		cliqField = "";
		categoryName = "";
		costInfo = "";
		if(categoryId == "bedrock_ai")
		{
			cliqField = "consentai";
			categoryName = "Bedrock AI";
			costInfo = "~$0.01-0.15 per query";
		}
		else if(categoryId == "cost_explorer")
		{
			cliqField = "consentcost";
			categoryName = "Cost Explorer";
			costInfo = "$0.01 per API call";
		}
		else if(categoryId == "lambda_invoke")
		{
			cliqField = "consentlambda";
			categoryName = "Lambda Invocation";
			costInfo = "uses your Lambda quota";
		}
		// getRecords returns {"status":"SUCCESS","list":[...]}
		recordId = "";
		if(existingRecords != null && existingRecords.get("status") == "SUCCESS")
		{
			recordList = existingRecords.get("list");
			if(recordList != null && recordList.size() > 0)
			{
				existingRecord = recordList.get(0);
				if(existingRecord != null)
				{
					recordId = ifnull(existingRecord.get("id"),"");
				}
			}
		}
		if(recordId != "")
		{
			// Update existing record
			updateData = Map();
			if(cliqField != "")
			{
				updateData.put(cliqField,true);
			}
			zoho.cliq.updateRecord("awsprefs",recordId,updateData);
		}
		else
		{
			// Create new record with consent - awsprefs fields only (schedule fields are in awsschedule)
			newRecord = Map();
			newRecord.put("userid",userId);
			newRecord.put("username",userName);
			newRecord.put("region","ap-south-1");
			newRecord.put("channel","");
			newRecord.put("costthreshold",50);
			newRecord.put("consentcost",false);
			newRecord.put("consentai",false);
			newRecord.put("consentlambda",false);
			// Set the specific consent field to true
			if(cliqField == "consentai")
			{
				newRecord.put("consentai",true);
			}
			else if(cliqField == "consentcost")
			{
				newRecord.put("consentcost",true);
			}
			else if(cliqField == "consentlambda")
			{
				newRecord.put("consentlambda",true);
			}
			zoho.cliq.createRecord("awsprefs",newRecord);
		}
		// Also grant consent on server side
		requestBody = Map();
		requestBody.put("service","consent");
		requestBody.put("action","grant");
		requestBody.put("userId",userId);
		requestBody.put("categoryId",categoryId);
		invokeurl
		[
			url :API_URL
			type :POST
			parameters:requestBody.toString()
			headers:{"Content-Type":"application/json"}
			connection:"awscloudcommander"
		]
		// Log to audit
		logEntry = Map();
		logEntry.put("logid","LOG-" + zoho.currenttime.toLong());
		logEntry.put("userid",userId);
		logEntry.put("username",userName);
		logEntry.put("action","consent:grant");
		logEntry.put("resource",categoryId);
		logEntry.put("timestamp",zoho.currenttime.toLong());
		logEntry.put("result","success");
		logEntry.put("details",categoryName + " consent granted");
		zoho.cliq.createRecord("awsauditlog",logEntry);
		// Return appropriate response based on category
		if(categoryId == "bedrock_ai")
		{
			response.put("text","*‚úÖ AI Assistant Enabled!*\n\n" + "You can now use the AI assistant.\n\n" + "üí∞ Reminder: " + costInfo + "\n\n" + "Click below to ask a question.");
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"Ask AI","hint":"Open AI assistant","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"ai_form"},{"label":"Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
		}
		else if(categoryId == "cost_explorer")
		{
			response.put("text","*‚úÖ Cost Explorer Enabled!*\n\n" + "You can now view cost reports.\n\n" + "üí∞ Reminder: " + costInfo + "\n\n" + "Click below to view costs.");
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"View Costs","hint":"View cost report","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"cost_week"},{"label":"Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
		}
		else
		{
			response.put("text","*‚úÖ " + categoryName + " Enabled!*\n\n" + "You can now use this feature.\n\n" + "üí∞ Cost: " + costInfo);
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
		}
	}
}
// ============================================================================
// SNS ACTIONS
// ============================================================================
else if(buttonKey.startsWith("sns_publish_"))
{
	// Open form to publish message to topic
	topicArn = buttonKey.replaceFirst("sns_publish_","");
	// Extract topic name from ARN
	topicName = topicArn;
	if(topicArn.contains(":"))
	{
		arnParts = topicArn.toList(":");
		topicName = arnParts.get(arnParts.size() - 1);
	}
	return {"type":"form","title":"üì® Publish to " + topicName,"hint":"Send a message to SNS topic","name":"sns_publish_form","button_label":"üì® Publish Message","inputs":{{"type":"hidden","name":"topicArn","value":topicArn},{"type":"textarea","name":"message","label":"Message","placeholder":"Enter your message here...","mandatory":true}},"action":{"type":"invoke.function","name":"handleForm"}};
}
else if(buttonKey.startsWith("sns_subs_"))
{
	// List subscribers for topic
	topicArn = buttonKey.replaceFirst("sns_subs_","");
	topicName = topicArn;
	if(topicArn.contains(":"))
	{
		arnParts = topicArn.toList(":");
		topicName = arnParts.get(arnParts.size() - 1);
	}
	requestBody = Map();
	requestBody.put("service","sns");
	requestBody.put("userId",userId);
	requestBody.put("region",userRegion);
	requestBody.put("action","listSubscriptions");
	requestBody.put("topicArn",topicArn);
	apiResponse = invokeurl
	[
		url :API_URL
		type :POST
		parameters:requestBody.toString()
		headers:{"Content-Type":"application/json"}
		connection:"awscloudcommander"
	];
	if(apiResponse.get("success") == true)
	{
		subs = apiResponse.get("data");
		if(subs == null || subs.size() == 0)
		{
			response.put("text","*üë• Subscribers for " + topicName + "*\n\n_No subscribers found._\n\nAdd subscribers in AWS Console to receive notifications.");
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"üì¢ Back to Topics","hint":"View all SNS topics","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"sns_list"},{"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
			response.put("navigation",true);
		}
		else
		{
			// Build table of subscribers
			subRows = List();
			for each  sub in subs
			{
				protocol = ifnull(sub.get("protocol"),"");
				endpoint = ifnull(sub.get("endpoint"),"");
				status = ifnull(sub.get("status"),"");
				// Truncate long endpoints
				if(endpoint.length() > 35)
				{
					endpoint = endpoint.subString(0,32) + "...";
				}
				// Status emoji
				statusEmoji = "‚è≥";
				if(status == "Confirmed" || status == "confirmed")
				{
					statusEmoji = "‚úÖ";
				}
				else if(status == "PendingConfirmation")
				{
					statusEmoji = "‚è≥";
				}
				subRows.add({"Protocol":protocol.toUpperCase(),"Endpoint":endpoint,"Status":statusEmoji + " " + status});
			}
			response.put("text","*üë• Subscribers for " + topicName + " (" + subs.size() + ")*");
			response.put("card",{"theme":"modern-inline"});
			response.put("slides",{{"type":"table","title":"","headers":{"Protocol","Endpoint","Status"},"data":subRows}});
			response.put("buttons",{{"label":"üì® Publish","hint":"Publish message to this topic","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"sns_publish_" + topicArn},{"label":"üì¢ Back to Topics","hint":"View all SNS topics","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"sns_list"},{"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
			response.put("navigation",true);
		}
	}
	else
	{
		response.put("text","*‚ùå Error*\n\n" + ifnull(apiResponse.get("error"),"Failed to fetch subscribers"));
		response.put("card",{"theme":"prompt"});
	}
}
else if(buttonKey.startsWith("sns_details_"))
{
	// Show topic details
	topicArn = buttonKey.replaceFirst("sns_details_","");
	topicName = topicArn;
	if(topicArn.contains(":"))
	{
		arnParts = topicArn.toList(":");
		topicName = arnParts.get(arnParts.size() - 1);
	}
	// Extract region from ARN (arn:aws:sns:REGION:account:name)
	topicRegion = "Unknown";
	if(topicArn.contains(":"))
	{
		arnParts = topicArn.toList(":");
		if(arnParts.size() >= 4)
		{
			topicRegion = arnParts.get(3);
		}
	}
	detailsText = "*üì¢ SNS Topic Details*\n\n";
	detailsText = detailsText + "üìõ *Name:* " + topicName + "\n";
	detailsText = detailsText + "üåç *Region:* " + topicRegion + "\n";
	detailsText = detailsText + "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
	detailsText = detailsText + "*Full ARN:*\n`" + topicArn + "`\n\n";
	detailsText = detailsText + "_Copy the ARN above to use with `/aws sns publish`_";
	response.put("text",detailsText);
	response.put("card",{"theme":"modern-inline"});
	response.put("buttons",{{"label":"üì® Publish Message","hint":"Send a message to this topic","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"sns_publish_" + topicArn},{"label":"üë• View Subscribers","hint":"See who receives messages","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"sns_subs_" + topicArn},{"label":"üì¢ All Topics","hint":"View all SNS topics","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"sns_list"},{"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
	response.put("navigation",true);
}
else if(buttonKey == "sns_list")
{
	// List all SNS topics
	requestBody = Map();
	requestBody.put("service","sns");
	requestBody.put("userId",userId);
	requestBody.put("region",userRegion);
	requestBody.put("action","listTopics");
	apiResponse = invokeurl
	[
		url :API_URL
		type :POST
		parameters:requestBody.toString()
		headers:{"Content-Type":"application/json"}
		connection:"awscloudcommander"
	];
	if(apiResponse.get("success") == true)
	{
		data = apiResponse.get("data");
		if(data == null || data.size() == 0)
		{
			response.put("text","*No SNS topics found.*\n\nCreate a topic in AWS Console to get started.");
			response.put("card",{"theme":"modern-inline"});
		}
		else
		{
			// Build table rows for each topic
			tableRows = List();
			for each  topic in data
			{
				tArn = ifnull(topic.get("arn"),"");
				tName = ifnull(topic.get("name"),"");
				if(tName == "" && tArn != "")
				{
					tArnParts = tArn.toList(":");
					tName = tArnParts.get(tArnParts.size() - 1);
				}
				arnDisplay = tArn;
				if(tArn.length() > 50)
				{
					arnDisplay = "..." + tArn.subString(tArn.length() - 45,tArn.length());
				}
				tableRows.add({"üì¢ Topic":tName,"ARN":"`" + arnDisplay + "`"});
			}
			// Build buttons for each topic
			topicButtons = List();
			for each  topic in data
			{
				tArn = ifnull(topic.get("arn"),"");
				tName = ifnull(topic.get("name"),"");
				if(tName == "" && tArn != "")
				{
					tArnParts = tArn.toList(":");
					tName = tArnParts.get(tArnParts.size() - 1);
				}
				topicButtons.add({"label":"üì® " + tName,"hint":"Publish message","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"sns_publish_" + tArn});
				topicButtons.add({"label":"üë• Subscribers","hint":"View subscribers","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"sns_subs_" + tArn});
				topicButtons.add({"label":"‚ÑπÔ∏è Details","hint":"View details","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"sns_details_" + tArn});
			}
			topicButtons.add({"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"});
			response.put("text","*üì¢ SNS Topics (" + data.size() + ")*");
			response.put("card",{"theme":"modern-inline"});
			response.put("slides",{{"type":"table","title":"","headers":{"üì¢ Topic","ARN"},"data":tableRows}});
			response.put("buttons",topicButtons);
			response.put("navigation",true);
		}
	}
	else
	{
		response.put("text","*‚ùå Error*\n\n" + ifnull(apiResponse.get("error"),"Failed to fetch topics"));
		response.put("card",{"theme":"prompt"});
	}
}
// ============================================================================
// ONBOARDING HANDLERS
// ============================================================================
else if(buttonKey == "onboard_complete")
{
	// Mark user as onboarded
	prefsQuery = Map();
	prefsQuery.put("criteria","userid==" + userId);
	prefsRecords = zoho.cliq.getRecords("awsprefs",prefsQuery);
	if(prefsRecords != null && prefsRecords.get("status") == "SUCCESS")
	{
		prefsList = prefsRecords.get("list");
		if(prefsList != null && prefsList.size() > 0)
		{
			// Update existing record
			existingPrefs = prefsList.get(0);
			recordId = ifnull(existingPrefs.get("id"),"");
			if(recordId != "")
			{
				updateData = Map();
				updateData.put("onboarded","TRUE");
				zoho.cliq.updateRecord("awsprefs",recordId,updateData);
			}
		}
		else
		{
			// Create new record
			newPrefs = Map();
			newPrefs.put("userid",userId);
			newPrefs.put("username",userName);
			newPrefs.put("region","ap-south-1");
			newPrefs.put("onboarded","TRUE");
			zoho.cliq.createRecord("awsprefs",newPrefs);
		}
	}
	else
	{
		// Create new record
		newPrefs = Map();
		newPrefs.put("userid",userId);
		newPrefs.put("username",userName);
		newPrefs.put("region","ap-south-1");
		newPrefs.put("onboarded","TRUE");
		zoho.cliq.createRecord("awsprefs",newPrefs);
	}
	response.put("text","*Onboarding Complete!*\n\nYou're all set to use AWS Cloud Commander.\n\n*Quick Start:*\n‚Ä¢ `/aws` - Open dashboard\n‚Ä¢ `/aws ec2` - Manage instances\n‚Ä¢ `/aws s3` - Browse buckets\n‚Ä¢ `/aws help` - All commands\n‚Ä¢ Bot Menu ‚Üí Settings - Preferences & consents");
	response.put("card",{"theme":"modern-inline"});
	response.put("buttons",{{"label":"Open Dashboard","hint":"Go to AWS dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
}
else if(buttonKey == "onboard_show")
{
	// Show onboarding info
	onboardText = "*AWS Cloud Commander - Onboarding*\n\n";
	onboardText = onboardText + "*Current Setup:*\n";
	onboardText = onboardText + "‚Ä¢ Connected to shared demo AWS account\n";
	onboardText = onboardText + "‚Ä¢ Some features need consent (Cost, AI, Lambda, SNS)\n";
	onboardText = onboardText + "‚Ä¢ Manage consents in Bot Menu ‚Üí Settings\n\n";
	onboardText = onboardText + "*Want Your Own Setup?*\n";
	onboardText = onboardText + "Deploy your own Catalyst server:\n";
	onboardText = onboardText + "`https://github.com/sumeet-singh-parmar/aws-commander-catalyst`\n\n";
	onboardText = onboardText + "*Requirements:*\n";
	onboardText = onboardText + "‚Ä¢ Zoho Catalyst account\n";
	onboardText = onboardText + "‚Ä¢ AWS credentials (Access Key + Secret)\n";
	onboardText = onboardText + "‚Ä¢ Zoho OAuth 2.0 configured\n\n";
	onboardText = onboardText + "Use Bot Menu ‚Üí Reset Setup to restart the setup process.";
	response.put("text",onboardText);
	response.put("card",{"theme":"modern-inline"});
	response.put("buttons",{{"label":"Complete Onboarding","hint":"Mark as onboarded","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"onboard_complete"},{"label":"Dashboard","hint":"Go to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
}
// ============================================================================
// RDS HANDLERS
// ============================================================================
else if(buttonKey == "rds_list" || (buttonKey.contains("rds_list") && buttonKey.contains("|page|")))
{
	// Parse pagination from button key (format: rds_list|page|X)
	pageNum = 1;
	limitNum = 5;
	if(buttonKey.contains("|page|"))
	{
		pageParts = buttonKey.toList("|page|");
		if(pageParts.size() > 1)
		{
			try
			{
				pageNum = pageParts.get(1).toLong();
			}
			catch(e)
			{
				pageNum = 1;
			}
		}
	}
	// List all RDS databases
	requestBody = Map();
	requestBody.put("service","rds");
	requestBody.put("userId",userId);
	requestBody.put("region",userRegion);
	requestBody.put("action","list");
	requestBody.put("page",pageNum);
	requestBody.put("limit",limitNum);
	apiResponse = invokeurl
	[
		url :API_URL
		type :POST
		parameters:requestBody.toString()
		headers:{"Content-Type":"application/json"}
		connection:"awscloudcommander"
	];
	if(apiResponse.get("success") == true)
	{
		data = apiResponse.get("data");
		// Extract instances array and pagination metadata
		instances = ifnull(data.get("instances"),data);
		pagination = ifnull(data.get("pagination"),Map());
		currentPage = ifnull(pagination.get("currentPage"),1);
		totalPages = ifnull(pagination.get("totalPages"),1);
		totalItems = ifnull(pagination.get("totalItems"),instances.size());
		hasPrev = ifnull(pagination.get("hasPrev"),false);
		hasNext = ifnull(pagination.get("hasNext"),false);
		
		if(instances == null || instances.size() == 0)
		{
			response.put("text","*üóÑÔ∏è No RDS Databases Found*\n\nNo databases in this region.");
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"View Clusters","hint":"View Aurora clusters","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"rds_clusters"},{"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
		}
		else
		{
			rows = List();
			for each  db in instances
			{
				row = Map();
				dbId = ifnull(db.get("id"),ifnull(db.get("name"),""));
				row.put("Name","üóÑÔ∏è " + dbId);
				row.put("Engine",ifnull(db.get("engine"),""));
				row.put("Status",ifnull(db.get("statusEmoji"),"") + " " + ifnull(db.get("status"),""));
				rows.add(row);
			}
			
			pageText = "";
			if(totalPages > 1)
			{
				pageText = " (Page " + currentPage + " of " + totalPages + ")";
			}
			
			// Build buttons with pagination FIRST
			buttons = List();
			baseKey = "rds_list";
			if(totalPages > 1)
			{
				if(hasPrev)
				{
					buttons.add({"label":"‚¨ÖÔ∏è Previous","hint":"Go to previous page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage - 1)});
				}
				if(hasNext)
				{
					buttons.add({"label":"Next ‚û°Ô∏è","hint":"Go to next page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage + 1)});
				}
			}
			// Add other action buttons after pagination
			buttons.add({"label":"üîÑ Refresh","hint":"Reload databases","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"rds_list"});
			buttons.add({"label":"Clusters","hint":"View Aurora clusters","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"rds_clusters"});
			buttons.add({"label":"Summary","hint":"View summary","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"rds_summary"});
			buttons.add({"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"});
			
			response.put("text","*üóÑÔ∏è RDS Databases (" + totalItems + pageText + ")*");
			response.put("card",{"theme":"modern-inline"});
			response.put("slides",{{"type":"table","title":"","data":{"headers":{"Name","Engine","Status"},"rows":rows}}});
			response.put("buttons",buttons);
			response.put("navigation",true);
		}
	}
	else
	{
		response.put("text","*‚ùå RDS Error*\n\n" + ifnull(apiResponse.get("error"),"Failed to fetch databases"));
		response.put("card",{"theme":"prompt"});
	}
}
else if(buttonKey == "rds_clusters" || (buttonKey.contains("rds_clusters") && buttonKey.contains("|page|")))
{
	// Parse pagination from button key (format: rds_clusters|page|X)
	pageNum = 1;
	limitNum = 5;
	if(buttonKey.contains("|page|"))
	{
		pageParts = buttonKey.toList("|page|");
		if(pageParts.size() > 1)
		{
			try
			{
				pageNum = pageParts.get(1).toLong();
			}
			catch(e)
			{
				pageNum = 1;
			}
		}
	}
	// List Aurora clusters
	requestBody = Map();
	requestBody.put("service","rds");
	requestBody.put("userId",userId);
	requestBody.put("region",userRegion);
	requestBody.put("action","clusters");
	requestBody.put("page",pageNum);
	requestBody.put("limit",limitNum);
	apiResponse = invokeurl
	[
		url :API_URL
		type :POST
		parameters:requestBody.toString()
		headers:{"Content-Type":"application/json"}
		connection:"awscloudcommander"
	];
	if(apiResponse.get("success") == true)
	{
		data = apiResponse.get("data");
		// Extract clusters array and pagination metadata
		clusters = ifnull(data.get("clusters"),data);
		pagination = ifnull(data.get("pagination"),Map());
		currentPage = ifnull(pagination.get("currentPage"),1);
		totalPages = ifnull(pagination.get("totalPages"),1);
		totalItems = ifnull(pagination.get("totalItems"),clusters.size());
		hasPrev = ifnull(pagination.get("hasPrev"),false);
		hasNext = ifnull(pagination.get("hasNext"),false);
		
		if(clusters == null || clusters.size() == 0)
		{
			response.put("text","*üóÑÔ∏è No Aurora Clusters Found*\n\nNo Aurora DB clusters in this region.");
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"View Databases","hint":"View RDS instances","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"rds_list"},{"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
			response.put("navigation",true);
		}
		else
		{
			rows = List();
			for each  cluster in clusters
			{
				row = Map();
				clusterName = ifnull(cluster.get("id"),ifnull(cluster.get("name"),""));
				engine = ifnull(cluster.get("engine"),"");
				status = ifnull(cluster.get("status"),"");
				statusEmoji = ifnull(cluster.get("statusEmoji"),"‚ö™");
				row.put("Cluster","üóÑÔ∏è " + clusterName);
				row.put("Engine",engine);
				row.put("Status",statusEmoji + " " + status);
				rows.add(row);
			}
			
			pageText = "";
			if(totalPages > 1)
			{
				pageText = " (Page " + currentPage + " of " + totalPages + ")";
			}
			
			// Build buttons with pagination FIRST
			buttons = List();
			baseKey = "rds_clusters";
			if(totalPages > 1)
			{
				if(hasPrev)
				{
					buttons.add({"label":"‚¨ÖÔ∏è Previous","hint":"Go to previous page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage - 1)});
				}
				if(hasNext)
				{
					buttons.add({"label":"Next ‚û°Ô∏è","hint":"Go to next page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage + 1)});
				}
			}
			// Add other action buttons after pagination
			buttons.add({"label":"üîÑ Refresh","hint":"Reload clusters","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"rds_clusters"});
			buttons.add({"label":"Databases","hint":"View RDS instances","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"rds_list"});
			buttons.add({"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"});
			
			response.put("text","*üóÑÔ∏è Aurora Clusters (" + totalItems + pageText + ")*");
			response.put("card",{"theme":"modern-inline"});
			response.put("slides",{{"type":"table","title":"","data":{"headers":{"Cluster","Engine","Status"},"rows":rows}}});
			response.put("buttons",buttons);
			response.put("navigation",true);
		}
	}
	else
	{
		response.put("text","*‚ùå RDS Error*\n\n" + ifnull(apiResponse.get("error"),"Failed to fetch clusters"));
		response.put("card",{"theme":"prompt"});
	}
}
else if(buttonKey == "rds_summary")
{
	// RDS Summary
	requestBody = Map();
	requestBody.put("service","rds");
	requestBody.put("userId",userId);
	requestBody.put("region",userRegion);
	requestBody.put("action","summary");
	apiResponse = invokeurl
	[
		url :API_URL
		type :POST
		parameters:requestBody.toString()
		headers:{"Content-Type":"application/json"}
		connection:"awscloudcommander"
	];
	if(apiResponse.get("success") == true)
	{
		data = apiResponse.get("data");
		totalInstances = ifnull(data.get("total"),0);
		byEngine = ifnull(data.get("byEngine"),Map());
		byStatus = ifnull(data.get("byStatus"),Map());
		summaryText = "*üóÑÔ∏è RDS Summary*\n\n";
		summaryText = summaryText + "üìä *Total Instances:* " + totalInstances + "\n\n";
		if(byStatus.size() > 0)
		{
			summaryText = summaryText + "*By Status:*\n";
			for each  statusKey in byStatus.keys()
			{
				statusCount = byStatus.get(statusKey);
				statusEmoji = "‚ö™";
				if(statusKey == "available")
				{
					statusEmoji = "üü¢";
				}
				else if(statusKey == "stopped")
				{
					statusEmoji = "üî¥";
				}
				summaryText = summaryText + "‚Ä¢ " + statusEmoji + " " + statusKey + ": " + statusCount + "\n";
			}
			summaryText = summaryText + "\n";
		}
		if(byEngine.size() > 0)
		{
			summaryText = summaryText + "*By Engine:*\n";
			for each  engineKey in byEngine.keys()
			{
				engineCount = byEngine.get(engineKey);
				summaryText = summaryText + "‚Ä¢ " + engineKey + ": " + engineCount + "\n";
			}
		}
		response.put("text",summaryText);
		response.put("card",{"theme":"modern-inline"});
		response.put("buttons",{{"label":"View All","hint":"List all databases","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"rds_list"},{"label":"Clusters","hint":"View Aurora clusters","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"rds_clusters"},{"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
		response.put("navigation",true);
	}
	else
	{
		response.put("text","*‚ùå RDS Error*\n\n" + ifnull(apiResponse.get("error"),"Failed to fetch summary"));
		response.put("card",{"theme":"prompt"});
	}
}
else if(buttonKey == "rds_snapshots" || (buttonKey.contains("rds_snapshots") && buttonKey.contains("|page|")))
{
	// Parse pagination from button key (format: rds_snapshots|page|X)
	pageNum = 1;
	limitNum = 5;
	if(buttonKey.contains("|page|"))
	{
		pageParts = buttonKey.toList("|page|");
		if(pageParts.size() > 1)
		{
			try
			{
				pageNum = pageParts.get(1).toLong();
			}
			catch(e)
			{
				pageNum = 1;
			}
		}
	}
	// List RDS snapshots
	requestBody = Map();
	requestBody.put("service","rds");
	requestBody.put("userId",userId);
	requestBody.put("region",userRegion);
	requestBody.put("action","snapshots");
	requestBody.put("page",pageNum);
	requestBody.put("limit",limitNum);
	apiResponse = invokeurl
	[
		url :API_URL
		type :POST
		parameters:requestBody.toString()
		headers:{"Content-Type":"application/json"}
		connection:"awscloudcommander"
	];
	if(apiResponse.get("success") == true)
	{
		data = apiResponse.get("data");
		// Extract snapshots array and pagination metadata
		snapshots = ifnull(data.get("snapshots"),data);
		pagination = ifnull(data.get("pagination"),Map());
		currentPage = ifnull(pagination.get("currentPage"),1);
		totalPages = ifnull(pagination.get("totalPages"),1);
		totalItems = ifnull(pagination.get("totalItems"),snapshots.size());
		hasPrev = ifnull(pagination.get("hasPrev"),false);
		hasNext = ifnull(pagination.get("hasNext"),false);
		
		if(snapshots == null || snapshots.size() == 0)
		{
			response.put("text","*üì∏ No Snapshots Found*\n\nNo RDS snapshots in this region.");
			response.put("card",{"theme":"modern-inline"});
			response.put("buttons",{{"label":"View Databases","hint":"View RDS instances","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"rds_list"},{"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"}});
			response.put("navigation",true);
		}
		else
		{
			rows = List();
			for each  snap in snapshots
			{
				row = Map();
				snapName = ifnull(snap.get("id"),ifnull(snap.get("name"),""));
				dbId = ifnull(snap.get("dbInstanceId"),"");
				status = ifnull(snap.get("status"),"");
				statusEmoji = "‚ö™";
				if(status == "available")
				{
					statusEmoji = "üü¢";
				}
				row.put("Snapshot","üì∏ " + snapName);
				row.put("Database",dbId);
				row.put("Status",statusEmoji + " " + status);
				rows.add(row);
			}
			
			pageText = "";
			if(totalPages > 1)
			{
				pageText = " (Page " + currentPage + " of " + totalPages + ")";
			}
			
			// Build buttons with pagination FIRST
			buttons = List();
			baseKey = "rds_snapshots";
			if(totalPages > 1)
			{
				if(hasPrev)
				{
					buttons.add({"label":"‚¨ÖÔ∏è Previous","hint":"Go to previous page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage - 1)});
				}
				if(hasNext)
				{
					buttons.add({"label":"Next ‚û°Ô∏è","hint":"Go to next page","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":baseKey + "|page|" + (currentPage + 1)});
				}
			}
			// Add other action buttons after pagination
			buttons.add({"label":"üîÑ Refresh","hint":"Reload snapshots","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"rds_snapshots"});
			buttons.add({"label":"Databases","hint":"View RDS instances","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"rds_list"});
			buttons.add({"label":"üè† Dashboard","hint":"Return to dashboard","type":"+","action":{"type":"invoke.function","data":{"name":"handleButton"}},"key":"dashboard"});
			
			response.put("text","*üì∏ RDS Snapshots (" + totalItems + pageText + ")*");
			response.put("card",{"theme":"modern-inline"});
			response.put("slides",{{"type":"table","title":"","data":{"headers":{"Snapshot","Database","Status"},"rows":rows}}});
			response.put("buttons",buttons);
			response.put("navigation",true);
		}
	}
	else
	{
		response.put("text","*‚ùå RDS Error*\n\n" + ifnull(apiResponse.get("error"),"Failed to fetch snapshots"));
		response.put("card",{"theme":"prompt"});
	}
}
// ============================================================================
// SECTION: Credentials Form Display
// ============================================================================
// Shows the AWS credentials form when user clicks "Enter Credentials" button
// This is triggered from the credentials info card in the setup flow
// Form collects: Access Key ID, Secret Access Key, optional Session Token
// Credentials are encrypted and stored securely in backend (user_credentials table)
// ============================================================================
else if(buttonKey == "credentials_show_form")
{
	// User clicked "Continue" from credentials info card - show the form directly
	// Use the exact same format as credentialsForm.ds returns
	return {
		"type": "form",
		"title": "AWS Credentials Setup",
		"name": "credentialsForm",
		"hint": "Enter your AWS IAM access keys. They will be encrypted and stored securely.\n\nüí° *Tip:* Make sure you've followed the setup guide to generate your credentials properly.",
		"button_label": "Store & Verify",
		"inputs": [
			{
				"label": "AWS Access Key ID",
				"name": "access_key_id",
				"placeholder": "AKIAIOSFODNN7EXAMPLE",
				"min_length": "0",
				"max_length": "100",
				"mandatory": true,
				"type": "text"
			},
			{
				"label": "AWS Secret Access Key",
				"name": "secret_access_key",
				"placeholder": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
				"min_length": "0",
				"max_length": "100",
				"mandatory": true,
				"type": "text",
				"format": "password"
			},
			{
				"label": "Session Token (Optional)",
				"name": "session_token",
				"placeholder": "For temporary credentials only",
				"min_length": "0",
				"max_length": "500",
				"mandatory": false,
				"type": "text"
			}
		],
		"action": {
			"type": "invoke.function",
			"name": "credentialsForm"
		}
	};
}
// ============================================================================
// DEFAULT / UNKNOWN
// ============================================================================
else
{
	response.put("text","*Unknown action:* " + buttonKey);
}
// Add navigation to go back (but NOT for forms - forms cannot have navigation)
if(response.get("type") != "form")
{
	response.put("navigation",true);
}
return response;
