// ============================================================================
// AWS Cloud Commander - Initial Onboarding Tour Handler
// ============================================================================
// Purpose: Guides new users through AWS Cloud Commander features during initial setup
//
// This tour is triggered when user first interacts with the bot or clicks "Start Setup"
// Shows 5 interactive cards explaining key features:
//   1. EC2 Instances ‚Üí Virtual server management
//   2. S3 Storage ‚Üí Object storage and file management
//   3. Lambda Functions ‚Üí Serverless function execution
//   4. Cost Monitoring ‚Üí AWS spending tracking
//   5. CloudWatch ‚Üí Monitoring and alerting
//
// Each card includes action buttons to explore features
// Final card prompts user to complete setup via setupForm
// ============================================================================

// Get tour step from button key
tourStep = ifnull(arguments.get("key"), "");

// Get user info safely
userName = "there";
userId = "";
if(user != null)
{
    userName = ifnull(user.get("first_name"), ifnull(user.get("name"), "there"));
    userId = ifnull(user.get("id"), "");
}

response = Map();

// EC2
if(tourStep == "tour_ec2")
{
    response = {
        "text": "Control your virtual servers directly from Cliq. Start, stop, or reboot instances without leaving your chat window.",
        "card": {
            "title": "EC2 Instances",
            "thumbnail": "https://a.b.cdn.console.awsstatic.com/a/v1/RHSMMGZKYJXPPNI2IOC6Z63HJEW4FD5ZYMKJSXD7HQ5IPUTQR2TQ/icon/d88319dfa5d204f019b4284149886c59-7d586ea82f792b61a8c87de60565133d.svg",
            "theme": "modern-inline"
        },
        "slides": [
            {
                "type": "text",
                "title": "What you can do",
                "data": "‚Ä¢ Start, stop & reboot instances\n‚Ä¢ View real-time status & health\n‚Ä¢ Monitor CPU & memory usage\n\n*Command:* `/aws ec2`"
            }
        ],
        "buttons": [
            {
                "label": "Next ‚Üí",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_s3"
            }
        ],
        "navigation": true
    };
}
// S3
else if(tourStep == "tour_s3")
{
    response = {
        "text": "Access your cloud storage buckets and objects. Browse files, upload content, and generate shareable links instantly.",
        "card": {
            "title": "S3 Storage",
            "thumbnail": "https://a.b.cdn.console.awsstatic.com/a/v1/DKY2SIL5N3MJQCULDNOQE7TKLNQIUXRSOHBJKJGQAHLZO7TLH3TQ/icon/c0828e0381730befd1f7a025057c74fb-43acc0496e64afba82dbc9ab774dc622.svg",
            "theme": "modern-inline"
        },
        "slides": [
            {
                "type": "text",
                "title": "What you can do",
                "data": "‚Ä¢ Browse buckets & objects\n‚Ä¢ Upload files directly\n‚Ä¢ Generate presigned URLs\n\n*Command:* `/aws s3`"
            }
        ],
        "buttons": [
            {
                "label": "‚Üê Back",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_ec2"
            },
            {
                "label": "Next ‚Üí",
                "action": {
                    "type": "invoke.function",
                "data": {"name": "botTour"}
                },
                "key": "tour_rds"
            }
        ],
        "navigation": true
    };
}
// RDS
else if(tourStep == "tour_rds")
{
    response = {
        "text": "Manage your relational databases. Monitor instances, check connections, and keep your data layer running smoothly.",
        "card": {
            "title": "RDS Databases",
            "thumbnail": "https://a.b.cdn.console.awsstatic.com/a/v1/6JW3RZSXOZ4EFR2HZBU6IIOCUZEIFKRK6JZDCUDHQVQXRMAORYWQ/icon/1d374ed2a6bcf601d7bfd4fc3dfd3b5d-c9f69416d978016b3191175f35e59226.svg",
            "theme": "modern-inline"
        },
        "slides": [
            {
                "type": "text",
                "title": "What you can do",
                "data": "‚Ä¢ List database instances\n‚Ä¢ Monitor status & health\n‚Ä¢ View connection details\n\n*Command:* `/aws rds`"
            }
        ],
        "buttons": [
            {
                "label": "‚Üê Back",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_s3"
            },
            {
                "label": "Next ‚Üí",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_lambda"
            }
        ],
        "navigation": true
    };
}
// Lambda
else if(tourStep == "tour_lambda")
{
    response = {
        "text": "Execute serverless functions on-demand. Trigger workflows, run scripts, and check execution logs right from chat.",
        "card": {
            "title": "Lambda Functions",
            "thumbnail": "https://a.b.cdn.console.awsstatic.com/a/v1/BMZQS7MWY7VIUF7PXETK3ULHIXZQQOURXD3AK46KD7UE6WMRLUSA/icon/945f3fc449518a73b9f5f32868db466c-926961f91b072604c42b7f39ce2eaf1c.svg",
            "theme": "modern-inline"
        },
        "slides": [
            {
                "type": "text",
                "title": "What you can do",
                "data": "‚Ä¢ List all your functions\n‚Ä¢ Invoke functions on-demand\n‚Ä¢ View execution logs\n\n*Command:* `/aws lambda`"
            }
        ],
        "buttons": [
            {
                "label": "‚Üê Back",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_rds"
            },
            {
                "label": "Next ‚Üí",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_cloudwatch"
            }
        ],
        "navigation": true
    };
}
// CloudWatch
else if(tourStep == "tour_cloudwatch")
{
    response = {
        "text": "Stay on top of your infrastructure health. Set up alarms, monitor metrics, and get notified when things need attention.",
        "card": {
            "title": "CloudWatch",
            "thumbnail": "https://a.b.cdn.console.awsstatic.com/a/v1/CX6QBE6PRZYY4R3LVRUGVYCKEYSXHAEJLUVNJVMT5MOLELYXPPGQ/icon/8f57ebd825a828e205b2dde223ba17e4-6af63a22dc297f8041286760ee8cd2c9.svg",
            "theme": "modern-inline"
        },
        "slides": [
            {
                "type": "text",
                "title": "What you can do",
                "data": "‚Ä¢ Create & manage alarms\n‚Ä¢ View real-time metrics\n‚Ä¢ Search & analyze logs\n\n*Commands:* `/aws alarms`, `/aws logs`"
            }
        ],
        "buttons": [
            {
                "label": "‚Üê Back",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_lambda"
            },
            {
                "label": "Next ‚Üí",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_sns"
            }
        ],
        "navigation": true
    };
}
// SNS
else if(tourStep == "tour_sns")
{
    response = {
        "text": "Send notifications and alerts to your team. Publish messages to topics and manage subscriptions easily.",
        "card": {
            "title": "SNS Notifications",
            "thumbnail": "https://a.b.cdn.console.awsstatic.com/a/v1/MW4GDEWKEYFO66RNNDQN5WY7CUZ7HOR4RUQV6KKJYMDG7PPKOSIQ/icon/6002c6713f40e8a35d365605542e72b0-03c2386fb392e0d689e45d9b4f683a8d.svg",
            "theme": "modern-inline"
        },
        "slides": [
            {
                "type": "text",
                "title": "What you can do",
                "data": "‚Ä¢ List topics & subscriptions\n‚Ä¢ Publish messages to topics\n‚Ä¢ Set up alert notifications\n\n*Command:* `/aws sns`"
            }
        ],
        "buttons": [
            {
                "label": "‚Üê Back",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_cloudwatch"
            },
            {
                "label": "Next ‚Üí",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_cost"
            }
        ],
        "navigation": true
    };
}
// Cost
else if(tourStep == "tour_cost")
{
    response = {
        "text": "Keep track of your AWS spending. View cost breakdowns, monitor trends, and stay within budget.",
        "card": {
            "title": "Cost Explorer",
            "thumbnail": "https://a.b.cdn.console.awsstatic.com/a/v1/DS7ORV4P6ZTCYOMPJ24IJPBQXPG5SJW7F65YM7RNWZECHLGOOL3Q/icon/2342d9ccd7d52448de0ef187d97c575c-de388fcdf7988c4792628bc8089f788f.svg",
            "theme": "modern-inline"
        },
        "slides": [
            {
                "type": "text",
                "title": "What you can do",
                "data": "‚Ä¢ View current month costs\n‚Ä¢ Track spending by service\n‚Ä¢ Monitor cost trends\n\n*Command:* `/aws cost`"
            }
        ],
        "buttons": [
            {
                "label": "‚Üê Back",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_sns"
            },
            {
                "label": "Next ‚Üí",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_iam"
            }
        ],
        "navigation": true
    };
}
// IAM
else if(tourStep == "tour_iam")
{
    response = {
        "text": "Review access permissions and security. Check who has access to what across your AWS resources.",
        "card": {
            "title": "IAM Security",
            "thumbnail": "https://a.b.cdn.console.awsstatic.com/a/v1/STFYE4KUQFFP2JZ2KOHPEHBH4BDHCX3ZIEKWLMGPOXOLYRC4QUDQ/icon/0ebc580ae6450fce8762fad1bff32e7b-0841c1f0e7c5788b88d07a7dbcaceb6e.svg",
            "theme": "modern-inline"
        },
        "slides": [
            {
                "type": "text",
                "title": "What you can do",
                "data": "‚Ä¢ List users & roles\n‚Ä¢ Check permissions\n‚Ä¢ Review access policies\n\n*Command:* `/aws iam`"
            }
        ],
        "buttons": [
            {
                "label": "‚Üê Back",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_cost"
            },
            {
                "label": "Next ‚Üí",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_ai"
            }
        ],
        "navigation": true
    };
}
// AI
else if(tourStep == "tour_ai")
{
    response = {
        "text": "Get instant AWS help powered by Claude AI. Ask questions, troubleshoot issues, and get recommendations.",
        "card": {
            "title": "AI Assistant",
            "thumbnail": "https://a.b.cdn.console.awsstatic.com/a/v1/LETP4TFABRTBD2D765TVLSVMVZXIHYQNI6NEA36TKA5SNDL7RC5A/icon/bee4d136bd8eb45ab32def8604e37cd2-2a0639d9c34980d353a3da561deb6460.svg",
            "theme": "modern-inline"
        },
        "slides": [
            {
                "type": "text",
                "title": "What you can do",
                "data": "‚Ä¢ Ask AWS questions\n‚Ä¢ Troubleshoot issues\n‚Ä¢ Get best practice tips\n\n*Command:* `/aws ai <question>`"
            }
        ],
        "buttons": [
            {
                "label": "‚Üê Back",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_iam"
            },
            {
                "label": "Complete Setup ‚Üí",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "setup_info_start"
            }
        ],
        "navigation": true
    };
}
// Setup Info Cards - Introduction
else if(tourStep == "setup_info_start")
{
    response = {
        "text": "Alright " + userName + "! üéâ\n Let's get your AWS extension set up!\n ‚Üí But first, let's explore your options. We've got *3 different* ways to connect - each with its own superpowers.\n\nSwipe through to find your perfect match!",
        "card": {
            "title": "Choose Your Setup",
            "thumbnail": "https://www.monks.com/data/styles/738x363_crop/s3/2024-12/AWS.png?VersionId=AgciRGgmrM5MOD.WFIdw68QeG8kI.JR.&h=c74750f6&itok=q-7iCrYZ",
            "theme": "modern-inline"
        },
        "buttons": [
            {
                "label": "Let's Go! ‚Üí",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "setup_info_demo"
            }
        ],
        "navigation": true
    };
}
// Setup Info - Quick Demo
else if(tourStep == "setup_info_demo")
{
    response = {
        "text": "üöÄ *Option 1: Quick Demo*\n\nThe express lane! Jump in immediately with zero setup. Perfect for kicking the tires.",
        "card": {
            "title": "Quick Demo",
            "thumbnail": "https://cdn-icons-png.freepik.com/256/4845/4845825.png?semt=ais_white_label",
            "theme": "modern-inline"
        },
        "slides": [
            {
                "type": "text",
                "title": "What You Get",
                "data": "‚ú® Instant access - no waiting!\n‚ú® Pre-loaded with sample AWS resources\n‚ú® All features unlocked immediately\n‚ú® Zero configuration required\n‚ú® No AWS account needed"
            },
            {
                "type": "text",
                "title": "Good to Know",
                "data": "üìå Shared demo environment\nüìå Sample data only (not your real AWS)\nüìå Some write operations limited\nüìå Great for learning, not for production"
            },
            {
                "type": "text",
                "title": "Perfect For",
                "data": "‚úÖ First-time users\n‚úÖ Testing before committing\n‚úÖ Learning AWS commands\n‚úÖ Quick demonstrations\n‚úÖ Exploring all features risk-free"
            }
        ],
        "buttons": [
            {
                "label": "Next ‚Üí",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "setup_info_credentials"
            }
        ],
        "navigation": true
    };
}
// Setup Info - Own Credentials
else if(tourStep == "setup_info_credentials")
{
    response = {
        "text": "üîë *Option 2: Own AWS Credentials*\n\nBring your own keys! Connect to YOUR real AWS account and manage your actual infrastructure.",
        "card": {
            "title": "Own Credentials",
            "thumbnail": "https://png.pngtree.com/png-vector/20231211/ourmid/pngtree-medical-certificate-icon-credential-graduation-png-image_10874260.png",
            "theme": "modern-inline"
        },
        "slides": [
            {
                "type": "text",
                "title": "What You'll Need",
                "data": "üìã Your own AWS account\nüìã IAM User with programmatic access\nüìã AWS Access Key ID\nüìã AWS Secret Access Key\nüìã Proper IAM permissions setup"
            },
            {
                "type": "text",
                "title": "Why Choose This?",
                "data": "üí™ Full control over YOUR AWS resources\nüí™ Manage real production workloads\nüí™ Access all your EC2, S3, RDS, etc.\nüí™ Private data - only you can see it\nüí™ Team-ready for collaboration"
            },
            {
                "type": "text",
                "title": "Perfect For",
                "data": "‚úÖ Managing your own AWS infrastructure\n‚úÖ Production environments\n‚úÖ Accessing your real resources\n‚úÖ DevOps & SRE teams\n‚úÖ Serious AWS management"
            }
        ],
        "buttons": [
            {
                "label": "Next ‚Üí",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "setup_info_backend"
            }
        ],
        "navigation": true
    };
}
// Setup Info - Own Backend
else if(tourStep == "setup_info_backend")
{
    response = {
        "text": "‚öôÔ∏è *Option 3: Own Backend (Self-Hosted)*\n\nMaximum control! Deploy your own Catalyst backend and keep EVERYTHING in your hands.",
        "card": {
            "title": "Own Backend",
            "thumbnail": "https://lh3.googleusercontent.com/pw/AP1GczMIHCvJSdtoeCJiBcJqqnH3JsF1QsELuGmEFQ69IfYqk3TxDVNDhIGiR4OGKuEERTzaKa1y5ivpEYxO3S6-GC6usmqSKS9_O8gi_W5rn6mjTN-U248DAjXhb5d3HdkQP0jKXZkOMTbsvCi0xiwCdNxG=w256-h256-s-no-gm?authuser=0",
            "theme": "modern-inline"
        },
        "slides": [
            {
                "type": "text",
                "title": "Ultimate Control",
                "data": "üîê YOUR credentials, YOUR control\nüîê Complete data sovereignty\nüîê Zero shared infrastructure\nüîê No third-party access to your AWS\nüîê Enterprise-grade security\nüîê Modify source code as needed"
            },
            {
                "type": "text",
                "title": "What You'll Need",
                "data": "üõ†Ô∏è Your own AWS credentials\nüõ†Ô∏è Zoho Catalyst account (free tier OK)\nüõ†Ô∏è GitHub repo access\nüõ†Ô∏è Basic Node.js knowledge\nüõ†Ô∏è ~30 mins for initial setup"
            },
            {
                "type": "text",
                "title": "Perfect For",
                "data": "‚úÖ Enterprises with strict compliance\n‚úÖ Teams needing full data isolation\n‚úÖ Custom feature development\n‚úÖ Advanced security requirements\n‚úÖ Developers who want full control\n‚úÖ Organizations with data governance policies"
            }
        ],
        "buttons": [
            {
                "label": "Choose Setup ‚Üí",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "setupForm"}
                },
                "key": "open_setup_form"
            }
        ],
        "navigation": true
    };
}
// Setup: Quick Demo (Option C - from button)
else if(tourStep == "setup_quick_demo")
{
    // 1. Mark user as onboarded in awsprefs
    prefsQuery = Map();
    prefsQuery.put("criteria", "userid==" + userId);
    prefsRecords = zoho.cliq.getRecords("awsprefs", prefsQuery);
    
    if(prefsRecords != null && prefsRecords.get("status") == "SUCCESS")
    {
        prefsList = prefsRecords.get("list");
        if(prefsList != null && prefsList.size() > 0)
        {
            // Update existing record
            existingPrefs = prefsList.get(0);
            recordId = existingPrefs.get("id");
            
            updateData = Map();
            updateData.put("onboarded", "TRUE");
            
            zoho.cliq.updateRecord("awsprefs", recordId, updateData);
        }
        else
        {
            // Create new record
            newPrefs = Map();
            newPrefs.put("userid", userId);
            newPrefs.put("onboarded", "TRUE");
            newPrefs.put("region", "ap-south-1");
            
            zoho.cliq.createRecord("awsprefs", newPrefs);
        }
    }
    
    // 2. Create/update setup config in awssetup
    setupQuery = Map();
    setupQuery.put("criteria", "userid==" + userId);
    setupRecords = zoho.cliq.getRecords("awssetup", setupQuery);
    
    setupData = Map();
    setupData.put("userid", userId);
    setupData.put("setuptype", "shared_demo");
    setupData.put("backendurl", "");
    setupData.put("credentialsstored", false);
    
    if(setupRecords != null && setupRecords.get("status") == "SUCCESS" && setupRecords.get("list").size() > 0)
    {
        // Update existing record
        setupId = setupRecords.get("list").get(0).get("id");
        zoho.cliq.updateRecord("awssetup", setupId, setupData);
    }
    else
    {
        // Create new record
        zoho.cliq.createRecord("awssetup", setupData);
    }
    
    response = {
        "text": "üéâ *Setup Complete!*\n\nYou're connected to the shared demo AWS account.\n\n‚ö†Ô∏è *Next Steps:*\nOpen Bot Menu ‚Üí Settings to configure:\n‚Ä¢ Alert channel for notifications\n‚Ä¢ Default AWS region\n‚Ä¢ Feature consents (Cost, AI, Lambda, SNS)\n\n*Quick Commands:*\n‚Ä¢ `/aws` - Dashboard\n‚Ä¢ `/aws help` - All commands\n\n_Welcome to AWS Cloud Commander!_ üöÄ",
        "card": {
            "title": "Ready to Go!",
            "thumbnail": "https://www.monks.com/data/styles/738x363_crop/s3/2024-12/AWS.png?VersionId=AgciRGgmrM5MOD.WFIdw68QeG8kI.JR.&h=c74750f6&itok=q-7iCrYZ",
            "theme": "modern-inline"
        },
        "navigation": true
    };
}
// Setup: Own Credentials (Option C - from button)
else if(tourStep == "setup_own_creds")
{
    response = {
        "text": "üîë *Own AWS Credentials Setup*\n\n_This feature is coming soon!_\n\nFor now, please use the *Quick Demo* option to get started.",
        "card": {
            "title": "Coming Soon",
            "theme": "prompt"
        },
        "buttons": [
            {
                "label": "‚Üê Back",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "show_setup_cards"
            },
            {
                "label": "üöÄ Quick Demo",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "setup_quick_demo"
            }
        ],
        "navigation": true
    };
}
// Setup: Own Backend (Option C - from button)
else if(tourStep == "setup_own_backend")
{
    response = {
        "text": "‚öôÔ∏è *Own Backend Setup*\n\n_This feature is coming soon!_\n\nFor now, please use the *Quick Demo* option to get started.",
        "card": {
            "title": "Coming Soon",
            "theme": "prompt"
        },
        "buttons": [
            {
                "label": "‚Üê Back",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "show_setup_cards"
            },
            {
                "label": "üöÄ Quick Demo",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "setup_quick_demo"
            }
        ],
        "navigation": true
    };
}
// Setup Cards - Option C (cards with buttons instead of form)
else if(tourStep == "show_setup_cards")
{
    response = {
        "text": "üéØ *Choose Your Setup Type*\n\nSelect how you want to connect to AWS:",
        "card": {
            "title": "Setup Configuration",
            "theme": "modern-inline"
        },
        "slides": [
            {
                "type": "text",
                "title": "üöÄ Quick Demo",
                "data": "*Shared AWS Account*\n\n‚úÖ No setup required\n‚úÖ Start using immediately\n‚úÖ Perfect for testing\n\nUses a shared demo AWS account with limited access."
            },
            {
                "type": "text",
                "title": "üîë Own Credentials",
                "data": "*Use Your AWS Keys*\n\n‚Ä¢ Provide AWS Access Key ID\n‚Ä¢ Provide Secret Access Key\n‚Ä¢ Full control of your account\n\nRequires AWS credentials setup."
            },
            {
                "type": "text",
                "title": "‚öôÔ∏è Own Backend",
                "data": "*Self-Hosted Solution*\n\n‚Ä¢ Deploy your own Catalyst backend\n‚Ä¢ Complete data isolation\n‚Ä¢ Advanced customization\n\nRequires technical setup."
            }
        ],
        "buttons": [
            {
                "label": "üöÄ Quick Demo",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "setup_quick_demo"
            },
            {
                "label": "üîë Own Credentials",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "setup_own_creds"
            },
            {
                "label": "‚öôÔ∏è Own Backend",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "setup_own_backend"
            }
        ],
        "navigation": true
    };
}
// Done (legacy - kept for backward compatibility)
else if(tourStep == "tour_done")
{
    // Mark user as onboarded
    userId = user.get("id");
    
    // Check if user has preferences record
    prefsQuery = Map();
    prefsQuery.put("criteria", "userid==" + userId);
    prefsRecords = zoho.cliq.getRecords("awsprefs", prefsQuery);
    
    if(prefsRecords != null && prefsRecords.get("status") == "SUCCESS")
    {
        prefsList = prefsRecords.get("list");
        if(prefsList != null && prefsList.size() > 0)
        {
            // Update existing record
            existingPrefs = prefsList.get(0);
            recordId = existingPrefs.get("id");
            
            updateData = Map();
            updateData.put("onboarded", "TRUE");
            
            zoho.cliq.updateRecord("awsprefs", recordId, updateData);
        }
        else
        {
            // Create new record
            newPrefs = Map();
            newPrefs.put("userid", userId);
            newPrefs.put("onboarded", "TRUE");
            newPrefs.put("region", "ap-south-1");
            
            zoho.cliq.createRecord("awsprefs", newPrefs);
        }
    }
    
    // Build full onboarding info
    onboardText = "üéâ *Onboarding Complete!*\n\n";
    onboardText = onboardText + "*‚ö†Ô∏è IMPORTANT - Configure Settings First!*\n";
    onboardText = onboardText + "Open Bot Menu ‚Üí Settings to:\n\n";
    onboardText = onboardText + "1Ô∏è‚É£ *Select Alert Channel* - Where CloudWatch alerts will be sent\n";
    onboardText = onboardText + "2Ô∏è‚É£ *Set Your Region* - Default AWS region (e.g., us-east-1)\n";
    onboardText = onboardText + "3Ô∏è‚É£ *Enable Consents* - Turn ON features you want:\n";
    onboardText = onboardText + "   ‚Ä¢ Cost Explorer - View spending & forecasts\n";
    onboardText = onboardText + "   ‚Ä¢ AI Assistant - Ask AWS questions\n";
    onboardText = onboardText + "   ‚Ä¢ Lambda Invoke - Execute functions\n";
    onboardText = onboardText + "   ‚Ä¢ SNS Publish - Send messages\n\n";
    onboardText = onboardText + "*Quick Commands:*\n";
    onboardText = onboardText + "‚Ä¢ `/aws` - Dashboard\n";
    onboardText = onboardText + "‚Ä¢ `/aws ec2` - Manage instances\n";
    onboardText = onboardText + "‚Ä¢ `/aws s3` - Browse buckets\n";
    onboardText = onboardText + "‚Ä¢ `/aws help` - All commands\n\n";
    onboardText = onboardText + "*Want Your Own Setup?*\n";
    onboardText = onboardText + "Clone & deploy: `https://github.com/sumeet-singh-parmar/aws-commander-catalyst`\n\n";
    onboardText = onboardText + "_Built for Zoho Cliqtrix Competition 2025_";
    
    response = {
        "text": onboardText,
        "card": {
            "title": "Setup Complete!",
            "thumbnail": "https://www.monks.com/data/styles/738x363_crop/s3/2024-12/AWS.png?VersionId=AgciRGgmrM5MOD.WFIdw68QeG8kI.JR.&h=c74750f6&itok=q-7iCrYZ",
            "theme": "modern-inline"
        },
        "buttons": [
            {
                "label": "üìä Dashboard",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "handleButton"}
                },
                "key": "dashboard"
            }
        ],
        "navigation": true
    };
}
else
{
    // Default/Debug - show what was received
    response = {
        "text": "Debug: Received tourStep = `" + tourStep + "`\n\nLet's start from EC2 tour.",
        "card": {
            "title": "Feature Tour",
            "theme": "modern-inline"
        },
        "buttons": [
            {
                "label": "Start ‚Üí",
                "action": {
                    "type": "invoke.function",
                    "data": {"name": "botTour"}
                },
                "key": "tour_ec2"
            }
        ]
    };
}

return response;

